import * as path from 'path';
import { format as formatUrl } from 'url';
import { BrowserWindow, Menu } from 'electron';
/* Window-related helpers
   TODO (#4): Move into the framework */
const isDevelopment = process.env.NODE_ENV !== 'production';
const isMacOS = process.platform === 'darwin';
// Keeps track of windows and ensures (?) they do not get garbage collected
export var windows = [];
// Allows to locate window ID by label
var windowsByTitle = {};
export const openWindow = async ({ title, url, component, componentParams, dimensions, frameless, winParams, menuTemplate, ignoreCache }) => {
    if ((component || '').trim() === '' && (url || '').trim() === '') {
        throw new Error("openWindow() requires either `component` or `url`");
    }
    const _existingWindow = getWindowByTitle(title);
    if (_existingWindow !== undefined) {
        _existingWindow.focus();
        return _existingWindow;
    }
    const _framelessOpts = {
        frame: isMacOS ? true : false,
        titleBarStyle: isMacOS ? 'hiddenInset' : undefined,
    };
    const _winParams = Object.assign(Object.assign({ width: (dimensions || {}).width, minWidth: (dimensions || {}).minWidth, height: (dimensions || {}).height, minHeight: (dimensions || {}).minHeight }, (frameless === true ? _framelessOpts : {})), winParams);
    let window;
    if (component) {
        const params = `c=${component}&${componentParams ? componentParams : ''}`;
        window = await createWindowForLocalComponent(title, params, _winParams);
    }
    else if (url) {
        window = await createWindow(title, url, _winParams, ignoreCache);
    }
    else {
        throw new Error("Either component or url must be given to openWindow()");
    }
    if (menuTemplate && !isMacOS) {
        window.setMenu(Menu.buildFromTemplate(menuTemplate));
    }
    windows.push(window);
    windowsByTitle[title] = window;
    window.on('closed', () => { delete windowsByTitle[title]; cleanUpWindows(); });
    return window;
};
export function getWindowByTitle(title) {
    return windowsByTitle[title];
}
export function getWindow(func) {
    return windows.find(func);
}
// Iterate over array of windows and try accessing window ID.
// If it throws, window was closed and we remove it from the array.
// Supposed to be run after any window is closed
function cleanUpWindows() {
    var deletedWindows = [];
    for (const [idx, win] of windows.entries()) {
        // When accessing the id attribute of a closed window,
        // it’ll throw. We’ll mark its index for deletion then.
        try {
            win.id;
        }
        catch (e) {
            deletedWindows.push(idx - deletedWindows.length);
        }
    }
    for (const idx of deletedWindows) {
        windows.splice(idx, 1);
    }
}
function createWindowForLocalComponent(title, params, winParams) {
    let url;
    if (isDevelopment) {
        url = `http://localhost:${process.env.ELECTRON_WEBPACK_WDS_PORT}?${params}`;
    }
    else {
        url = `${formatUrl({
            pathname: path.join(__dirname, 'index.html'),
            protocol: 'file',
            slashes: true,
        })}?${params}`;
    }
    return createWindow(title, url, winParams);
}
function createWindow(title, url, winParams, ignoreCache = false) {
    const window = new BrowserWindow(Object.assign({ webPreferences: { nodeIntegration: true }, title: title, show: false }, winParams));
    const promise = new Promise((resolve, reject) => {
        window.once('ready-to-show', () => {
            window.show();
            resolve(window);
        });
    });
    if (isDevelopment) {
        window.webContents.openDevTools();
    }
    if (ignoreCache) {
        console.debug("Opening window ignoring cache");
        window.loadURL(url, { 'extraHeaders': 'pragma: no-cache\n' });
    }
    else {
        window.loadURL(url);
    }
    window.webContents.on('devtools-opened', () => {
        window.focus();
        setImmediate(() => {
            window.focus();
        });
    });
    return promise;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2luZG93LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL21haW4vd2luZG93LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sS0FBSyxJQUFJLE1BQU0sTUFBTSxDQUFBO0FBQzVCLE9BQU8sRUFBRSxNQUFNLElBQUksU0FBUyxFQUFFLE1BQU0sS0FBSyxDQUFDO0FBQzFDLE9BQU8sRUFBRSxhQUFhLEVBQUUsSUFBSSxFQUE4QixNQUFNLFVBQVUsQ0FBQztBQUczRTt3Q0FDd0M7QUFHeEMsTUFBTSxhQUFhLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEtBQUssWUFBWSxDQUFDO0FBQzVELE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxRQUFRLEtBQUssUUFBUSxDQUFDO0FBRTlDLDJFQUEyRTtBQUMzRSxNQUFNLENBQUMsSUFBSSxPQUFPLEdBQW9CLEVBQUUsQ0FBQztBQUV6QyxzQ0FBc0M7QUFDdEMsSUFBSSxjQUFjLEdBQXVDLEVBQUUsQ0FBQztBQWdCNUQsTUFBTSxDQUFDLE1BQU0sVUFBVSxHQUFpQixLQUFLLEVBQUUsRUFDM0MsS0FBSyxFQUNMLEdBQUcsRUFBRSxTQUFTLEVBQUUsZUFBZSxFQUMvQixVQUFVLEVBQUUsU0FBUyxFQUNyQixTQUFTLEVBQUUsWUFBWSxFQUFFLFdBQVcsRUFBRSxFQUFFLEVBQUU7SUFFNUMsSUFBSSxDQUFDLFNBQVMsSUFBSSxFQUFFLENBQUMsQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxHQUFHLElBQUksRUFBRSxDQUFDLENBQUMsSUFBSSxFQUFFLEtBQUssRUFBRSxFQUFFO1FBQ2hFLE1BQU0sSUFBSSxLQUFLLENBQUMsbURBQW1ELENBQUMsQ0FBQztLQUN0RTtJQUVELE1BQU0sZUFBZSxHQUFHLGdCQUFnQixDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ2hELElBQUksZUFBZSxLQUFLLFNBQVMsRUFBRTtRQUNqQyxlQUFlLENBQUMsS0FBSyxFQUFFLENB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LENBQUMsK0JBQStCLENBQUMsQ0FBQztRQUMvQyxNQUFNLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxFQUFDLGNBQWMsRUFBRSxvQkFBb0IsRUFBQyxDQUFDLENBQUM7S0FDN0Q7U0FBTTtRQUNMLE1BQU0sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7S0FDckI7SUFFRCxNQUFNLENBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQyxpQkFBaUIsRUFBRSxHQUFHLEVBQUU7UUFDNUMsTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ2YsWUFBWSxDQUFDLEdBQUcsRUFBRTtZQUNoQixNQUFNLENBQUMsS0FBSyxFQUFFLENBQUE7UUFDaEIsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUVILE9BQU8sT0FBTyxDQUFDO0FBQ2pCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnXG5pbXBvcnQgeyBmb3JtYXQgYXMgZm9ybWF0VXJsIH0gZnJvbSAndXJsJztcbmltcG9ydCB7IEJyb3dzZXJXaW5kb3csIE1lbnUsIE1lbnVJdGVtQ29uc3RydWN0b3JPcHRpb25zIH0gZnJvbSAnZWxlY3Ryb24nO1xuXG5cbi8qIFdpbmRvdy1yZWxhdGVkIGhlbHBlcnNcbiAgIFRPRE8gKCM0KTogTW92ZSBpbnRvIHRoZSBmcmFtZXdvcmsgKi9cblxuXG5jb25zdCBpc0RldmVsb3BtZW50ID0gcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJztcbmNvbnN0IGlzTWFjT1MgPSBwcm9jZXNzLnBsYXRmb3JtID09PSAnZGFyd2luJztcblxuLy8gS2VlcHMgdHJhY2sgb2Ygd2luZG93cyBhbmQgZW5zdXJlcyAoPykgdGhleSBkbyBub3QgZ2V0IGdhcmJhZ2UgY29sbGVjdGVkXG5leHBvcnQgdmFyIHdpbmRvd3M6IEJyb3dzZXJXaW5kb3dbXSA9IFtdO1xuXG4vLyBBbGxvd3MgdG8gbG9jYXRlIHdpbmRvdyBJRCBieSBsYWJlbFxudmFyIHdpbmRvd3NCeVRpdGxlOiB7IFt0aXRsZTogc3RyaW5nXTogQnJvd3NlcldpbmRvdyB9ID0ge307XG5cblxuLy8gT3BlbiBuZXcgd2luZG93LCBvciBmb2N1cyBpZiBvbmUgd2l0aCB0aGUgc2FtZSB0aXRsZSBhbHJlYWR5IGV4aXN0c1xuZXhwb3J0IGludGVyZmFjZSBXaW5kb3dPcGVuZXJQYXJhbXMge1xuICB0aXRsZTogc3RyaW5nLFxuICB1cmw/OiBzdHJpbmcsXG4gIGNvbXBvbmVudD86IHN0cmluZyxcbiAgY29tcG9uZW50UGFyYW1zPzogc3RyaW5nLFxuICBkaW1lbnNpb25zPzogeyBtaW5IZWlnaHQ/OiBudW1iZXIsIG1pbldpZHRoPzogbnVtYmVyLCB3aWR0aD86IG51bWJlciwgaGVpZ2h0PzogbnVtYmVyIH0sXG4gIGZyYW1lbGVzcz86IGJvb2xlYW4sXG4gIHdpblBhcmFtcz86IGFueSxcbiAgbWVudVRlbXBsYXRlPzogTWVudUl0ZW1Db25zdHJ1Y3Rvck9wdGlvbnNbXSxcbiAgaWdub3JlQ2FjaGU/OiBib29sZWFuLFxufVxuZXhwb3J0IHR5cGUgV2luZG93T3BlbmVyID0gKHByb3BzOiBXaW5kb3dPcGVuZXJQYXJhbXMpID0+IFByb21pc2U8QnJvd3NlcldpbmRvdz47XG5leHBvcnQgY29uc3Qgb3BlbldpbmRvdzogV2luZG93T3BlbmVyID0gYXN5bmMgKHtcbiAgICB0aXRsZSxcbiAgICB1cmwsIGNvbXBvbmVudCwgY29tcG9uZW50UGFyYW1zLFxuICAgIGRpbWVuc2lvbnMsIGZyYW1lbGVzcyxcbiAgICB3aW5QYXJhbXMsIG1lbnVUZW1wbGF0ZSwgaWdub3JlQ2FjaGUgfSkgPT4ge1xuXG4gIGlmICgoY29tcG9uZW50IHx8ICcnKS50cmltKCkgPT09ICcnICYmICh1cmwgfHwgJycpLnRyaW0oKSA9PT0gJycpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJvcGVuV2luZG93KCkgcmVxdWlyZXMgZWl0aGVyIGBjb21wb25lbnRgIG9yIGB1cmxgXCIpO1xuICB9XG5cbiAgY29uc3QgX2V4aXN0aW5nV2luZG93ID0gZ2V0V2luZG93QnlUaXRsZSh0aXRsZSk7XG4gIGlmIChfZXhpc3RpbmdXaW5kb3cgIT09IHVuZGVmaW5lZCkge1xuICAgIF9leGlzdGluZ1dpbmRvdy5mb2N1cygpO1xuICAgIHJldHVybiBfZXhpc3RpbmdXaW5kb3c7XG4gIH1cblxuICBjb25zdCBfZnJhbWVsZXNzT3B0cyA9IHtcbiAgICBmcmFtZTogaXNNYWNPUyA/IHRydWUgOiBmYWxzZSxcbiAgICB0aXRsZUJhclN0eWxlOiBpc01hY09TID8gJ2hpZGRlbkluc2V0JyA6IHVuZGVmaW5lZCxcbiAgfTtcblxuICBjb25zdCBfd2luUGFyYW1zID0ge1xuICAgIHdpZHRoOiAoZGltZW5zaW9ucyB8fCB7fSkud2lkdGgsXG4gICAgbWluV2lkdGg6IChkaW1lbnNpb25zIHx8IHt9KS5taW5XaWR0aCxcbiAgICBoZWlnaHQ6IChkaW1lbnNpb25zIHx8IHt9KS5oZWlnaHQsXG4gICAgbWluSGVpZ2h0OiAoZGltZW5zaW9ucyB8fCB7fSkubWluSGVpZ2h0LFxuICAgIC4uLihmcmFtZWxlc3MgPT09IHRydWUgPyBfZnJhbWVsZXNzT3B0cyA6IHt9KSxcbiAgICAuLi53aW5QYXJhbXMsXG4gIH07XG5cbiAgbGV0IHdpbmRvdzogQnJvd3NlcldpbmRvdztcblxuICBpZiAoY29tcG9uZW50KSB7XG4gICAgY29uc3QgcGFyYW1zID0gYGM9JHtjb21wb25lbnR9JiR7Y29tcG9uZW50UGFyYW1zID8gY29tcG9uZW50UGFyYW1zIDogJyd9YDtcbiAgICB3aW5kb3cgPSBhd2FpdCBjcmVhdGVXaW5kb3dGb3JMb2NhbENvbXBvbmVudCh0aXRsZSwgcGFyYW1zLCBfd2luUGFyYW1zKTtcbiAgfSBlbHNlIGlmICh1cmwpIHtcbiAgICB3aW5kb3cgPSBhd2FpdCBjcmVhdGVXaW5kb3codGl0bGUsIHVybCwgX3dpblBhcmFtcywgaWdub3JlQ2FjaGUpO1xuICB9IGVsc2Uge1xuICAgIHRocm93IG5ldyBFcnJvcihcIkVpdGhlciBjb21wb25lbnQgb3IgdXJsIG11c3QgYmUgZ2l2ZW4gdG8gb3BlbldpbmRvdygpXCIpO1xuICB9XG5cbiAgaWYgKG1lbnVUZW1wbGF0ZSAmJiAhaXNNYWNPUykge1xuICAgIHdpbmRvdy5zZXRNZW51KE1lbnUuYnVpbGRGcm9tVGVtcGxhdGUobWVudVRlbXBsYXRlKSk7XG4gIH1cblxuICB3aW5kb3dzLnB1c2god2luZG93KTtcbiAgd2luZG93c0J5VGl0bGVbdGl0bGVdID0gd2luZG93O1xuICB3aW5kb3cub24oJ2Nsb3NlZCcsICgpID0+IHsgZGVsZXRlIHdpbmRvd3NCeVRpdGxlW3RpdGxlXTsgY2xlYW5VcFdpbmRvd3MoKTsgfSk7XG5cbiAgcmV0dXJuIHdpbmRvdztcbn1cblxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0V2luZG93QnlUaXRsZSh0aXRsZTogc3RyaW5nKTogQnJvd3NlcldpbmRvdyB8IHVuZGVmaW5lZCB7XG4gIHJldHVybiB3aW5kb3dzQnlUaXRsZVt0aXRsZV07XG59XG5cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFdpbmRvdyhmdW5jOiAod2luOiBCcm93c2VyV2luZG93KSA9PiBib29sZWFuKTogQnJvd3NlcldpbmRvdyB8IHVuZGVmaW5lZCB7XG4gIHJldHVybiB3aW5kb3dzLmZpbmQoZnVuYyk7XG59XG5cblxuLy8gSXRlcmF0ZSBvdmVyIGFycmF5IG9mIHdpbmRvd3MgYW5kIHRyeSBhY2Nlc3Npbmcgd2luZG93IElELlxuLy8gSWYgaXQgdGhyb3dzLCB3aW5kb3cgd2FzIGNsb3NlZCBhbmQgd2UgcmVtb3ZlIGl0IGZyb20gdGhlIGFycmF5LlxuLy8gU3VwcG9zZWQgdG8gYmUgcnVuIGFmdGVyIGFueSB3aW5kb3cgaXMgY2xvc2VkXG5mdW5jdGlvbiBjbGVhblVwV2luZG93cygpIHtcbiAgdmFyIGRlbGV0ZWRXaW5kb3dzOiBudW1iZXJbXSA9IFtdO1xuICBmb3IgKGNvbnN0IFtpZHgsIHdpbl0gb2Ygd2luZG93cy5lbnRyaWVzKCkpIHtcbiAgICAvLyBXaGVuIGFjY2Vzc2luZyB0aGUgaWQgYXR0cmlidXRlIG9mIGEgY2xvc2VkIHdpbmRvdyxcbiAgICAvLyBpdOKAmWxsIHRocm93LiBXZeKAmWxsIG1hcmsgaXRzIGluZGV4IGZvciBkZWxldGlvbiB0aGVuLlxuICAgIHRyeSB7XG4gICAgICB3aW4uaWQ7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgZGVsZXRlZFdpbmRvd3MucHVzaChpZHggLSBkZWxldGVkV2luZG93cy5sZW5ndGgpO1xuICAgIH1cbiAgfVxuICBmb3IgKGNvbnN0IGlkeCBvZiBkZWxldGVkV2luZG93cykge1xuICAgIHdpbmRvd3Muc3BsaWNlKGlkeCwgMSk7XG4gIH1cbn1cblxuXG5mdW5jdGlvbiBjcmVhdGVXaW5kb3dGb3JMb2NhbENvbXBvbmVudCh0aXRsZTogc3RyaW5nLCBwYXJhbXM6IHN0cmluZywgd2luUGFyYW1zOiBhbnkpOiBQcm9taXNlPEJyb3dzZXJXaW5kb3c+IHtcbiAgbGV0IHVybDogc3RyaW5nO1xuXG4gIGlmIChpc0RldmVsb3BtZW50KSB7XG4gICAgdXJsID0gYGh0dHA6Ly9sb2NhbGhvc3Q6JHtwcm9jZXNzLmVudi5FTEVDVFJPTl9XRUJQQUNLX1dEU19QT1JUfT8ke3BhcmFtc31gO1xuICB9XG4gIGVsc2Uge1xuICAgIHVybCA9IGAke2Zvcm1hdFVybCh7XG4gICAgICBwYXRobmFtZTogcGF0aC5qb2luKF9fZGlybmFtZSwgJ2luZGV4Lmh0bWwnKSxcbiAgICAgIHByb3RvY29sOiAnZmlsZScsXG4gICAgICBzbGFzaGVzOiB0cnVlLFxuICAgIH0pfT8ke3BhcmFtc31gO1xuICB9XG5cbiAgcmV0dXJuIGNyZWF0ZVdpbmRvdyh0aXRsZSwgdXJsLCB3aW5QYXJhbXMpO1xufVxuXG5cbmZ1bmN0aW9uIGNyZWF0ZVdpbmRvdyh0aXRsZTogc3RyaW5nLCB1cmw6IHN0cmluZywgd2luUGFyYW1zOiBhbnksIGlnbm9yZUNhY2hlOiBib29sZWFuID0gZmFsc2UpOiBQcm9taXNlPEJyb3dzZXJXaW5kb3c+IHtcbiAgY29uc3Qgd2luZG93ID0gbmV3IEJyb3dzZXJXaW5kb3coe1xuICAgIHdlYlByZWZlcmVuY2VzOiB7bm9kZUludGVncmF0aW9uOiB0cnVlfSxcbiAgICB0aXRsZTogdGl0bGUsXG4gICAgc2hvdzogZmFsc2UsXG4gICAgLi4ud2luUGFyYW1zXG4gIH0pO1xuXG4gIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZTxCcm93c2VyV2luZG93PigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgd2luZG93Lm9uY2UoJ3JlYWR5LXRvLXNob3cnLCAoKSA9PiB7XG4gICAgICB3aW5kb3cuc2hvdygpO1xuICAgICAgcmVzb2x2ZSh3aW5kb3cpO1xuICAgIH0pO1xuICB9KTtcblxuICBpZiAoaXNEZXZlbG9wbWVudCkge1xuICAgIHdpbmRvdy53ZWJDb250ZW50cy5vcGVuRGV2VG9vbHMoKTtcbiAgfVxuXG4gIGlmIChpZ25vcmVDYWNoZSkge1xuICAgIGNvbnNvbGUuZGVidWcoXCJPcGVuaW5nIHdpbmRvdyBpZ25vcmluZyBjYWNoZVwiKTtcbiAgICB3aW5kb3cubG9hZFVSTCh1cmwsIHsnZXh0cmFIZWFkZXJzJzogJ3ByYWdtYTogbm8tY2FjaGVcXG4nfSk7XG4gIH0gZWxzZSB7XG4gICAgd2luZG93LmxvYWRVUkwodXJsKTtcbiAgfVxuXG4gIHdpbmRvdy53ZWJDb250ZW50cy5vbignZGV2dG9vbHMtb3BlbmVkJywgKCkgPT4ge1xuICAgIHdpbmRvdy5mb2N1cygpO1xuICAgIHNldEltbWVkaWF0ZSgoKSA9PiB7XG4gICAgICB3aW5kb3cuZm9jdXMoKVxuICAgIH0pO1xuICB9KTtcblxuICByZXR1cm4gcHJvbWlzZTtcbn1cbiJdfQ==