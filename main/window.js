import * as path from 'path';
import { format as formatUrl } from 'url';
import { BrowserWindow, Menu } from 'electron';
/* Window-related helpers
   TODO (#4): Move into the framework */
const isDevelopment = process.env.NODE_ENV !== 'production';
const isMacOS = process.platform === 'darwin';
// Keeps track of windows and ensures (?) they do not get garbage collected
export var windows = [];
// Allows to locate window ID by label
var windowsByTitle = {};
export const openWindow = async ({ title, url, component, componentParams, dimensions, frameless, winParams, menuTemplate }) => {
    if ((component || '').trim() === '' && (url || '').trim() === '') {
        throw new Error("openWindow() requires either `component` or `url`");
    }
    const _existingWindow = getWindowByTitle(title);
    if (_existingWindow !== undefined) {
        _existingWindow.focus();
        return _existingWindow;
    }
    const _framelessOpts = {
        frame: isMacOS ? true : false,
        titleBarStyle: isMacOS ? 'hiddenInset' : undefined,
    };
    const _winParams = Object.assign(Object.assign({ width: (dimensions || {}).width, minWidth: (dimensions || {}).minWidth, height: (dimensions || {}).height, minHeight: (dimensions || {}).minHeight }, (frameless === true ? _framelessOpts : {})), winParams);
    let window;
    if (component) {
        const params = `c=${component}&${componentParams ? componentParams : ''}`;
        window = await createWindowForLocalComponent(title, params, _winParams);
    }
    else if (url) {
        window = await createWindow(title, url, _winParams);
    }
    else {
        throw new Error("Either component or url must be given to openWindow()");
    }
    if (menuTemplate && !isMacOS) {
        window.setMenu(Menu.buildFromTemplate(menuTemplate));
    }
    windows.push(window);
    windowsByTitle[title] = window;
    window.on('closed', () => { delete windowsByTitle[title]; cleanUpWindows(); });
    return window;
};
export function getWindowByTitle(title) {
    return windowsByTitle[title];
}
export function getWindow(func) {
    return windows.find(func);
}
// Iterate over array of windows and try accessing window ID.
// If it throws, window was closed and we remove it from the array.
// Supposed to be run after any window is closed
function cleanUpWindows() {
    var deletedWindows = [];
    for (const [idx, win] of windows.entries()) {
        // When accessing the id attribute of a closed window,
        // it’ll throw. We’ll mark its index for deletion then.
        try {
            win.id;
        }
        catch (e) {
            deletedWindows.push(idx - deletedWindows.length);
        }
    }
    for (const idx of deletedWindows) {
        windows.splice(idx, 1);
    }
}
function createWindowForLocalComponent(title, params, winParams) {
    let url;
    if (isDevelopment) {
        url = `http://localhost:${process.env.ELECTRON_WEBPACK_WDS_PORT}?${params}`;
    }
    else {
        url = `${formatUrl({
            pathname: path.join(__dirname, 'index.html'),
            protocol: 'file',
            slashes: true,
        })}?${params}`;
    }
    return createWindow(title, url, winParams);
}
function createWindow(title, url, winParams) {
    const window = new BrowserWindow(Object.assign({ webPreferences: { nodeIntegration: true }, title: title, show: false }, winParams));
    const promise = new Promise((resolve, reject) => {
        window.once('ready-to-show', () => {
            window.show();
            resolve(window);
        });
    });
    if (isDevelopment) {
        window.webContents.openDevTools();
    }
    window.loadURL(url);
    window.webContents.on('devtools-opened', () => {
        window.focus();
        setImmediate(() => {
            window.focus();
        });
    });
    return promise;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2luZG93LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL21haW4vd2luZG93LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sS0FBSyxJQUFJLE1BQU0sTUFBTSxDQUFBO0FBQzVCLE9BQU8sRUFBRSxNQUFNLElBQUksU0FBUyxFQUFFLE1BQU0sS0FBSyxDQUFDO0FBQzFDLE9BQU8sRUFBRSxhQUFhLEVBQUUsSUFBSSxFQUE4QixNQUFNLFVBQVUsQ0FBQztBQUczRTt3Q0FDd0M7QUFHeEMsTUFBTSxhQUFhLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEtBQUssWUFBWSxDQUFDO0FBQzVELE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxRQUFRLEtBQUssUUFBUSxDQUFDO0FBRTlDLDJFQUEyRTtBQUMzRSxNQUFNLENBQUMsSUFBSSxPQUFPLEdBQW9CLEVBQUUsQ0FBQztBQUV6QyxzQ0FBc0M7QUFDdEMsSUFBSSxjQUFjLEdBQXVDLEVBQUUsQ0FBQztBQWU1RCxNQUFNLENBQUMsTUFBTSxVQUFVLEdBQWlCLEtBQUssRUFBRSxFQUMzQyxLQUFLLEVBQ0wsR0FBRyxFQUFFLFNBQVMsRUFBRSxlQUFlLEVBQy9CLFVBQVUsRUFBRSxTQUFTLEVBQ3JCLFNBQVMsRUFBRSxZQUFZLEVBQUUsRUFBRSxFQUFFO0lBRS9CLElBQUksQ0FBQyxTQUFTLElBQUksRUFBRSxDQUFDLENBQUMsSUFBSSxFQUFFLEtBQUssRUFBRSxJQUFJLENBQUMsR0FBRyxJQUFJLEVBQUUsQ0FBQyxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsRUFBRTtRQUNoRSxNQUFNLElBQUksS0FBSyxDQUFDLG1EQUFtRCxDQUFDLENBQUM7S0FDdEU7SUFFRCxNQUFNLGVBQWUsR0FBRyxnQkFBZ0IsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNoRCxJQUFJLGVBQWUsS0FBSyxTQUFTLEVBQUU7UUFDakMsZUFBZSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ3hCLE9B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aUJBQWlCLEVBQUUsR0FBRyxFQUFFO1FBQzVDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUNmLFlBQVksQ0FBQyxHQUFHLEVBQUU7WUFDaEIsTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFBO1FBQ2hCLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxPQUFPLE9BQU8sQ0FBQztBQUNqQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJ1xuaW1wb3J0IHsgZm9ybWF0IGFzIGZvcm1hdFVybCB9IGZyb20gJ3VybCc7XG5pbXBvcnQgeyBCcm93c2VyV2luZG93LCBNZW51LCBNZW51SXRlbUNvbnN0cnVjdG9yT3B0aW9ucyB9IGZyb20gJ2VsZWN0cm9uJztcblxuXG4vKiBXaW5kb3ctcmVsYXRlZCBoZWxwZXJzXG4gICBUT0RPICgjNCk6IE1vdmUgaW50byB0aGUgZnJhbWV3b3JrICovXG5cblxuY29uc3QgaXNEZXZlbG9wbWVudCA9IHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbic7XG5jb25zdCBpc01hY09TID0gcHJvY2Vzcy5wbGF0Zm9ybSA9PT0gJ2Rhcndpbic7XG5cbi8vIEtlZXBzIHRyYWNrIG9mIHdpbmRvd3MgYW5kIGVuc3VyZXMgKD8pIHRoZXkgZG8gbm90IGdldCBnYXJiYWdlIGNvbGxlY3RlZFxuZXhwb3J0IHZhciB3aW5kb3dzOiBCcm93c2VyV2luZG93W10gPSBbXTtcblxuLy8gQWxsb3dzIHRvIGxvY2F0ZSB3aW5kb3cgSUQgYnkgbGFiZWxcbnZhciB3aW5kb3dzQnlUaXRsZTogeyBbdGl0bGU6IHN0cmluZ106IEJyb3dzZXJXaW5kb3cgfSA9IHt9O1xuXG5cbi8vIE9wZW4gbmV3IHdpbmRvdywgb3IgZm9jdXMgaWYgb25lIHdpdGggdGhlIHNhbWUgdGl0bGUgYWxyZWFkeSBleGlzdHNcbmV4cG9ydCBpbnRlcmZhY2UgV2luZG93T3BlbmVyUGFyYW1zIHtcbiAgdGl0bGU6IHN0cmluZyxcbiAgdXJsPzogc3RyaW5nLFxuICBjb21wb25lbnQ/OiBzdHJpbmcsXG4gIGNvbXBvbmVudFBhcmFtcz86IHN0cmluZyxcbiAgZGltZW5zaW9ucz86IHsgbWluSGVpZ2h0PzogbnVtYmVyLCBtaW5XaWR0aD86IG51bWJlciwgd2lkdGg/OiBudW1iZXIsIGhlaWdodD86IG51bWJlciB9LFxuICBmcmFtZWxlc3M/OiBib29sZWFuLFxuICB3aW5QYXJhbXM/OiBhbnksXG4gIG1lbnVUZW1wbGF0ZT86IE1lbnVJdGVtQ29uc3RydWN0b3JPcHRpb25zW10sXG59XG5leHBvcnQgdHlwZSBXaW5kb3dPcGVuZXIgPSAocHJvcHM6IFdpbmRvd09wZW5lclBhcmFtcykgPT4gUHJvbWlzZTxCcm93c2VyV2luZG93PjtcbmV4cG9ydCBjb25zdCBvcGVuV2luZG93OiBXaW5kb3dPcGVuZXIgPSBhc3luYyAoe1xuICAgIHRpdGxlLFxuICAgIHVybCwgY29tcG9uZW50LCBjb21wb25lbnRQYXJhbXMsXG4gICAgZGltZW5zaW9ucywgZnJhbWVsZXNzLFxuICAgIHdpblBhcmFtcywgbWVudVRlbXBsYXRlIH0pID0+IHtcblxuICBpZiAoKGNvbXBvbmVudCB8fCAnJykudHJpbSgpID09PSAnJyAmJiAodXJsIHx8ICcnKS50cmltKCkgPT09ICcnKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwib3BlbldpbmRvdygpIHJlcXVpcmVzIGVpdGhlciBgY29tcG9uZW50YCBvciBgdXJsYFwiKTtcbiAgfVxuXG4gIGNvbnN0IF9leGlzdGluZ1dpbmRvdyA9IGdldFdpbmRvd0J5VGl0bGUodGl0bGUpO1xuICBpZiAoX2V4aXN0aW5nV2luZG93ICE9PSB1bmRlZmluZWQpIHtcbiAgICBfZXhpc3RpbmdXaW5kb3cuZm9jdXMoKTtcbiAgICByZXR1cm4gX2V4aXN0aW5nV2luZG93O1xuICB9XG5cbiAgY29uc3QgX2ZyYW1lbGVzc09wdHMgPSB7XG4gICAgZnJhbWU6IGlzTWFjT1MgPyB0cnVlIDogZmFsc2UsXG4gICAgdGl0bGVCYXJTdHlsZTogaXNNYWNPUyA/ICdoaWRkZW5JbnNldCcgOiB1bmRlZmluZWQsXG4gIH07XG5cbiAgY29uc3QgX3dpblBhcmFtcyA9IHtcbiAgICB3aWR0aDogKGRpbWVuc2lvbnMgfHwge30pLndpZHRoLFxuICAgIG1pbldpZHRoOiAoZGltZW5zaW9ucyB8fCB7fSkubWluV2lkdGgsXG4gICAgaGVpZ2h0OiAoZGltZW5zaW9ucyB8fCB7fSkuaGVpZ2h0LFxuICAgIG1pbkhlaWdodDogKGRpbWVuc2lvbnMgfHwge30pLm1pbkhlaWdodCxcbiAgICAuLi4oZnJhbWVsZXNzID09PSB0cnVlID8gX2ZyYW1lbGVzc09wdHMgOiB7fSksXG4gICAgLi4ud2luUGFyYW1zLFxuICB9O1xuXG4gIGxldCB3aW5kb3c6IEJyb3dzZXJXaW5kb3c7XG5cbiAgaWYgKGNvbXBvbmVudCkge1xuICAgIGNvbnN0IHBhcmFtcyA9IGBjPSR7Y29tcG9uZW50fSYke2NvbXBvbmVudFBhcmFtcyA/IGNvbXBvbmVudFBhcmFtcyA6ICcnfWA7XG4gICAgd2luZG93ID0gYXdhaXQgY3JlYXRlV2luZG93Rm9yTG9jYWxDb21wb25lbnQodGl0bGUsIHBhcmFtcywgX3dpblBhcmFtcyk7XG4gIH0gZWxzZSBpZiAodXJsKSB7XG4gICAgd2luZG93ID0gYXdhaXQgY3JlYXRlV2luZG93KHRpdGxlLCB1cmwsIF93aW5QYXJhbXMpO1xuICB9IGVsc2Uge1xuICAgIHRocm93IG5ldyBFcnJvcihcIkVpdGhlciBjb21wb25lbnQgb3IgdXJsIG11c3QgYmUgZ2l2ZW4gdG8gb3BlbldpbmRvdygpXCIpO1xuICB9XG5cbiAgaWYgKG1lbnVUZW1wbGF0ZSAmJiAhaXNNYWNPUykge1xuICAgIHdpbmRvdy5zZXRNZW51KE1lbnUuYnVpbGRGcm9tVGVtcGxhdGUobWVudVRlbXBsYXRlKSk7XG4gIH1cblxuICB3aW5kb3dzLnB1c2god2luZG93KTtcbiAgd2luZG93c0J5VGl0bGVbdGl0bGVdID0gd2luZG93O1xuICB3aW5kb3cub24oJ2Nsb3NlZCcsICgpID0+IHsgZGVsZXRlIHdpbmRvd3NCeVRpdGxlW3RpdGxlXTsgY2xlYW5VcFdpbmRvd3MoKTsgfSk7XG5cbiAgcmV0dXJuIHdpbmRvdztcbn1cblxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0V2luZG93QnlUaXRsZSh0aXRsZTogc3RyaW5nKTogQnJvd3NlcldpbmRvdyB8IHVuZGVmaW5lZCB7XG4gIHJldHVybiB3aW5kb3dzQnlUaXRsZVt0aXRsZV07XG59XG5cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFdpbmRvdyhmdW5jOiAod2luOiBCcm93c2VyV2luZG93KSA9PiBib29sZWFuKTogQnJvd3NlcldpbmRvdyB8IHVuZGVmaW5lZCB7XG4gIHJldHVybiB3aW5kb3dzLmZpbmQoZnVuYyk7XG59XG5cblxuLy8gSXRlcmF0ZSBvdmVyIGFycmF5IG9mIHdpbmRvd3MgYW5kIHRyeSBhY2Nlc3Npbmcgd2luZG93IElELlxuLy8gSWYgaXQgdGhyb3dzLCB3aW5kb3cgd2FzIGNsb3NlZCBhbmQgd2UgcmVtb3ZlIGl0IGZyb20gdGhlIGFycmF5LlxuLy8gU3VwcG9zZWQgdG8gYmUgcnVuIGFmdGVyIGFueSB3aW5kb3cgaXMgY2xvc2VkXG5mdW5jdGlvbiBjbGVhblVwV2luZG93cygpIHtcbiAgdmFyIGRlbGV0ZWRXaW5kb3dzOiBudW1iZXJbXSA9IFtdO1xuICBmb3IgKGNvbnN0IFtpZHgsIHdpbl0gb2Ygd2luZG93cy5lbnRyaWVzKCkpIHtcbiAgICAvLyBXaGVuIGFjY2Vzc2luZyB0aGUgaWQgYXR0cmlidXRlIG9mIGEgY2xvc2VkIHdpbmRvdyxcbiAgICAvLyBpdOKAmWxsIHRocm93LiBXZeKAmWxsIG1hcmsgaXRzIGluZGV4IGZvciBkZWxldGlvbiB0aGVuLlxuICAgIHRyeSB7XG4gICAgICB3aW4uaWQ7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgZGVsZXRlZFdpbmRvd3MucHVzaChpZHggLSBkZWxldGVkV2luZG93cy5sZW5ndGgpO1xuICAgIH1cbiAgfVxuICBmb3IgKGNvbnN0IGlkeCBvZiBkZWxldGVkV2luZG93cykge1xuICAgIHdpbmRvd3Muc3BsaWNlKGlkeCwgMSk7XG4gIH1cbn1cblxuXG5mdW5jdGlvbiBjcmVhdGVXaW5kb3dGb3JMb2NhbENvbXBvbmVudCh0aXRsZTogc3RyaW5nLCBwYXJhbXM6IHN0cmluZywgd2luUGFyYW1zOiBhbnkpOiBQcm9taXNlPEJyb3dzZXJXaW5kb3c+IHtcbiAgbGV0IHVybDogc3RyaW5nO1xuXG4gIGlmIChpc0RldmVsb3BtZW50KSB7XG4gICAgdXJsID0gYGh0dHA6Ly9sb2NhbGhvc3Q6JHtwcm9jZXNzLmVudi5FTEVDVFJPTl9XRUJQQUNLX1dEU19QT1JUfT8ke3BhcmFtc31gO1xuICB9XG4gIGVsc2Uge1xuICAgIHVybCA9IGAke2Zvcm1hdFVybCh7XG4gICAgICBwYXRobmFtZTogcGF0aC5qb2luKF9fZGlybmFtZSwgJ2luZGV4Lmh0bWwnKSxcbiAgICAgIHByb3RvY29sOiAnZmlsZScsXG4gICAgICBzbGFzaGVzOiB0cnVlLFxuICAgIH0pfT8ke3BhcmFtc31gO1xuICB9XG5cbiAgcmV0dXJuIGNyZWF0ZVdpbmRvdyh0aXRsZSwgdXJsLCB3aW5QYXJhbXMpO1xufVxuXG5cbmZ1bmN0aW9uIGNyZWF0ZVdpbmRvdyh0aXRsZTogc3RyaW5nLCB1cmw6IHN0cmluZywgd2luUGFyYW1zOiBhbnkpOiBQcm9taXNlPEJyb3dzZXJXaW5kb3c+IHtcbiAgY29uc3Qgd2luZG93ID0gbmV3IEJyb3dzZXJXaW5kb3coe1xuICAgIHdlYlByZWZlcmVuY2VzOiB7bm9kZUludGVncmF0aW9uOiB0cnVlfSxcbiAgICB0aXRsZTogdGl0bGUsXG4gICAgc2hvdzogZmFsc2UsXG4gICAgLi4ud2luUGFyYW1zXG4gIH0pO1xuXG4gIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZTxCcm93c2VyV2luZG93PigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgd2luZG93Lm9uY2UoJ3JlYWR5LXRvLXNob3cnLCAoKSA9PiB7XG4gICAgICB3aW5kb3cuc2hvdygpO1xuICAgICAgcmVzb2x2ZSh3aW5kb3cpO1xuICAgIH0pO1xuICB9KTtcblxuICBpZiAoaXNEZXZlbG9wbWVudCkge1xuICAgIHdpbmRvdy53ZWJDb250ZW50cy5vcGVuRGV2VG9vbHMoKTtcbiAgfVxuXG4gIHdpbmRvdy5sb2FkVVJMKHVybCk7XG5cbiAgd2luZG93LndlYkNvbnRlbnRzLm9uKCdkZXZ0b29scy1vcGVuZWQnLCAoKSA9PiB7XG4gICAgd2luZG93LmZvY3VzKCk7XG4gICAgc2V0SW1tZWRpYXRlKCgpID0+IHtcbiAgICAgIHdpbmRvdy5mb2N1cygpXG4gICAgfSk7XG4gIH0pO1xuXG4gIHJldHVybiBwcm9taXNlO1xufVxuIl19