import * as path from 'path';
import { format as formatUrl } from 'url';
import { BrowserWindow, Menu } from 'electron';
/* Window-related helpers
   TODO (#4): Move into the framework */
const isDevelopment = process.env.NODE_ENV !== 'production';
const isMacOS = process.platform === 'darwin';
// Keeps track of windows and ensures (?) they do not get garbage collected
export var windows = [];
// Allows to locate window ID by label
var windowsByTitle = {};
export const openWindow = async ({ title, url, component, componentParams, dimensions, frameless, winParams, menuTemplate, ignoreCache }) => {
    if ((component || '').trim() === '' && (url || '').trim() === '') {
        throw new Error("openWindow() requires either `component` or `url`");
    }
    const _existingWindow = getWindowByTitle(title);
    if (_existingWindow !== undefined) {
        _existingWindow.focus();
        return _existingWindow;
    }
    const _framelessOpts = {
        titleBarStyle: isMacOS ? 'hiddenInset' : undefined,
    };
    const _winParams = Object.assign(Object.assign({ width: (dimensions || {}).width, minWidth: (dimensions || {}).minWidth, height: (dimensions || {}).height, minHeight: (dimensions || {}).minHeight }, (frameless === true ? _framelessOpts : {})), winParams);
    let window;
    if (component) {
        const params = `c=${component}&${componentParams ? componentParams : ''}`;
        window = await createWindowForLocalComponent(title, params, _winParams);
    }
    else if (url) {
        window = await createWindow(title, url, _winParams, ignoreCache);
    }
    else {
        throw new Error("Either component or url must be given to openWindow()");
    }
    if (menuTemplate && !isMacOS) {
        window.setMenu(Menu.buildFromTemplate(menuTemplate));
    }
    windows.push(window);
    windowsByTitle[title] = window;
    window.on('closed', () => { delete windowsByTitle[title]; cleanUpWindows(); });
    return window;
};
export function getWindowByTitle(title) {
    return windowsByTitle[title];
}
export function getWindow(func) {
    return windows.find(func);
}
// Iterate over array of windows and try accessing window ID.
// If it throws, window was closed and we remove it from the array.
// Supposed to be run after any window is closed
function cleanUpWindows() {
    var deletedWindows = [];
    for (const [idx, win] of windows.entries()) {
        // When accessing the id attribute of a closed window,
        // it’ll throw. We’ll mark its index for deletion then.
        try {
            win.id;
        }
        catch (e) {
            deletedWindows.push(idx - deletedWindows.length);
        }
    }
    for (const idx of deletedWindows) {
        windows.splice(idx, 1);
    }
}
function createWindowForLocalComponent(title, params, winParams) {
    let url;
    if (isDevelopment) {
        url = `http://localhost:${process.env.ELECTRON_WEBPACK_WDS_PORT}?${params}`;
    }
    else {
        url = `${formatUrl({
            pathname: path.join(__dirname, 'index.html'),
            protocol: 'file',
            slashes: true,
        })}?${params}`;
    }
    return createWindow(title, url, winParams);
}
function createWindow(title, url, winParams, ignoreCache = false) {
    const window = new BrowserWindow(Object.assign({ webPreferences: { nodeIntegration: true }, title: title, show: false }, winParams));
    const promise = new Promise((resolve, reject) => {
        window.once('ready-to-show', () => {
            window.show();
            resolve(window);
        });
    });
    if (isDevelopment) {
        window.webContents.openDevTools();
    }
    if (ignoreCache) {
        window.loadURL(url, { 'extraHeaders': 'pragma: no-cache\n' });
    }
    else {
        window.loadURL(url);
    }
    window.webContents.on('devtools-opened', () => {
        window.focus();
        setImmediate(() => {
            window.focus();
        });
    });
    return promise;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2luZG93LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL21haW4vd2luZG93LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sS0FBSyxJQUFJLE1BQU0sTUFBTSxDQUFBO0FBQzVCLE9BQU8sRUFBRSxNQUFNLElBQUksU0FBUyxFQUFFLE1BQU0sS0FBSyxDQUFDO0FBQzFDLE9BQU8sRUFBRSxhQUFhLEVBQUUsSUFBSSxFQUE4QixNQUFNLFVBQVUsQ0FBQztBQUczRTt3Q0FDd0M7QUFHeEMsTUFBTSxhQUFhLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEtBQUssWUFBWSxDQUFDO0FBQzVELE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxRQUFRLEtBQUssUUFBUSxDQUFDO0FBRTlDLDJFQUEyRTtBQUMzRSxNQUFNLENBQUMsSUFBSSxPQUFPLEdBQW9CLEVBQUUsQ0FBQztBQUV6QyxzQ0FBc0M7QUFDdEMsSUFBSSxjQUFjLEdBQXVDLEVBQUUsQ0FBQztBQWdCNUQsTUFBTSxDQUFDLE1BQU0sVUFBVSxHQUFpQixLQUFLLEVBQUUsRUFDM0MsS0FBSyxFQUNMLEdBQUcsRUFBRSxTQUFTLEVBQUUsZUFBZSxFQUMvQixVQUFVLEVBQUUsU0FBUyxFQUNyQixTQUFTLEVBQUUsWUFBWSxFQUFFLFdBQVcsRUFBRSxFQUFFLEVBQUU7SUFFNUMsSUFBSSxDQUFDLFNBQVMsSUFBSSxFQUFFLENBQUMsQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxHQUFHLElBQUksRUFBRSxDQUFDLENBQUMsSUFBSSxFQUFFLEtBQUssRUFBRSxFQUFFO1FBQ2hFLE1BQU0sSUFBSSxLQUFLLENBQUMsbURBQW1ELENBQUMsQ0FBQztLQUN0RTtJQUVELE1BQU0sZUFBZSxHQUFHLGdCQUFnQixDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ2hELElBQUksZUFBZSxLQUFLLFNBQVMsRUFBRTtRQUNqQyxlQUFlLENBQUMsS0FBSyxFQUFFLENB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QU07UUFDTCxNQUFNLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0tBQ3JCO0lBRUQsTUFBTSxDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUMsaUJBQWlCLEVBQUUsR0FBRyxFQUFFO1FBQzVDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUNmLFlBQVksQ0FBQyxHQUFHLEVBQUU7WUFDaEIsTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFBO1FBQ2hCLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxPQUFPLE9BQU8sQ0FBQztBQUNqQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJ1xuaW1wb3J0IHsgZm9ybWF0IGFzIGZvcm1hdFVybCB9IGZyb20gJ3VybCc7XG5pbXBvcnQgeyBCcm93c2VyV2luZG93LCBNZW51LCBNZW51SXRlbUNvbnN0cnVjdG9yT3B0aW9ucyB9IGZyb20gJ2VsZWN0cm9uJztcblxuXG4vKiBXaW5kb3ctcmVsYXRlZCBoZWxwZXJzXG4gICBUT0RPICgjNCk6IE1vdmUgaW50byB0aGUgZnJhbWV3b3JrICovXG5cblxuY29uc3QgaXNEZXZlbG9wbWVudCA9IHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbic7XG5jb25zdCBpc01hY09TID0gcHJvY2Vzcy5wbGF0Zm9ybSA9PT0gJ2Rhcndpbic7XG5cbi8vIEtlZXBzIHRyYWNrIG9mIHdpbmRvd3MgYW5kIGVuc3VyZXMgKD8pIHRoZXkgZG8gbm90IGdldCBnYXJiYWdlIGNvbGxlY3RlZFxuZXhwb3J0IHZhciB3aW5kb3dzOiBCcm93c2VyV2luZG93W10gPSBbXTtcblxuLy8gQWxsb3dzIHRvIGxvY2F0ZSB3aW5kb3cgSUQgYnkgbGFiZWxcbnZhciB3aW5kb3dzQnlUaXRsZTogeyBbdGl0bGU6IHN0cmluZ106IEJyb3dzZXJXaW5kb3cgfSA9IHt9O1xuXG5cbi8vIE9wZW4gbmV3IHdpbmRvdywgb3IgZm9jdXMgaWYgb25lIHdpdGggdGhlIHNhbWUgdGl0bGUgYWxyZWFkeSBleGlzdHNcbmV4cG9ydCBpbnRlcmZhY2UgV2luZG93T3BlbmVyUGFyYW1zIHtcbiAgdGl0bGU6IHN0cmluZyxcbiAgdXJsPzogc3RyaW5nLFxuICBjb21wb25lbnQ/OiBzdHJpbmcsXG4gIGNvbXBvbmVudFBhcmFtcz86IHN0cmluZyxcbiAgZGltZW5zaW9ucz86IHsgbWluSGVpZ2h0PzogbnVtYmVyLCBtaW5XaWR0aD86IG51bWJlciwgd2lkdGg/OiBudW1iZXIsIGhlaWdodD86IG51bWJlciB9LFxuICBmcmFtZWxlc3M/OiBib29sZWFuLFxuICB3aW5QYXJhbXM/OiBhbnksXG4gIG1lbnVUZW1wbGF0ZT86IE1lbnVJdGVtQ29uc3RydWN0b3JPcHRpb25zW10sXG4gIGlnbm9yZUNhY2hlPzogYm9vbGVhbixcbn1cbmV4cG9ydCB0eXBlIFdpbmRvd09wZW5lciA9IChwcm9wczogV2luZG93T3BlbmVyUGFyYW1zKSA9PiBQcm9taXNlPEJyb3dzZXJXaW5kb3c+O1xuZXhwb3J0IGNvbnN0IG9wZW5XaW5kb3c6IFdpbmRvd09wZW5lciA9IGFzeW5jICh7XG4gICAgdGl0bGUsXG4gICAgdXJsLCBjb21wb25lbnQsIGNvbXBvbmVudFBhcmFtcyxcbiAgICBkaW1lbnNpb25zLCBmcmFtZWxlc3MsXG4gICAgd2luUGFyYW1zLCBtZW51VGVtcGxhdGUsIGlnbm9yZUNhY2hlIH0pID0+IHtcblxuICBpZiAoKGNvbXBvbmVudCB8fCAnJykudHJpbSgpID09PSAnJyAmJiAodXJsIHx8ICcnKS50cmltKCkgPT09ICcnKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwib3BlbldpbmRvdygpIHJlcXVpcmVzIGVpdGhlciBgY29tcG9uZW50YCBvciBgdXJsYFwiKTtcbiAgfVxuXG4gIGNvbnN0IF9leGlzdGluZ1dpbmRvdyA9IGdldFdpbmRvd0J5VGl0bGUodGl0bGUpO1xuICBpZiAoX2V4aXN0aW5nV2luZG93ICE9PSB1bmRlZmluZWQpIHtcbiAgICBfZXhpc3RpbmdXaW5kb3cuZm9jdXMoKTtcbiAgICByZXR1cm4gX2V4aXN0aW5nV2luZG93O1xuICB9XG5cbiAgY29uc3QgX2ZyYW1lbGVzc09wdHMgPSB7XG4gICAgdGl0bGVCYXJTdHlsZTogaXNNYWNPUyA/ICdoaWRkZW5JbnNldCcgOiB1bmRlZmluZWQsXG4gIH07XG5cbiAgY29uc3QgX3dpblBhcmFtcyA9IHtcbiAgICB3aWR0aDogKGRpbWVuc2lvbnMgfHwge30pLndpZHRoLFxuICAgIG1pbldpZHRoOiAoZGltZW5zaW9ucyB8fCB7fSkubWluV2lkdGgsXG4gICAgaGVpZ2h0OiAoZGltZW5zaW9ucyB8fCB7fSkuaGVpZ2h0LFxuICAgIG1pbkhlaWdodDogKGRpbWVuc2lvbnMgfHwge30pLm1pbkhlaWdodCxcbiAgICAuLi4oZnJhbWVsZXNzID09PSB0cnVlID8gX2ZyYW1lbGVzc09wdHMgOiB7fSksXG4gICAgLi4ud2luUGFyYW1zLFxuICB9O1xuXG4gIGxldCB3aW5kb3c6IEJyb3dzZXJXaW5kb3c7XG5cbiAgaWYgKGNvbXBvbmVudCkge1xuICAgIGNvbnN0IHBhcmFtcyA9IGBjPSR7Y29tcG9uZW50fSYke2NvbXBvbmVudFBhcmFtcyA/IGNvbXBvbmVudFBhcmFtcyA6ICcnfWA7XG4gICAgd2luZG93ID0gYXdhaXQgY3JlYXRlV2luZG93Rm9yTG9jYWxDb21wb25lbnQodGl0bGUsIHBhcmFtcywgX3dpblBhcmFtcyk7XG4gIH0gZWxzZSBpZiAodXJsKSB7XG4gICAgd2luZG93ID0gYXdhaXQgY3JlYXRlV2luZG93KHRpdGxlLCB1cmwsIF93aW5QYXJhbXMsIGlnbm9yZUNhY2hlKTtcbiAgfSBlbHNlIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJFaXRoZXIgY29tcG9uZW50IG9yIHVybCBtdXN0IGJlIGdpdmVuIHRvIG9wZW5XaW5kb3coKVwiKTtcbiAgfVxuXG4gIGlmIChtZW51VGVtcGxhdGUgJiYgIWlzTWFjT1MpIHtcbiAgICB3aW5kb3cuc2V0TWVudShNZW51LmJ1aWxkRnJvbVRlbXBsYXRlKG1lbnVUZW1wbGF0ZSkpO1xuICB9XG5cbiAgd2luZG93cy5wdXNoKHdpbmRvdyk7XG4gIHdpbmRvd3NCeVRpdGxlW3RpdGxlXSA9IHdpbmRvdztcbiAgd2luZG93Lm9uKCdjbG9zZWQnLCAoKSA9PiB7IGRlbGV0ZSB3aW5kb3dzQnlUaXRsZVt0aXRsZV07IGNsZWFuVXBXaW5kb3dzKCk7IH0pO1xuXG4gIHJldHVybiB3aW5kb3c7XG59XG5cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFdpbmRvd0J5VGl0bGUodGl0bGU6IHN0cmluZyk6IEJyb3dzZXJXaW5kb3cgfCB1bmRlZmluZWQge1xuICByZXR1cm4gd2luZG93c0J5VGl0bGVbdGl0bGVdO1xufVxuXG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRXaW5kb3coZnVuYzogKHdpbjogQnJvd3NlcldpbmRvdykgPT4gYm9vbGVhbik6IEJyb3dzZXJXaW5kb3cgfCB1bmRlZmluZWQge1xuICByZXR1cm4gd2luZG93cy5maW5kKGZ1bmMpO1xufVxuXG5cbi8vIEl0ZXJhdGUgb3ZlciBhcnJheSBvZiB3aW5kb3dzIGFuZCB0cnkgYWNjZXNzaW5nIHdpbmRvdyBJRC5cbi8vIElmIGl0IHRocm93cywgd2luZG93IHdhcyBjbG9zZWQgYW5kIHdlIHJlbW92ZSBpdCBmcm9tIHRoZSBhcnJheS5cbi8vIFN1cHBvc2VkIHRvIGJlIHJ1biBhZnRlciBhbnkgd2luZG93IGlzIGNsb3NlZFxuZnVuY3Rpb24gY2xlYW5VcFdpbmRvd3MoKSB7XG4gIHZhciBkZWxldGVkV2luZG93czogbnVtYmVyW10gPSBbXTtcbiAgZm9yIChjb25zdCBbaWR4LCB3aW5dIG9mIHdpbmRvd3MuZW50cmllcygpKSB7XG4gICAgLy8gV2hlbiBhY2Nlc3NpbmcgdGhlIGlkIGF0dHJpYnV0ZSBvZiBhIGNsb3NlZCB3aW5kb3csXG4gICAgLy8gaXTigJlsbCB0aHJvdy4gV2XigJlsbCBtYXJrIGl0cyBpbmRleCBmb3IgZGVsZXRpb24gdGhlbi5cbiAgICB0cnkge1xuICAgICAgd2luLmlkO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGRlbGV0ZWRXaW5kb3dzLnB1c2goaWR4IC0gZGVsZXRlZFdpbmRvd3MubGVuZ3RoKTtcbiAgICB9XG4gIH1cbiAgZm9yIChjb25zdCBpZHggb2YgZGVsZXRlZFdpbmRvd3MpIHtcbiAgICB3aW5kb3dzLnNwbGljZShpZHgsIDEpO1xuICB9XG59XG5cblxuZnVuY3Rpb24gY3JlYXRlV2luZG93Rm9yTG9jYWxDb21wb25lbnQodGl0bGU6IHN0cmluZywgcGFyYW1zOiBzdHJpbmcsIHdpblBhcmFtczogYW55KTogUHJvbWlzZTxCcm93c2VyV2luZG93PiB7XG4gIGxldCB1cmw6IHN0cmluZztcblxuICBpZiAoaXNEZXZlbG9wbWVudCkge1xuICAgIHVybCA9IGBodHRwOi8vbG9jYWxob3N0OiR7cHJvY2Vzcy5lbnYuRUxFQ1RST05fV0VCUEFDS19XRFNfUE9SVH0/JHtwYXJhbXN9YDtcbiAgfVxuICBlbHNlIHtcbiAgICB1cmwgPSBgJHtmb3JtYXRVcmwoe1xuICAgICAgcGF0aG5hbWU6IHBhdGguam9pbihfX2Rpcm5hbWUsICdpbmRleC5odG1sJyksXG4gICAgICBwcm90b2NvbDogJ2ZpbGUnLFxuICAgICAgc2xhc2hlczogdHJ1ZSxcbiAgICB9KX0/JHtwYXJhbXN9YDtcbiAgfVxuXG4gIHJldHVybiBjcmVhdGVXaW5kb3codGl0bGUsIHVybCwgd2luUGFyYW1zKTtcbn1cblxuXG5mdW5jdGlvbiBjcmVhdGVXaW5kb3codGl0bGU6IHN0cmluZywgdXJsOiBzdHJpbmcsIHdpblBhcmFtczogYW55LCBpZ25vcmVDYWNoZTogYm9vbGVhbiA9IGZhbHNlKTogUHJvbWlzZTxCcm93c2VyV2luZG93PiB7XG4gIGNvbnN0IHdpbmRvdyA9IG5ldyBCcm93c2VyV2luZG93KHtcbiAgICB3ZWJQcmVmZXJlbmNlczoge25vZGVJbnRlZ3JhdGlvbjogdHJ1ZX0sXG4gICAgdGl0bGU6IHRpdGxlLFxuICAgIHNob3c6IGZhbHNlLFxuICAgIC4uLndpblBhcmFtc1xuICB9KTtcblxuICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2U8QnJvd3NlcldpbmRvdz4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIHdpbmRvdy5vbmNlKCdyZWFkeS10by1zaG93JywgKCkgPT4ge1xuICAgICAgd2luZG93LnNob3coKTtcbiAgICAgIHJlc29sdmUod2luZG93KTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgaWYgKGlzRGV2ZWxvcG1lbnQpIHtcbiAgICB3aW5kb3cud2ViQ29udGVudHMub3BlbkRldlRvb2xzKCk7XG4gIH1cblxuICBpZiAoaWdub3JlQ2FjaGUpIHtcbiAgICB3aW5kb3cubG9hZFVSTCh1cmwsIHsnZXh0cmFIZWFkZXJzJzogJ3ByYWdtYTogbm8tY2FjaGVcXG4nfSk7XG4gIH0gZWxzZSB7XG4gICAgd2luZG93LmxvYWRVUkwodXJsKTtcbiAgfVxuXG4gIHdpbmRvdy53ZWJDb250ZW50cy5vbignZGV2dG9vbHMtb3BlbmVkJywgKCkgPT4ge1xuICAgIHdpbmRvdy5mb2N1cygpO1xuICAgIHNldEltbWVkaWF0ZSgoKSA9PiB7XG4gICAgICB3aW5kb3cuZm9jdXMoKVxuICAgIH0pO1xuICB9KTtcblxuICByZXR1cm4gcHJvbWlzZTtcbn1cbiJdfQ==