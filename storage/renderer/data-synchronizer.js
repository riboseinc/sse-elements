import { remote, ipcRenderer } from 'electron';
import { clipboard } from 'electron';
import React, { useEffect, useState } from 'react';
import { H4, Card, Label, InputGroup, FormGroup, Callout, Button } from '@blueprintjs/core';
import { useSetting } from '../../settings/renderer';
import { request } from '../../api/renderer';
import styles from './data-synchronizer.scss';
export const DataSynchronizer = function ({ upstreamURL, inPreLaunchSetup }) {
    const [username, setUsername] = useState('');
    const [name, setName] = useState('');
    const [email, setEmail] = useState('');
    const [repoCfg, updateRepoCfg] = useState({
        originURL: undefined,
        name: undefined,
        email: undefined,
        username: undefined,
    });
    const url = useSetting('gitRepoUrl', '');
    const usingUpstream = url.value && url.value.trim() === upstreamURL.trim();
    let urlIsValid;
    try {
        if (url.value) {
            new URL(url.value.trim());
            urlIsValid = true;
        }
        else {
            urlIsValid = false;
        }
    }
    catch (e) {
        urlIsValid = false;
    }
    useEffect(() => {
        fetchRepoConfig();
    }, []);
    useEffect(() => {
        if (name.trim() === '' && repoCfg.name) {
            setName(repoCfg.name);
        }
        if (email.trim() === '' && repoCfg.email) {
            setEmail(repoCfg.email);
        }
        if (username.trim() === '' && repoCfg.username) {
            setUsername(repoCfg.username);
        }
    }, [name, email, username, JSON.stringify(repoCfg)]);
    const complete = (urlIsValid &&
        name.trim() != '' &&
        email.trim() != '' &&
        username.trim() != '');
    async function handleSaveAndClose() {
        if (inPreLaunchSetup) {
            // Cannot modify URL unless in pre launch
            await url.commit();
        }
        await request('git-config-set', { name, email, username });
        closeWindow();
    }
    async function handleResetURL() {
        await ipcRenderer.send('clear-setting', 'gitRepoUrl');
        remote.app.relaunch();
        remote.app.exit(0);
    }
    async function copyUpstreamRepoURL() {
        clipboard.writeText(upstreamURL);
    }
    async function fetchRepoConfig() {
        const repoCfg = await request('git-config-get');
        updateRepoCfg(repoCfg);
    }
    function closeWindow() {
        remote.getCurrentWindow().close();
    }
    return (React.createElement("div", { className: styles.dataSyncBase },
        React.createElement(Card, { key: "repoUrl", className: styles.repoUrlCard },
            React.createElement(FormGroup, { label: "Repository URL", intent: inPreLaunchSetup && !urlIsValid ? "danger" : undefined, helperText: inPreLaunchSetup
                    ? React.createElement(Callout, { intent: "primary" },
                        React.createElement("p", null, "Please enter a valid URL of the repository you have commit access to, and which is a fork of the upstream repository."),
                        React.createElement("p", null,
                            React.createElement(Button, { onClick: copyUpstreamRepoURL }, "Copy upstream repository URL")))
                    : React.createElement(Callout, { intent: "warning" }, "Note: resetting the URL will cause you to lose any unsubmitted changes.") },
                React.createElement(InputGroup, { value: url.value, placeholder: upstreamURL, disabled: inPreLaunchSetup !== true, type: "text", onChange: inPreLaunchSetup
                        ? (evt) => {
                            url.set(evt.target.value);
                        }
                        : undefined, rightElement: inPreLaunchSetup
                        ? undefined
                        : React.createElement(Button, { intent: "danger", minimal: true, title: "Reset repository URL. Note: you will lose any unsubmitted changes.", onClick: handleResetURL }, "Reset URL") }))),
        React.createElement(Card, { key: "committerInfo", className: styles.committerInfoCard },
            React.createElement(H4, null, "Committing changes as"),
            React.createElement("div", { className: styles.dataSyncRow },
                React.createElement(Label, { key: "authorName" },
                    "Author name",
                    React.createElement(InputGroup, { value: name, type: "text", onChange: (evt) => {
                            setName(evt.target.value);
                        } })),
                React.createElement(Label, { key: "authorEmail" },
                    "Author email",
                    React.createElement(InputGroup, { value: email, type: "email", onChange: (evt) => {
                            setEmail(evt.target.value);
                        } })),
                React.createElement(Label, { key: "username" },
                    "Username",
                    React.createElement(InputGroup, { value: username, type: "text", onChange: (evt) => {
                            setUsername(evt.target.value);
                        } })))),
        React.createElement("footer", { key: "actionRow", className: styles.windowAction },
            React.createElement(Button, { className: "confirm-button", key: "confirm", large: true, fill: true, intent: !usingUpstream ? "primary" : "warning", disabled: complete !== true, onClick: handleSaveAndClose },
                "Save settings using ",
                !usingUpstream ? "upstream" : "fork",
                " repository",
                inPreLaunchSetup ? " and launch" : " and close"))));
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YS1zeW5jaHJvbml6ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvc3RvcmFnZS9yZW5kZXJlci9kYXRhLXN5bmNocm9uaXplci50c3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxXQUFXLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDL0MsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUVyQyxPQUFPLEtBQUssRUFBRSxFQUFFLFNBQVMsRUFBRSxRQUFRLEVBQUUsTUFBTSxPQUFPLENBQUM7QUFDbkQsT0FBTyxFQUFFLEVBQUUsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLFVBQVUsRUFBRSxTQUFTLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBRTVGLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUNyRCxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFFN0MsT0FBTyxNQUFNLE1BQU0sMEJBQTBCLENBQUM7QUFlOUMsTUFBTSxDQUFDLE1BQU0sZ0JBQWdCLEdBQW9DLFVBQVUsRUFBRSxXQUFXLEVBQUUsZ0JBQWdCLEVBQUU7SUFDMUcsTUFBTSxDQUFDLFFBQVEsRUFBRSxXQUFXLENBQUMsR0FBRyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDN0MsTUFBTSxDQUFDLElBQUksRUFBRSxPQUFPLENBQUMsR0FBRyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDckMsTUFBTSxDQUFDLEtBQUssRUFBRSxRQUFRLENBQUMsR0FBRyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUM7SUFFdkMsTUFBTSxDQUFDLE9BQU8sRUFBRSxhQUFhLENBQUMsR0FBRyxRQUFRLENBQUM7UUFDeEMsU0FBUyxFQUFFLFNBQVM7UUFDcEIsSUFBSSxFQUFFLFNBQVM7UUFDZixLQUFLLEVBQUUsU0FBUztR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LENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLFNBQVMsRUFDOUMsUUFBUSxFQUFFLFFBQVEsS0FBSyxJQUFJLEVBQzNCLE9BQU8sRUFBRSxrQkFBa0I7O2dCQUNSLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLE1BQU07O2dCQUN4RCxnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxZQUFZLENBQ3pDLENBQ0YsQ0FDTCxDQUNQLENBQUM7QUFDSixDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyByZW1vdGUsIGlwY1JlbmRlcmVyIH0gZnJvbSAnZWxlY3Ryb24nO1xuaW1wb3J0IHsgY2xpcGJvYXJkIH0gZnJvbSAnZWxlY3Ryb24nO1xuXG5pbXBvcnQgUmVhY3QsIHsgdXNlRWZmZWN0LCB1c2VTdGF0ZSB9IGZyb20gJ3JlYWN0JztcbmltcG9ydCB7IEg0LCBDYXJkLCBMYWJlbCwgSW5wdXRHcm91cCwgRm9ybUdyb3VwLCBDYWxsb3V0LCBCdXR0b24gfSBmcm9tICdAYmx1ZXByaW50anMvY29yZSc7XG5cbmltcG9ydCB7IHVzZVNldHRpbmcgfSBmcm9tICcuLi8uLi9zZXR0aW5ncy9yZW5kZXJlcic7XG5pbXBvcnQgeyByZXF1ZXN0IH0gZnJvbSAnLi4vLi4vYXBpL3JlbmRlcmVyJztcblxuaW1wb3J0IHN0eWxlcyBmcm9tICcuL2RhdGEtc3luY2hyb25pemVyLnNjc3MnO1xuXG5cbnR5cGUgUmVwb0NvbmZpZyA9IHtcbiAgb3JpZ2luVVJMOiBzdHJpbmcgfCBudWxsIHwgdW5kZWZpbmVkLFxuICBuYW1lOiBzdHJpbmcgfCBudWxsIHwgdW5kZWZpbmVkLFxuICBlbWFpbDogc3RyaW5nIHwgbnVsbCB8IHVuZGVmaW5lZCxcbiAgdXNlcm5hbWU6IHN0cmluZyB8IG51bGwgfCB1bmRlZmluZWQsXG59O1xuXG5cbmludGVyZmFjZSBEYXRhU3luY2hyb25pemVyUHJvcHMge1xuICB1cHN0cmVhbVVSTDogc3RyaW5nLFxuICBpblByZUxhdW5jaFNldHVwOiBib29sZWFuLFxufVxuZXhwb3J0IGNvbnN0IERhdGFTeW5jaHJvbml6ZXI6IFJlYWN0LkZDPERhdGFTeW5jaHJvbml6ZXJQcm9wcz4gPSBmdW5jdGlvbiAoeyB1cHN0cmVhbVVSTCwgaW5QcmVMYXVuY2hTZXR1cCB9KSB7XG4gIGNvbnN0IFt1c2VybmFtZSwgc2V0VXNlcm5hbWVdID0gdXNlU3RhdGUoJycpO1xuICBjb25zdCBbbmFtZSwgc2V0TmFtZV0gPSB1c2VTdGF0ZSgnJyk7XG4gIGNvbnN0IFtlbWFpbCwgc2V0RW1haWxdID0gdXNlU3RhdGUoJycpO1xuXG4gIGNvbnN0IFtyZXBvQ2ZnLCB1cGRhdGVSZXBvQ2ZnXSA9IHVzZVN0YXRlKHtcbiAgICBvcmlnaW5VUkw6IHVuZGVmaW5lZCxcbiAgICBuYW1lOiB1bmRlZmluZWQsXG4gICAgZW1haWw6IHVuZGVmaW5lZCxcbiAgICB1c2VybmFtZTogdW5kZWZpbmVkLFxuICB9IGFzIFJlcG9Db25maWcpO1xuXG4gIGNvbnN0IHVybCA9IHVzZVNldHRpbmc8c3RyaW5nPignZ2l0UmVwb1VybCcsICcnKTtcblxuICBjb25zdCB1c2luZ1Vwc3RyZWFtID0gdXJsLnZhbHVlICYmIHVybC52YWx1ZS50cmltKCkgPT09IHVwc3RyZWFtVVJMLnRyaW0oKTtcbiAgbGV0IHVybElzVmFsaWQ6IGJvb2xlYW47XG4gIHRyeSB7XG4gICAgaWYgKHVybC52YWx1ZSkge1xuICAgICAgbmV3IFVSTCh1cmwudmFsdWUudHJpbSgpKTtcbiAgICAgIHVybElzVmFsaWQgPSB0cnVlO1xuICAgIH0gZWxzZSB7XG4gICAgICB1cmxJc1ZhbGlkID0gZmFsc2U7XG4gICAgfVxuICB9IGNhdGNoIChlKSB7XG4gICAgdXJsSXNWYWxpZCA9IGZhbHNlO1xuICB9XG5cbiAgdXNlRWZmZWN0KCgpID0+IHtcbiAgICBmZXRjaFJlcG9Db25maWcoKTtcbiAgfSwgW10pO1xuXG4gIHVzZUVmZmVjdCgoKSA9PiB7XG4gICAgaWYgKG5hbWUudHJpbSgpID09PSAnJyAmJiByZXBvQ2ZnLm5hbWUpIHsgc2V0TmFtZShyZXBvQ2ZnLm5hbWUpOyB9XG4gICAgaWYgKGVtYWlsLnRyaW0oKSA9PT0gJycgJiYgcmVwb0NmZy5lbWFpbCkgeyBzZXRFbWFpbChyZXBvQ2ZnLmVtYWlsKTsgfVxuICAgIGlmICh1c2VybmFtZS50cmltKCkgPT09ICcnICYmIHJlcG9DZmcudXNlcm5hbWUpIHsgc2V0VXNlcm5hbWUocmVwb0NmZy51c2VybmFtZSk7IH1cbiAgfSwgW25hbWUsIGVtYWlsLCB1c2VybmFtZSwgSlNPTi5zdHJpbmdpZnkocmVwb0NmZyldKTtcblxuICBjb25zdCBjb21wbGV0ZSA9IChcbiAgICB1cmxJc1ZhbGlkICYmXG4gICAgbmFtZS50cmltKCkgIT0gJycgJiZcbiAgICBlbWFpbC50cmltKCkgIT0gJycgJiZcbiAgICB1c2VybmFtZS50cmltKCkgIT0gJycpO1xuXG4gIGFzeW5jIGZ1bmN0aW9uIGhhbmRsZVNhdmVBbmRDbG9zZSgpIHtcbiAgICBpZiAoaW5QcmVMYXVuY2hTZXR1cCkge1xuICAgICAgLy8gQ2Fubm90IG1vZGlmeSBVUkwgdW5sZXNzIGluIHByZSBsYXVuY2hcbiAgICAgIGF3YWl0IHVybC5jb21taXQoKTtcbiAgICB9XG4gICAgYXdhaXQgcmVxdWVzdDx7IGVycm9yczogc3RyaW5nW10gfT4oJ2dpdC1jb25maWctc2V0JywgeyBuYW1lLCBlbWFpbCwgdXNlcm5hbWUgfSk7XG4gICAgY2xvc2VXaW5kb3coKTtcbiAgfVxuXG4gIGFzeW5jIGZ1bmN0aW9uIGhhbmRsZVJlc2V0VVJMKCkge1xuICAgIGF3YWl0IGlwY1JlbmRlcmVyLnNlbmQoJ2NsZWFyLXNldHRpbmcnLCAnZ2l0UmVwb1VybCcpO1xuICAgIHJlbW90ZS5hcHAucmVsYXVuY2goKTtcbiAgICByZW1vdGUuYXBwLmV4aXQoMCk7XG4gIH1cblxuICBhc3luYyBmdW5jdGlvbiBjb3B5VXBzdHJlYW1SZXBvVVJMKCkge1xuICAgIGNsaXBib2FyZC53cml0ZVRleHQodXBzdHJlYW1VUkwpO1xuICB9XG5cbiAgYXN5bmMgZnVuY3Rpb24gZmV0Y2hSZXBvQ29uZmlnKCkge1xuICAgIGNvbnN0IHJlcG9DZmcgPSBhd2FpdCByZXF1ZXN0PFJlcG9Db25maWc+KCdnaXQtY29uZmlnLWdldCcpO1xuICAgIHVwZGF0ZVJlcG9DZmcocmVwb0NmZyk7XG4gIH1cblxuICBmdW5jdGlvbiBjbG9zZVdpbmRvdygpIHtcbiAgICByZW1vdGUuZ2V0Q3VycmVudFdpbmRvdygpLmNsb3NlKCk7XG4gIH1cblxuICByZXR1cm4gKFxuICAgIDxkaXYgY2xhc3NOYW1lPXtzdHlsZXMuZGF0YVN5bmNCYXNlfT5cbiAgICAgIDxDYXJkIGtleT1cInJlcG9VcmxcIiBjbGFzc05hbWU9e3N0eWxlcy5yZXBvVXJsQ2FyZH0+XG4gICAgICAgIDxGb3JtR3JvdXBcbiAgICAgICAgICAgIGxhYmVsPVwiUmVwb3NpdG9yeSBVUkxcIlxuICAgICAgICAgICAgaW50ZW50PXtpblByZUxhdW5jaFNldHVwICYmICF1cmxJc1ZhbGlkID8gXCJkYW5nZXJcIiA6IHVuZGVmaW5lZH1cbiAgICAgICAgICAgIGhlbHBlclRleHQ9e2luUHJlTGF1bmNoU2V0dXBcbiAgICAgICAgICAgICAgPyA8Q2FsbG91dCBpbnRlbnQ9XCJwcmltYXJ5XCI+XG4gICAgICAgICAgICAgICAgICA8cD5cbiAgICAgICAgICAgICAgICAgICAgUGxlYXNlIGVudGVyIGEgdmFsaWQgVVJMIG9mIHRoZSByZXBvc2l0b3J5IHlvdSBoYXZlIGNvbW1pdCBhY2Nlc3MgdG8sXG4gICAgICAgICAgICAgICAgICAgIGFuZCB3aGljaCBpcyBhIGZvcmsgb2YgdGhlIHVwc3RyZWFtIHJlcG9zaXRvcnkuXG4gICAgICAgICAgICAgICAgICA8L3A+XG4gICAgICAgICAgICAgICAgICA8cD5cbiAgICAgICAgICAgICAgICAgICAgPEJ1dHRvbiBvbkNsaWNrPXtjb3B5VXBzdHJlYW1SZXBvVVJMfT5Db3B5IHVwc3RyZWFtIHJlcG9zaXRvcnkgVVJMPC9CdXR0b24+XG4gICAgICAgICAgICAgICAgICA8L3A+XG4gICAgICAgICAgICAgICAgPC9DYWxsb3V0PlxuICAgICAgICAgICAgICA6IDxDYWxsb3V0IGludGVudD1cIndhcm5pbmdcIj5cbiAgICAgICAgICAgICAgICAgIE5vdGU6IHJlc2V0dGluZyB0aGUgVVJMIHdpbGwgY2F1c2UgeW91IHRvIGxvc2UgYW55IHVuc3VibWl0dGVkIGNoYW5nZXMuXG4gICAgICAgICAgICAgICAgPC9DYWxsb3V0Pn0+XG4gICAgICAgICAgPElucHV0R3JvdXBcbiAgICAgICAgICAgIHZhbHVlPXt1cmwudmFsdWV9XG4gICAgICAgICAgICBwbGFjZWhvbGRlcj17dXBzdHJlYW1VUkx9XG4gICAgICAgICAgICBkaXNhYmxlZD17aW5QcmVMYXVuY2hTZXR1cCAhPT0gdHJ1ZX1cbiAgICAgICAgICAgIHR5cGU9XCJ0ZXh0XCJcbiAgICAgICAgICAgIG9uQ2hhbmdlPXtpblByZUxhdW5jaFNldHVwXG4gICAgICAgICAgICAgID8gKGV2dDogUmVhY3QuRm9ybUV2ZW50PEhUTUxFbGVtZW50PikgPT4ge1xuICAgICAgICAgICAgICAgIHVybC5zZXQoKGV2dC50YXJnZXQgYXMgSFRNTElucHV0RWxlbWVudCkudmFsdWUgYXMgc3RyaW5nKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICA6IHVuZGVmaW5lZH1cbiAgICAgICAgICAgIHJpZ2h0RWxlbWVudD17aW5QcmVMYXVuY2hTZXR1cFxuICAgICAgICAgICAgICA/IHVuZGVmaW5lZFxuICAgICAgICAgICAgICA6IDxCdXR0b25cbiAgICAgICAgICAgICAgICAgICAgaW50ZW50PVwiZGFuZ2VyXCJcbiAgICAgICAgICAgICAgICAgICAgbWluaW1hbD17dHJ1ZX1cbiAgICAgICAgICAgICAgICAgICAgdGl0bGU9XCJSZXNldCByZXBvc2l0b3J5IFVSTC4gTm90ZTogeW91IHdpbGwgbG9zZSBhbnkgdW5zdWJtaXR0ZWQgY2hhbmdlcy5cIlxuICAgICAgICAgICAgICAgICAgICBvbkNsaWNrPXtoYW5kbGVSZXNldFVSTH0+XG4gICAgICAgICAgICAgICAgICBSZXNldCBVUkxcbiAgICAgICAgICAgICAgICA8L0J1dHRvbj59XG4gICAgICAgICAgLz5cbiAgICAgICAgPC9Gb3JtR3JvdXA+XG4gICAgICA8L0NhcmQ+XG5cbiAgICAgIDxDYXJkIGtleT1cImNvbW1pdHRlckluZm9cIiBjbGFzc05hbWU9e3N0eWxlcy5jb21taXR0ZXJJbmZvQ2FyZH0+XG4gICAgICAgIDxIND5Db21taXR0aW5nIGNoYW5nZXMgYXM8L0g0PlxuXG4gICAgICAgIDxkaXYgY2xhc3NOYW1lPXtzdHlsZXMuZGF0YVN5bmNSb3d9PlxuICAgICAgICAgIDxMYWJlbCBrZXk9XCJhdXRob3JOYW1lXCI+XG4gICAgICAgICAgICBBdXRob3IgbmFtZVxuICAgICAgICAgICAgPElucHV0R3JvdXBcbiAgICAgICAgICAgICAgdmFsdWU9e25hbWV9XG4gICAgICAgICAgICAgIHR5cGU9XCJ0ZXh0XCJcbiAgICAgICAgICAgICAgb25DaGFuZ2U9eyhldnQ6IFJlYWN0LkZvcm1FdmVudDxIVE1MRWxlbWVudD4pID0+IHtcbiAgICAgICAgICAgICAgICBzZXROYW1lKChldnQudGFyZ2V0IGFzIEhUTUxJbnB1dEVsZW1lbnQpLnZhbHVlIGFzIHN0cmluZyk7XG4gICAgICAgICAgICAgIH19XG4gICAgICAgICAgICAvPlxuICAgICAgICAgIDwvTGFiZWw+XG5cbiAgICAgICAgICA8TGFiZWwga2V5PVwiYXV0aG9yRW1haWxcIj5cbiAgICAgICAgICAgIEF1dGhvciBlbWFpbFxuICAgICAgICAgICAgPElucHV0R3JvdXBcbiAgICAgICAgICAgICAgdmFsdWU9e2VtYWlsfVxuICAgICAgICAgICAgICB0eXBlPVwiZW1haWxcIlxuICAgICAgICAgICAgICBvbkNoYW5nZT17KGV2dDogUmVhY3QuRm9ybUV2ZW50PEhUTUxFbGVtZW50PikgPT4ge1xuICAgICAgICAgICAgICAgIHNldEVtYWlsKChldnQudGFyZ2V0IGFzIEhUTUxJbnB1dEVsZW1lbnQpLnZhbHVlIGFzIHN0cmluZyk7XG4gICAgICAgICAgICAgIH19XG4gICAgICAgICAgICAvPlxuICAgICAgICAgIDwvTGFiZWw+XG5cbiAgICAgICAgICA8TGFiZWwga2V5PVwidXNlcm5hbWVcIj5cbiAgICAgICAgICAgIFVzZXJuYW1lXG4gICAgICAgICAgICA8SW5wdXRHcm91cFxuICAgICAgICAgICAgICB2YWx1ZT17dXNlcm5hbWV9XG4gICAgICAgICAgICAgIHR5cGU9XCJ0ZXh0XCJcbiAgICAgICAgICAgICAgb25DaGFuZ2U9eyhldnQ6IFJlYWN0LkZvcm1FdmVudDxIVE1MRWxlbWVudD4pID0+IHtcbiAgICAgICAgICAgICAgICBzZXRVc2VybmFtZSgoZXZ0LnRhcmdldCBhcyBIVE1MSW5wdXRFbGVtZW50KS52YWx1ZSBhcyBzdHJpbmcpO1xuICAgICAgICAgICAgICB9fVxuICAgICAgICAgICAgLz5cbiAgICAgICAgICA8L0xhYmVsPlxuICAgICAgICA8L2Rpdj5cbiAgICAgIDwvQ2FyZD5cblxuICAgICAgPGZvb3RlciBrZXk9XCJhY3Rpb25Sb3dcIiBjbGFzc05hbWU9e3N0eWxlcy53aW5kb3dBY3Rpb259PlxuICAgICAgICA8QnV0dG9uXG4gICAgICAgICAgICBjbGFzc05hbWU9XCJjb25maXJtLWJ1dHRvblwiXG4gICAgICAgICAgICBrZXk9XCJjb25maXJtXCJcbiAgICAgICAgICAgIGxhcmdlPXt0cnVlfVxuICAgICAgICAgICAgZmlsbD17dHJ1ZX1cbiAgICAgICAgICAgIGludGVudD17IXVzaW5nVXBzdHJlYW0gPyBcInByaW1hcnlcIiA6IFwid2FybmluZ1wifVxuICAgICAgICAgICAgZGlzYWJsZWQ9e2NvbXBsZXRlICE9PSB0cnVlfVxuICAgICAgICAgICAgb25DbGljaz17aGFuZGxlU2F2ZUFuZENsb3NlfT5cbiAgICAgICAgICBTYXZlIHNldHRpbmdzIHVzaW5nIHshdXNpbmdVcHN0cmVhbSA/IFwidXBzdHJlYW1cIiA6IFwiZm9ya1wifSByZXBvc2l0b3J5XG4gICAgICAgICAge2luUHJlTGF1bmNoU2V0dXAgPyBcIiBhbmQgbGF1bmNoXCIgOiBcIiBhbmQgY2xvc2VcIn1cbiAgICAgICAgPC9CdXR0b24+XG4gICAgICA8L2Zvb3Rlcj5cbiAgICA8L2Rpdj5cbiAgKTtcbn07XG4iXX0=