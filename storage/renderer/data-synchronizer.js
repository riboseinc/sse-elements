import { remote, ipcRenderer } from 'electron';
import { clipboard } from 'electron';
import React, { useEffect, useState } from 'react';
import { H4, Card, Label, InputGroup, FormGroup, Callout, Button } from '@blueprintjs/core';
import { useSetting } from '../../settings/renderer';
import { request } from '../../api/renderer';
import styles from './data-synchronizer.scss';
export const DataSynchronizer = function ({ upstreamURL, inPreLaunchSetup }) {
    const [username, setUsername] = useState('');
    const [name, setName] = useState('');
    const [email, setEmail] = useState('');
    const [loading, setLoading] = useState(false);
    const [repoCfg, updateRepoCfg] = useState({
        originURL: undefined,
        name: undefined,
        email: undefined,
        username: undefined,
    });
    const url = useSetting('gitRepoUrl', '');
    const usingUpstream = url.value && url.value.trim() === upstreamURL.trim();
    let urlIsValid;
    try {
        if (url.value) {
            new URL(url.value.trim());
            urlIsValid = true;
        }
        else {
            urlIsValid = false;
        }
    }
    catch (e) {
        urlIsValid = false;
    }
    useEffect(() => {
        fetchRepoConfig();
    }, []);
    useEffect(() => {
        if (name.trim() === '' && repoCfg.name) {
            setName(repoCfg.name);
        }
        if (email.trim() === '' && repoCfg.email) {
            setEmail(repoCfg.email);
        }
        if (username.trim() === '' && repoCfg.username) {
            setUsername(repoCfg.username);
        }
    }, [name, email, username, JSON.stringify(repoCfg)]);
    const complete = (urlIsValid &&
        name.trim() != '' &&
        email.trim() != '' &&
        username.trim() != '');
    async function updateGitConfigAndClose() {
        await request('git-config-set', { name, email, username });
        await closeWindow();
    }
    async function handleSaveAndClose() {
        setLoading(true);
        // In pre launch we can modify URL, but updating Git config requires waiting for the app to load,
        // initializing the repo
        if (inPreLaunchSetup) {
            await url.commit();
            ipcRenderer.on('app-loaded', updateGitConfigAndClose);
        }
        else {
            await updateGitConfigAndClose();
        }
    }
    async function handleResetURL() {
        await ipcRenderer.send('clear-setting', 'gitRepoUrl');
        remote.app.relaunch();
        remote.app.exit(0);
    }
    async function copyUpstreamRepoURL() {
        clipboard.writeText(upstreamURL);
    }
    async function fetchRepoConfig() {
        const repoCfg = await request('git-config-get');
        updateRepoCfg(repoCfg);
    }
    async function closeWindow() {
        await remote.getCurrentWindow().close();
    }
    return (React.createElement("div", { className: styles.dataSyncBase },
        React.createElement(Card, { key: "repoUrl", className: styles.repoUrlCard },
            React.createElement(FormGroup, { label: "Repository URL", intent: inPreLaunchSetup && !urlIsValid ? "danger" : undefined, helperText: inPreLaunchSetup
                    ? React.createElement(Callout, { intent: "primary" },
                        React.createElement("p", null, "Please enter a valid URL of the repository you have commit access to, and which is a fork of the upstream repository."),
                        React.createElement("p", null,
                            React.createElement(Button, { onClick: copyUpstreamRepoURL }, "Copy upstream repository URL")))
                    : React.createElement(Callout, { intent: "warning" }, "Note: resetting the URL will cause you to lose any unsubmitted changes.") },
                React.createElement(InputGroup, { value: url.value, placeholder: upstreamURL, disabled: inPreLaunchSetup !== true, type: "text", onChange: inPreLaunchSetup
                        ? (evt) => {
                            url.set(evt.target.value);
                        }
                        : undefined, rightElement: inPreLaunchSetup
                        ? undefined
                        : React.createElement(Button, { intent: "danger", minimal: true, title: "Reset repository URL. Note: you will lose any unsubmitted changes.", onClick: handleResetURL }, "Reset URL") }))),
        React.createElement(Card, { key: "committerInfo", className: styles.committerInfoCard },
            React.createElement(H4, null, "Committing changes as"),
            React.createElement("div", { className: styles.dataSyncRow },
                React.createElement(Label, { key: "authorName" },
                    "Author name",
                    React.createElement(InputGroup, { value: name, type: "text", onChange: (evt) => {
                            setName(evt.target.value);
                        } })),
                React.createElement(Label, { key: "authorEmail" },
                    "Author email",
                    React.createElement(InputGroup, { value: email, type: "email", onChange: (evt) => {
                            setEmail(evt.target.value);
                        } })),
                React.createElement(Label, { key: "username" },
                    "Username",
                    React.createElement(InputGroup, { value: username, type: "text", onChange: (evt) => {
                            setUsername(evt.target.value);
                        } })))),
        React.createElement("footer", { key: "actionRow", className: styles.windowAction },
            React.createElement(Button, { className: "confirm-button", key: "confirm", large: true, fill: true, intent: !usingUpstream ? "primary" : "warning", loading: loading === true, disabled: complete !== true, onClick: handleSaveAndClose }, inPreLaunchSetup
                ? React.createElement(React.Fragment, null,
                    "Save settings using ",
                    usingUpstream ? "upstream" : "fork",
                    " repository and launch")
                : React.createElement(React.Fragment, null, "Save and close")))));
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YS1zeW5jaHJvbml6ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvc3RvcmFnZS9yZW5kZXJlci9kYXRhLXN5bmNocm9uaXplci50c3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxXQUFXLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDL0MsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUVyQyxPQUFPLEtBQUssRUFBRSxFQUFFLFNBQVMsRUFBRSxRQUFRLEVBQUUsTUFBTSxPQUFPLENBQUM7QUFDbkQsT0FBTyxFQUFFLEVBQUUsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLFVBQVUsRUFBRSxTQUFTLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBRTVGLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUNyRCxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFFN0MsT0FBTyxNQUFNLE1BQU0sMEJBQTBCLENBQUM7QUFlOUMsTUFBTSxDQUFDLE1BQU0sZ0JBQWdCLEdBQW9DLFVBQVUsRUFBRSxXQUFXLEVBQUUsZ0JBQWdCLEVBQUU7SUFDMUcsTUFBTSxDQUFDLFFBQVEsRUFBRSxXQUFXLENBQUMsR0FBRyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDN0MsTUFBTSxDQUFDLElBQUksRUFBRSxPQUFPLENBQUMsR0FBRyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDckMsTUFBTSxDQUFDLEtBQUssRUFBRSxRQUFRLENBQUMsR0FBRyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDdkMsTUFBTSxDQUFDLE9BQU8sRUFBRSxVQUFVLENBQUMsR0FBRyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUM7SUFFOUMsTUFBTSxDQUFDLE9BQU8sRUFBRSxhQUFhLENBQUMsR0FBRyxRQUFRLENB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LENBQUMsTUFBMkIsQ0FBQyxLQUFlLENBQUMsQ0FBQzt3QkFDaEUsQ0FBQyxHQUNELENBQ0ksQ0FDSixDQUNEO1FBRVAsZ0NBQVEsR0FBRyxFQUFDLFdBQVcsRUFBQyxTQUFTLEVBQUUsTUFBTSxDQUFDLFlBQVk7WUFDcEQsb0JBQUMsTUFBTSxJQUNILFNBQVMsRUFBQyxnQkFBZ0IsRUFDMUIsR0FBRyxFQUFDLFNBQVMsRUFDYixLQUFLLEVBQUUsSUFBSSxFQUNYLElBQUksRUFBRSxJQUFJLEVBQ1YsTUFBTSxFQUFFLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLFNBQVMsRUFDOUMsT0FBTyxFQUFFLE9BQU8sS0FBSyxJQUFJLEVBQ3pCLFFBQVEsRUFBRSxRQUFRLEtBQUssSUFBSSxFQUMzQixPQUFPLEVBQUUsa0JBQWtCLElBQzVCLGdCQUFnQjtnQkFDZixDQUFDLENBQUM7O29CQUF1QixhQUFhLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsTUFBTTs2Q0FBMEI7Z0JBQ3RGLENBQUMsQ0FBQywyREFBbUIsQ0FDaEIsQ0FDRixDQUNMLENBQ1AsQ0FBQztBQUNKLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHJlbW90ZSwgaXBjUmVuZGVyZXIgfSBmcm9tICdlbGVjdHJvbic7XG5pbXBvcnQgeyBjbGlwYm9hcmQgfSBmcm9tICdlbGVjdHJvbic7XG5cbmltcG9ydCBSZWFjdCwgeyB1c2VFZmZlY3QsIHVzZVN0YXRlIH0gZnJvbSAncmVhY3QnO1xuaW1wb3J0IHsgSDQsIENhcmQsIExhYmVsLCBJbnB1dEdyb3VwLCBGb3JtR3JvdXAsIENhbGxvdXQsIEJ1dHRvbiB9IGZyb20gJ0BibHVlcHJpbnRqcy9jb3JlJztcblxuaW1wb3J0IHsgdXNlU2V0dGluZyB9IGZyb20gJy4uLy4uL3NldHRpbmdzL3JlbmRlcmVyJztcbmltcG9ydCB7IHJlcXVlc3QgfSBmcm9tICcuLi8uLi9hcGkvcmVuZGVyZXInO1xuXG5pbXBvcnQgc3R5bGVzIGZyb20gJy4vZGF0YS1zeW5jaHJvbml6ZXIuc2Nzcyc7XG5cblxudHlwZSBSZXBvQ29uZmlnID0ge1xuICBvcmlnaW5VUkw6IHN0cmluZyB8IG51bGwgfCB1bmRlZmluZWQsXG4gIG5hbWU6IHN0cmluZyB8IG51bGwgfCB1bmRlZmluZWQsXG4gIGVtYWlsOiBzdHJpbmcgfCBudWxsIHwgdW5kZWZpbmVkLFxuICB1c2VybmFtZTogc3RyaW5nIHwgbnVsbCB8IHVuZGVmaW5lZCxcbn07XG5cblxuaW50ZXJmYWNlIERhdGFTeW5jaHJvbml6ZXJQcm9wcyB7XG4gIHVwc3RyZWFtVVJMOiBzdHJpbmcsXG4gIGluUHJlTGF1bmNoU2V0dXA6IGJvb2xlYW4sXG59XG5leHBvcnQgY29uc3QgRGF0YVN5bmNocm9uaXplcjogUmVhY3QuRkM8RGF0YVN5bmNocm9uaXplclByb3BzPiA9IGZ1bmN0aW9uICh7IHVwc3RyZWFtVVJMLCBpblByZUxhdW5jaFNldHVwIH0pIHtcbiAgY29uc3QgW3VzZXJuYW1lLCBzZXRVc2VybmFtZV0gPSB1c2VTdGF0ZSgnJyk7XG4gIGNvbnN0IFtuYW1lLCBzZXROYW1lXSA9IHVzZVN0YXRlKCcnKTtcbiAgY29uc3QgW2VtYWlsLCBzZXRFbWFpbF0gPSB1c2VTdGF0ZSgnJyk7XG4gIGNvbnN0IFtsb2FkaW5nLCBzZXRMb2FkaW5nXSA9IHVzZVN0YXRlKGZhbHNlKTtcblxuICBjb25zdCBbcmVwb0NmZywgdXBkYXRlUmVwb0NmZ10gPSB1c2VTdGF0ZSh7XG4gICAgb3JpZ2luVVJMOiB1bmRlZmluZWQsXG4gICAgbmFtZTogdW5kZWZpbmVkLFxuICAgIGVtYWlsOiB1bmRlZmluZWQsXG4gICAgdXNlcm5hbWU6IHVuZGVmaW5lZCxcbiAgfSBhcyBSZXBvQ29uZmlnKTtcblxuICBjb25zdCB1cmwgPSB1c2VTZXR0aW5nPHN0cmluZz4oJ2dpdFJlcG9VcmwnLCAnJyk7XG5cbiAgY29uc3QgdXNpbmdVcHN0cmVhbSA9IHVybC52YWx1ZSAmJiB1cmwudmFsdWUudHJpbSgpID09PSB1cHN0cmVhbVVSTC50cmltKCk7XG4gIGxldCB1cmxJc1ZhbGlkOiBib29sZWFuO1xuICB0cnkge1xuICAgIGlmICh1cmwudmFsdWUpIHtcbiAgICAgIG5ldyBVUkwodXJsLnZhbHVlLnRyaW0oKSk7XG4gICAgICB1cmxJc1ZhbGlkID0gdHJ1ZTtcbiAgICB9IGVsc2Uge1xuICAgICAgdXJsSXNWYWxpZCA9IGZhbHNlO1xuICAgIH1cbiAgfSBjYXRjaCAoZSkge1xuICAgIHVybElzVmFsaWQgPSBmYWxzZTtcbiAgfVxuXG4gIHVzZUVmZmVjdCgoKSA9PiB7XG4gICAgZmV0Y2hSZXBvQ29uZmlnKCk7XG4gIH0sIFtdKTtcblxuICB1c2VFZmZlY3QoKCkgPT4ge1xuICAgIGlmIChuYW1lLnRyaW0oKSA9PT0gJycgJiYgcmVwb0NmZy5uYW1lKSB7IHNldE5hbWUocmVwb0NmZy5uYW1lKTsgfVxuICAgIGlmIChlbWFpbC50cmltKCkgPT09ICcnICYmIHJlcG9DZmcuZW1haWwpIHsgc2V0RW1haWwocmVwb0NmZy5lbWFpbCk7IH1cbiAgICBpZiAodXNlcm5hbWUudHJpbSgpID09PSAnJyAmJiByZXBvQ2ZnLnVzZXJuYW1lKSB7IHNldFVzZXJuYW1lKHJlcG9DZmcudXNlcm5hbWUpOyB9XG4gIH0sIFtuYW1lLCBlbWFpbCwgdXNlcm5hbWUsIEpTT04uc3RyaW5naWZ5KHJlcG9DZmcpXSk7XG5cbiAgY29uc3QgY29tcGxldGUgPSAoXG4gICAgdXJsSXNWYWxpZCAmJlxuICAgIG5hbWUudHJpbSgpICE9ICcnICYmXG4gICAgZW1haWwudHJpbSgpICE9ICcnICYmXG4gICAgdXNlcm5hbWUudHJpbSgpICE9ICcnKTtcblxuICBhc3luYyBmdW5jdGlvbiB1cGRhdGVHaXRDb25maWdBbmRDbG9zZSgpIHtcbiAgICBhd2FpdCByZXF1ZXN0PHsgc3VjY2VzczogdHJ1ZSB9PignZ2l0LWNvbmZpZy1zZXQnLCB7IG5hbWUsIGVtYWlsLCB1c2VybmFtZSB9KTtcbiAgICBhd2FpdCBjbG9zZVdpbmRvdygpO1xuICB9XG5cbiAgYXN5bmMgZnVuY3Rpb24gaGFuZGxlU2F2ZUFuZENsb3NlKCkge1xuICAgIHNldExvYWRpbmcodHJ1ZSk7XG5cbiAgICAvLyBJbiBwcmUgbGF1bmNoIHdlIGNhbiBtb2RpZnkgVVJMLCBidXQgdXBkYXRpbmcgR2l0IGNvbmZpZyByZXF1aXJlcyB3YWl0aW5nIGZvciB0aGUgYXBwIHRvIGxvYWQsXG4gICAgLy8gaW5pdGlhbGl6aW5nIHRoZSByZXBvXG4gICAgaWYgKGluUHJlTGF1bmNoU2V0dXApIHtcbiAgICAgIGF3YWl0IHVybC5jb21taXQoKTtcbiAgICAgIGlwY1JlbmRlcmVyLm9uKCdhcHAtbG9hZGVkJywgdXBkYXRlR2l0Q29uZmlnQW5kQ2xvc2UpO1xuICAgIH0gZWxzZSB7XG4gICAgICBhd2FpdCB1cGRhdGVHaXRDb25maWdBbmRDbG9zZSgpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGZ1bmN0aW9uIGhhbmRsZVJlc2V0VVJMKCkge1xuICAgIGF3YWl0IGlwY1JlbmRlcmVyLnNlbmQoJ2NsZWFyLXNldHRpbmcnLCAnZ2l0UmVwb1VybCcpO1xuICAgIHJlbW90ZS5hcHAucmVsYXVuY2goKTtcbiAgICByZW1vdGUuYXBwLmV4aXQoMCk7XG4gIH1cblxuICBhc3luYyBmdW5jdGlvbiBjb3B5VXBzdHJlYW1SZXBvVVJMKCkge1xuICAgIGNsaXBib2FyZC53cml0ZVRleHQodXBzdHJlYW1VUkwpO1xuICB9XG5cbiAgYXN5bmMgZnVuY3Rpb24gZmV0Y2hSZXBvQ29uZmlnKCkge1xuICAgIGNvbnN0IHJlcG9DZmcgPSBhd2FpdCByZXF1ZXN0PFJlcG9Db25maWc+KCdnaXQtY29uZmlnLWdldCcpO1xuICAgIHVwZGF0ZVJlcG9DZmcocmVwb0NmZyk7XG4gIH1cblxuICBhc3luYyBmdW5jdGlvbiBjbG9zZVdpbmRvdygpIHtcbiAgICBhd2FpdCByZW1vdGUuZ2V0Q3VycmVudFdpbmRvdygpLmNsb3NlKCk7XG4gIH1cblxuICByZXR1cm4gKFxuICAgIDxkaXYgY2xhc3NOYW1lPXtzdHlsZXMuZGF0YVN5bmNCYXNlfT5cbiAgICAgIDxDYXJkIGtleT1cInJlcG9VcmxcIiBjbGFzc05hbWU9e3N0eWxlcy5yZXBvVXJsQ2FyZH0+XG4gICAgICAgIDxGb3JtR3JvdXBcbiAgICAgICAgICAgIGxhYmVsPVwiUmVwb3NpdG9yeSBVUkxcIlxuICAgICAgICAgICAgaW50ZW50PXtpblByZUxhdW5jaFNldHVwICYmICF1cmxJc1ZhbGlkID8gXCJkYW5nZXJcIiA6IHVuZGVmaW5lZH1cbiAgICAgICAgICAgIGhlbHBlclRleHQ9e2luUHJlTGF1bmNoU2V0dXBcbiAgICAgICAgICAgICAgPyA8Q2FsbG91dCBpbnRlbnQ9XCJwcmltYXJ5XCI+XG4gICAgICAgICAgICAgICAgICA8cD5cbiAgICAgICAgICAgICAgICAgICAgUGxlYXNlIGVudGVyIGEgdmFsaWQgVVJMIG9mIHRoZSByZXBvc2l0b3J5IHlvdSBoYXZlIGNvbW1pdCBhY2Nlc3MgdG8sXG4gICAgICAgICAgICAgICAgICAgIGFuZCB3aGljaCBpcyBhIGZvcmsgb2YgdGhlIHVwc3RyZWFtIHJlcG9zaXRvcnkuXG4gICAgICAgICAgICAgICAgICA8L3A+XG4gICAgICAgICAgICAgICAgICA8cD5cbiAgICAgICAgICAgICAgICAgICAgPEJ1dHRvbiBvbkNsaWNrPXtjb3B5VXBzdHJlYW1SZXBvVVJMfT5Db3B5IHVwc3RyZWFtIHJlcG9zaXRvcnkgVVJMPC9CdXR0b24+XG4gICAgICAgICAgICAgICAgICA8L3A+XG4gICAgICAgICAgICAgICAgPC9DYWxsb3V0PlxuICAgICAgICAgICAgICA6IDxDYWxsb3V0IGludGVudD1cIndhcm5pbmdcIj5cbiAgICAgICAgICAgICAgICAgIE5vdGU6IHJlc2V0dGluZyB0aGUgVVJMIHdpbGwgY2F1c2UgeW91IHRvIGxvc2UgYW55IHVuc3VibWl0dGVkIGNoYW5nZXMuXG4gICAgICAgICAgICAgICAgPC9DYWxsb3V0Pn0+XG4gICAgICAgICAgPElucHV0R3JvdXBcbiAgICAgICAgICAgIHZhbHVlPXt1cmwudmFsdWV9XG4gICAgICAgICAgICBwbGFjZWhvbGRlcj17dXBzdHJlYW1VUkx9XG4gICAgICAgICAgICBkaXNhYmxlZD17aW5QcmVMYXVuY2hTZXR1cCAhPT0gdHJ1ZX1cbiAgICAgICAgICAgIHR5cGU9XCJ0ZXh0XCJcbiAgICAgICAgICAgIG9uQ2hhbmdlPXtpblByZUxhdW5jaFNldHVwXG4gICAgICAgICAgICAgID8gKGV2dDogUmVhY3QuRm9ybUV2ZW50PEhUTUxFbGVtZW50PikgPT4ge1xuICAgICAgICAgICAgICAgIHVybC5zZXQoKGV2dC50YXJnZXQgYXMgSFRNTElucHV0RWxlbWVudCkudmFsdWUgYXMgc3RyaW5nKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICA6IHVuZGVmaW5lZH1cbiAgICAgICAgICAgIHJpZ2h0RWxlbWVudD17aW5QcmVMYXVuY2hTZXR1cFxuICAgICAgICAgICAgICA/IHVuZGVmaW5lZFxuICAgICAgICAgICAgICA6IDxCdXR0b25cbiAgICAgICAgICAgICAgICAgICAgaW50ZW50PVwiZGFuZ2VyXCJcbiAgICAgICAgICAgICAgICAgICAgbWluaW1hbD17dHJ1ZX1cbiAgICAgICAgICAgICAgICAgICAgdGl0bGU9XCJSZXNldCByZXBvc2l0b3J5IFVSTC4gTm90ZTogeW91IHdpbGwgbG9zZSBhbnkgdW5zdWJtaXR0ZWQgY2hhbmdlcy5cIlxuICAgICAgICAgICAgICAgICAgICBvbkNsaWNrPXtoYW5kbGVSZXNldFVSTH0+XG4gICAgICAgICAgICAgICAgICBSZXNldCBVUkxcbiAgICAgICAgICAgICAgICA8L0J1dHRvbj59XG4gICAgICAgICAgLz5cbiAgICAgICAgPC9Gb3JtR3JvdXA+XG4gICAgICA8L0NhcmQ+XG5cbiAgICAgIDxDYXJkIGtleT1cImNvbW1pdHRlckluZm9cIiBjbGFzc05hbWU9e3N0eWxlcy5jb21taXR0ZXJJbmZvQ2FyZH0+XG4gICAgICAgIDxIND5Db21taXR0aW5nIGNoYW5nZXMgYXM8L0g0PlxuXG4gICAgICAgIDxkaXYgY2xhc3NOYW1lPXtzdHlsZXMuZGF0YVN5bmNSb3d9PlxuICAgICAgICAgIDxMYWJlbCBrZXk9XCJhdXRob3JOYW1lXCI+XG4gICAgICAgICAgICBBdXRob3IgbmFtZVxuICAgICAgICAgICAgPElucHV0R3JvdXBcbiAgICAgICAgICAgICAgdmFsdWU9e25hbWV9XG4gICAgICAgICAgICAgIHR5cGU9XCJ0ZXh0XCJcbiAgICAgICAgICAgICAgb25DaGFuZ2U9eyhldnQ6IFJlYWN0LkZvcm1FdmVudDxIVE1MRWxlbWVudD4pID0+IHtcbiAgICAgICAgICAgICAgICBzZXROYW1lKChldnQudGFyZ2V0IGFzIEhUTUxJbnB1dEVsZW1lbnQpLnZhbHVlIGFzIHN0cmluZyk7XG4gICAgICAgICAgICAgIH19XG4gICAgICAgICAgICAvPlxuICAgICAgICAgIDwvTGFiZWw+XG5cbiAgICAgICAgICA8TGFiZWwga2V5PVwiYXV0aG9yRW1haWxcIj5cbiAgICAgICAgICAgIEF1dGhvciBlbWFpbFxuICAgICAgICAgICAgPElucHV0R3JvdXBcbiAgICAgICAgICAgICAgdmFsdWU9e2VtYWlsfVxuICAgICAgICAgICAgICB0eXBlPVwiZW1haWxcIlxuICAgICAgICAgICAgICBvbkNoYW5nZT17KGV2dDogUmVhY3QuRm9ybUV2ZW50PEhUTUxFbGVtZW50PikgPT4ge1xuICAgICAgICAgICAgICAgIHNldEVtYWlsKChldnQudGFyZ2V0IGFzIEhUTUxJbnB1dEVsZW1lbnQpLnZhbHVlIGFzIHN0cmluZyk7XG4gICAgICAgICAgICAgIH19XG4gICAgICAgICAgICAvPlxuICAgICAgICAgIDwvTGFiZWw+XG5cbiAgICAgICAgICA8TGFiZWwga2V5PVwidXNlcm5hbWVcIj5cbiAgICAgICAgICAgIFVzZXJuYW1lXG4gICAgICAgICAgICA8SW5wdXRHcm91cFxuICAgICAgICAgICAgICB2YWx1ZT17dXNlcm5hbWV9XG4gICAgICAgICAgICAgIHR5cGU9XCJ0ZXh0XCJcbiAgICAgICAgICAgICAgb25DaGFuZ2U9eyhldnQ6IFJlYWN0LkZvcm1FdmVudDxIVE1MRWxlbWVudD4pID0+IHtcbiAgICAgICAgICAgICAgICBzZXRVc2VybmFtZSgoZXZ0LnRhcmdldCBhcyBIVE1MSW5wdXRFbGVtZW50KS52YWx1ZSBhcyBzdHJpbmcpO1xuICAgICAgICAgICAgICB9fVxuICAgICAgICAgICAgLz5cbiAgICAgICAgICA8L0xhYmVsPlxuICAgICAgICA8L2Rpdj5cbiAgICAgIDwvQ2FyZD5cblxuICAgICAgPGZvb3RlciBrZXk9XCJhY3Rpb25Sb3dcIiBjbGFzc05hbWU9e3N0eWxlcy53aW5kb3dBY3Rpb259PlxuICAgICAgICA8QnV0dG9uXG4gICAgICAgICAgICBjbGFzc05hbWU9XCJjb25maXJtLWJ1dHRvblwiXG4gICAgICAgICAgICBrZXk9XCJjb25maXJtXCJcbiAgICAgICAgICAgIGxhcmdlPXt0cnVlfVxuICAgICAgICAgICAgZmlsbD17dHJ1ZX1cbiAgICAgICAgICAgIGludGVudD17IXVzaW5nVXBzdHJlYW0gPyBcInByaW1hcnlcIiA6IFwid2FybmluZ1wifVxuICAgICAgICAgICAgbG9hZGluZz17bG9hZGluZyA9PT0gdHJ1ZX1cbiAgICAgICAgICAgIGRpc2FibGVkPXtjb21wbGV0ZSAhPT0gdHJ1ZX1cbiAgICAgICAgICAgIG9uQ2xpY2s9e2hhbmRsZVNhdmVBbmRDbG9zZX0+XG4gICAgICAgICAge2luUHJlTGF1bmNoU2V0dXBcbiAgICAgICAgICAgID8gPD5TYXZlIHNldHRpbmdzIHVzaW5nIHt1c2luZ1Vwc3RyZWFtID8gXCJ1cHN0cmVhbVwiIDogXCJmb3JrXCJ9IHJlcG9zaXRvcnkgYW5kIGxhdW5jaDwvPlxuICAgICAgICAgICAgOiA8PlNhdmUgYW5kIGNsb3NlPC8+fVxuICAgICAgICA8L0J1dHRvbj5cbiAgICAgIDwvZm9vdGVyPlxuICAgIDwvZGl2PlxuICApO1xufTtcbiJdfQ==