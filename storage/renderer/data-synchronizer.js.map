{"version":3,"file":"data-synchronizer.js","sourceRoot":"","sources":["../../../src/storage/renderer/data-synchronizer.tsx"],"names":[],"mappings":"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","sourcesContent":["import { remote, ipcRenderer } from 'electron';\nimport React, { useEffect, useState } from 'react';\nimport { H4, Collapse, Card, Label, InputGroup, FormGroup, TextArea, Callout, UL, Button } from '@blueprintjs/core';\n\nimport { useWorkspaceRO } from 'api/renderer';\nimport { useLocalStorage } from 'renderer/useLocalStorage';\n\nimport { GitAuthor } from '../git';\n\nimport * as styles from './data-synchronizer.scss';\n\n\nconst API_ENDPOINT = 'fetch-commit-push';\n\n\ninterface DataSynchronizerProps {}\nexport const DataSynchronizer: React.FC<DataSynchronizerProps> = function () {\n  const [username, setUsername] = useLocalStorage('gitUsername', '');\n  const [password, setPassword] = useLocalStorage('gitPassword', '');\n\n  const [commitMsg, setCommitMsg] = useState('');\n  const [authorName, setAuthorName] = useState('');\n  const [authorEmail, setAuthorEmail] = useState('');\n\n  const [repoConfigOpenState, updateRepoConfigOpenState] = useState(false);\n  const [repoConfigComplete, updateRepoConfigComplete] = useState(false);\n\n  const repoCfg = useWorkspaceRO<{ author: GitAuthor, originURL: string | null | undefined }>(\n    'git-config',\n    { originURL: undefined, author: {} });\n\n  useEffect(() => {\n    if (repoCfg.originURL !== undefined) {\n      const _complete = (\n        username.trim() !== '' &&\n        password.trim() !== '' &&\n        (repoCfg.originURL || '').trim() !== '');\n\n      updateRepoConfigComplete(_complete);\n      if (repoConfigOpenState === false && _complete === false) {\n        updateRepoConfigOpenState(true);\n      }\n    }\n  }, [username, password, repoCfg.originURL]);\n\n  const [errors, setErrors] = useState([] as string[]);\n  const [finished, setFinished] = useState(false);\n  const [started, setStarted] = useState(false);\n\n  if (authorName.trim() === '' && repoCfg.author.name !== undefined) { setAuthorName(repoCfg.author.name); }\n  if (authorEmail.trim() === '' && repoCfg.author.email !== undefined) { setAuthorEmail(repoCfg.author.email); }\n\n  function handleResult(evt: any, rawData: string) {\n    ipcRenderer.removeListener(`workspace-${API_ENDPOINT}`, handleResult);\n    const data: any = JSON.parse(rawData);\n    setStarted(false);\n    setFinished(true);\n    setErrors(data.errors);\n\n    if (data.errors.length < 1) {\n      setCommitMsg('');\n    }\n  }\n\n  function handleSyncAction() {\n    updateRepoConfigOpenState(false);\n    setErrors([]);\n    ipcRenderer.on(`workspace-${API_ENDPOINT}`, handleResult);\n    ipcRenderer.send(\n      `request-workspace-${API_ENDPOINT}`,\n      JSON.stringify({\n        commitMsg,\n        authorName,\n        authorEmail,\n        gitUsername: username,\n        gitPassword: password,\n      }));\n    setFinished(false);\n    setStarted(true);\n  }\n\n  async function handleResetURL() {\n    await ipcRenderer.send('clear-setting', 'gitRepoUrl');\n    remote.app.relaunch();\n    remote.app.quit();\n  }\n\n  const complete = (\n    authorName.trim() != '' &&\n    authorEmail.trim() != '' &&\n    username.trim() != '' &&\n    password.trim() != '' &&\n    commitMsg.trim() != '');\n\n  return (\n    <>\n      <div className={styles.dataSyncBase}>\n        <Button disabled={!repoConfigComplete} onClick={() => updateRepoConfigOpenState(!repoConfigOpenState)}>\n          {repoConfigComplete && repoConfigOpenState ? 'Hide r' : 'R'}\n          epository configuration\n          {!repoConfigOpenState && repoConfigComplete ? '…': null}\n        </Button>\n\n        <Collapse className={styles.repoConfigCollapsible} isOpen={repoConfigOpenState}>\n          <Card key=\"repoUrl\" className={styles.repoUrlCard}>\n            <FormGroup\n                label=\"Repository URL\"\n                helperText={<Callout intent=\"warning\">Note: resetting the URL will cause you to lose any unsubmitted changes.</Callout>}>\n              <InputGroup\n                defaultValue={repoCfg.originURL || ''}\n                disabled={true}\n                type=\"text\"\n                rightElement={\n                  <Button\n                      intent=\"warning\"\n                      minimal={true}\n                      title=\"Reset repository URL. Note: you will lose any unsubmitted changes.\"\n                      onClick={handleResetURL}>\n                    Reset URL\n                  </Button>\n                }\n              />\n            </FormGroup>\n          </Card>\n\n          <Card key=\"repoAuth\" className={styles.repoAuthCard}>\n            <div className={styles.dataSyncRow}>\n              <Label key=\"username\">\n                Git username\n                <InputGroup\n                  value={username}\n                  type=\"text\"\n                  onChange={(evt: React.FormEvent<HTMLElement>) => {\n                    setUsername((evt.target as HTMLInputElement).value as string);\n                  }}\n                />\n              </Label>\n              <Label key=\"password\">\n                Password\n                <InputGroup\n                  value={password}\n                  type=\"password\"\n                  onChange={(evt: React.FormEvent<HTMLElement>) => {\n                    setPassword((evt.target as HTMLInputElement).value as string);\n                  }}\n                />\n              </Label>\n            </div>\n          </Card>\n        </Collapse>\n\n        {finished === true\n          ? <Collapse isOpen={!repoConfigOpenState}>\n              <Card key=\"resultMessage\" className={styles.resultCard}>\n                <Callout\n                  intent={errors.length > 0 ? \"warning\" : \"success\"}\n                  title={errors.length > 0 ? \"Errors encountered during merge sequence\" : \"Merge completed\"}>\n\n                {errors.length > 0\n                  ? <UL>\n                      {errors.map((err: string) =>\n                        <li>{err}</li>\n                      )}\n                    </UL>\n                  : <p>Your changes have been merged and submitted.</p>}\n                </Callout>\n              </Card>\n            </Collapse>\n          : ''}\n\n        <Card key=\"committerInfo\" className={styles.committerInfoCard}>\n          <H4>Committing changes as</H4>\n\n          <div className={styles.dataSyncRow}>\n            <Label key=\"authorName\">\n              Author name\n              <InputGroup\n                value={authorName}\n                type=\"text\"\n                onChange={(evt: React.FormEvent<HTMLElement>) => {\n                  setAuthorName((evt.target as HTMLInputElement).value as string);\n                }}\n              />\n            </Label>\n            <Label key=\"authorEmail\">\n              Author email\n              <InputGroup\n                value={authorEmail}\n                type=\"email\"\n                onChange={(evt: React.FormEvent<HTMLElement>) => {\n                  setAuthorEmail((evt.target as HTMLInputElement).value as string);\n                }}\n              />\n            </Label>\n          </div>\n        </Card>\n\n        <Card key=\"commitRow\" className={styles.commitCard}>\n          <H4>Change notice</H4>\n\n          <FormGroup\n              className={styles.formGroup}\n              key=\"commitMsg\"\n              intent=\"primary\">\n            <TextArea\n              value={commitMsg}\n              fill={true}\n              large={true}\n              onChange={(evt: React.FormEvent<HTMLElement>) => {\n                setCommitMsg((evt.target as HTMLInputElement).value as string);\n              }}\n            />\n          </FormGroup>\n\n          <Button\n            className={styles.syncButton}\n            icon=\"git-merge\"\n            intent=\"primary\"\n            large={true}\n            disabled={complete === false || started === true}\n            title=\"Fetch other site editors’ changes, and submit yours\"\n            onClick={handleSyncAction}>Merge Changes</Button>\n        </Card>\n      </div>\n    </>\n  );\n};\n"]}