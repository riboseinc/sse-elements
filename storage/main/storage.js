import * as path from 'path';
import * as log from 'electron-log';
import { makeEndpoint } from '../../api/main';
import { YAMLStorage } from './yaml';
const YAML_EXT = '.yaml';
export class StoreManager {
    constructor(rootDir) {
        this.rootDir = rootDir;
        this._index = undefined;
    }
    async storeIndex(storage, newIdx) {
        log.debug(`SSE: StorageManager for ${this.rootDir}: Storing index`);
        const idx = newIdx || await this.getIndex(storage);
        const items = Object.values(idx);
        for (const obj of items) {
            await this.store(obj, storage, false);
        }
        this._index = idx;
        return true;
    }
    async getIndex(storage) {
        if (this._index === undefined) {
            this._index = await this._loadIndex(storage);
        }
        return this._index;
    }
    async findObjects(storage, query) {
        const index = await this.getIndex(storage);
        if (query !== undefined) {
            var results = {};
            for (let key of Object.keys(index)) {
                const obj = index[key];
                if (this.objectMatchesQuery(obj, query)) {
                    results[key] = obj;
                }
            }
            return results;
        }
        else {
            return index;
        }
    }
    async _loadIndex(storage) {
        const rootPath = this.rootDir;
        const dirs = await storage.fs.readdir(path.join(storage.workDir, rootPath));
        var idx = {};
        for (const dir of dirs) {
            if (dir != '.DS_Store') {
                const objData = await storage.loadObject(path.join(rootPath, dir));
                if (objData) {
                    const obj = this.postLoad(objData);
                    if (obj.id) {
                        idx[obj.id] = obj;
                    }
                }
            }
        }
        return idx;
    }
    // TODO: Use `toUseableObject(data: any) => O` to post-process loaded data
    // Stores object in DB
    async store(obj, storage, updateIndex = true) {
        //log.debug(`SSE: StorageManager for ${this.rootDir}: Storing object ${obj.id}`);
        //log.silly(`SSE: StorageManager for ${this.rootDir}: Storing object ${obj.id}: ${JSON.stringify(obj)}`);
        const objDir = path.join(this.rootDir, `${obj.id}`);
        const objPath = path.join(storage.workDir, objDir);
        const storeable = this.toStoreableObject(obj);
        await storage.fs.ensureDir(objPath);
        for (const key of Object.keys(storeable)) {
            const data = storeable[key];
            await storage.yaml.store(path.join(objPath, `${key}.yaml`), data);
        }
        if (updateIndex === true) {
            //log.debug(`SSE: StorageManager for ${this.rootDir}: Storing object ${obj.id}: Updating index`);
            await this.updateIndexedItem(obj, storage);
        }
        return true;
    }
    async updateIndexedItem(obj, storage) {
        await this.getIndex(storage);
        this._index[obj.id] = obj;
    }
    toStoreableObject(obj) {
        return { meta: obj };
    }
    ;
    // Converts object data into valid object, if needed
    // (in cases when partial data is stored or migration took place previously)
    postLoad(obj) {
        return obj;
    }
    objectMatchesQuery(obj, query) {
        return false;
    }
}
export class Storage {
    constructor(fs, workDir, storeManagers) {
        this.fs = fs;
        this.workDir = workDir;
        this.storeManagers = storeManagers;
        this.fs = fs;
        this.workDir = workDir;
        this.yaml = new YAMLStorage(fs);
        this.workspace = Object.keys(storeManagers).reduce((obj, key) => {
            obj[key] = {};
            return obj;
        }, {});
    }
    async loadWorkspace() {
        this.workspace = await Object.keys(this.storeManagers).reduce(async (objP, key) => {
            const obj = await objP;
            obj[key] = await this.storeManagers[key].getIndex(this);
            return obj;
        }, Promise.resolve({}));
    }
    async storeWorkspace() {
        return Promise.all([...Object.keys(this.storeManagers).map(async (key) => {
                return await this.storeManagers[key].storeIndex(this, this.workspace[key]);
            })]).then(() => true);
    }
    // Loads object data from given directory, reading YAML files.
    // meta.yaml is treated specially, populating top-level object payload.
    // Other YAML files populate corresponding object properties.
    async loadObject(objDir) {
        let objData;
        const metaFile = path.join(this.workDir, objDir, 'meta.yaml');
        let metaFileIsFile;
        try {
            metaFileIsFile = (await this.fs.stat(metaFile)).isFile();
        }
        catch (e) {
            return undefined;
        }
        if (!metaFileIsFile) {
            return undefined;
        }
        objData = await this.yaml.load(metaFile);
        const dirContents = await this.fs.readdir(path.join(this.workDir, objDir));
        for (const item of dirContents) {
            if (path.extname(item) == YAML_EXT) {
                const basename = path.basename(item, YAML_EXT);
                if (basename != 'meta') {
                    objData[basename] = await this.yaml.load(path.join(this.workDir, objDir, item));
                }
            }
        }
        // Blindly hope that data structure loaded from YAML
        // is valid for given type.
        return objData;
    }
    setUpAPIEndpoints(notifier) {
        log.verbose("SSE: Storage: Setting API endpoints");
        for (let indexName of Object.keys(this.workspace)) {
            makeEndpoint(`storage-${indexName}-all`, async () => {
                return this.workspace[indexName];
            }, async ({ newData, notify }) => {
                await this.storeManagers[indexName].storeIndex(this, newData);
                notifier([indexName, ...(notify || [])]);
            });
            makeEndpoint(`storage-${indexName}`, async ({ objectId }) => {
                return this.workspace[indexName][objectId];
            }, async ({ newData, notify }) => {
                await this.storeManagers[indexName].store(newData, this);
                notifier([indexName, ...(notify || [])]);
            });
            makeEndpoint(`storage-${indexName}-delete`, async ({ objectId }) => {
                delete this.workspace[indexName][objectId];
                await this.storeManagers[indexName].storeIndex(this, this.workspace[indexName]);
                return true;
            });
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RvcmFnZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zdG9yYWdlL21haW4vc3RvcmFnZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEtBQUssSUFBSSxNQUFNLE1BQU0sQ0FBQztBQUM3QixPQUFPLEtBQUssR0FBRyxNQUFNLGNBQWMsQ0FBQztBQUVwQyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFLOUMsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLFFBQVEsQ0FBQztBQUdyQyxNQUFNLFFBQVEsR0FBRyxPQUFPLENBQUM7QUFHekIsTUFBTSxPQUFnQixZQUFZO0lBR2hDLFlBQW1CLE9BQWU7UUFBZixZQUFPLEdBQVAsT0FBTyxDQUFRO1FBRnhCLFdBQU0sR0FBeUIsU0FBUyxDQUFDO0lBRWQsQ0FBQztJQUUvQixLQUFLLENBQUMsVUFBVSxDQUFDLE9BQXFCLEVBQUUsTUFBNEI7UUFDekUsR0FBRyxDQUFDLEtBQUssQ0FBQywyQkFBMkIsSUFBSSxDQUFDLE9BQU8saUJBQWlCLENBQUMsQ0FBQztRQUVwRSxNQUFNLEdBQUcsR0FBYSxNQUFNLElBQUksTUFBTSxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQzdELE1BQU0sS0FBSyxHQUFRLE1BQU0sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFdEMsS0FBSyxNQUFNLEdBQUcsSUFBSSxLQUFLLEVBQUU7WUFDdkIsTUFBTSxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxPQUFPLEVBQUUsS0FBSyxDQUFDLENBQUM7U0FDdkM7UUFFRCxJQUFJLENBQUMsTUFBTSxHQUFHLEdBQUcsQ0FBQztRQUNsQixPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFFTSxLQUFLLENBQUMsUUFBUSxDQUFDLE9BQXFCO1FBQ3pDLElBQUksSUFBSSxDQUFDLE1BQU0sS0FBSyxTQUFTLEVBQUU7WUFDN0IsSUFB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U0FBUyxDQUFDLFNBQVMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDO2dCQUMzQyxNQUFNLElBQUksQ0FBQyxhQUFhLENBQUMsU0FBUyxDQUFDLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7Z0JBQ2hGLE9BQU8sSUFBSSxDQUFDO1lBQ2QsQ0FBQyxDQUFDLENBQUM7U0FFSjtJQUNILENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgKiBhcyBsb2cgZnJvbSAnZWxlY3Ryb24tbG9nJztcblxuaW1wb3J0IHsgbWFrZUVuZHBvaW50IH0gZnJvbSAnLi4vLi4vYXBpL21haW4nO1xuXG5pbXBvcnQgeyBJbmRleCwgSW5kZXhhYmxlT2JqZWN0IH0gZnJvbSAnLi4vcXVlcnknO1xuaW1wb3J0IHsgV29ya3NwYWNlIH0gZnJvbSAnLi4vd29ya3NwYWNlJztcblxuaW1wb3J0IHsgWUFNTFN0b3JhZ2UgfSBmcm9tICcuL3lhbWwnO1xuXG5cbmNvbnN0IFlBTUxfRVhUID0gJy55YW1sJztcblxuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgU3RvcmVNYW5hZ2VyPE8gZXh0ZW5kcyBJbmRleGFibGVPYmplY3Q+IHtcbiAgcHJvdGVjdGVkIF9pbmRleDogSW5kZXg8Tz4gfCB1bmRlZmluZWQgPSB1bmRlZmluZWQ7XG5cbiAgY29uc3RydWN0b3IocHVibGljIHJvb3REaXI6IHN0cmluZykge31cblxuICBwdWJsaWMgYXN5bmMgc3RvcmVJbmRleChzdG9yYWdlOiBTdG9yYWdlPGFueT4sIG5ld0lkeDogSW5kZXg8Tz4gfCB1bmRlZmluZWQpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBsb2cuZGVidWcoYFNTRTogU3RvcmFnZU1hbmFnZXIgZm9yICR7dGhpcy5yb290RGlyfTogU3RvcmluZyBpbmRleGApO1xuXG4gICAgY29uc3QgaWR4OiBJbmRleDxPPiA9IG5ld0lkeCB8fCBhd2FpdCB0aGlzLmdldEluZGV4KHN0b3JhZ2UpO1xuICAgIGNvbnN0IGl0ZW1zOiBPW10gPSBPYmplY3QudmFsdWVzKGlkeCk7XG5cbiAgICBmb3IgKGNvbnN0IG9iaiBvZiBpdGVtcykge1xuICAgICAgYXdhaXQgdGhpcy5zdG9yZShvYmosIHN0b3JhZ2UsIGZhbHNlKTtcbiAgICB9XG5cbiAgICB0aGlzLl9pbmRleCA9IGlkeDtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBnZXRJbmRleChzdG9yYWdlOiBTdG9yYWdlPGFueT4pOiBQcm9taXNlPEluZGV4PE8+PiB7XG4gICAgaWYgKHRoaXMuX2luZGV4ID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHRoaXMuX2luZGV4ID0gYXdhaXQgdGhpcy5fbG9hZEluZGV4KHN0b3JhZ2UpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5faW5kZXg7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZmluZE9iamVjdHMoc3RvcmFnZTogU3RvcmFnZTxhbnk+LCBxdWVyeT86IHN0cmluZyk6IFByb21pc2U8SW5kZXg8Tz4+IHtcbiAgICBjb25zdCBpbmRleCA9IGF3YWl0IHRoaXMuZ2V0SW5kZXgoc3RvcmFnZSk7XG4gICAgaWYgKHF1ZXJ5ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHZhciByZXN1bHRzOiBJbmRleDxPPiA9IHt9O1xuICAgICAgZm9yIChsZXQga2V5IG9mIE9iamVjdC5rZXlzKGluZGV4KSkge1xuICAgICAgICBjb25zdCBvYmogPSBpbmRleFtrZXldXG4gICAgICAgIGlmICh0aGlzLm9iamVjdE1hdGNoZXNRdWVyeShvYmosIHF1ZXJ5KSkge1xuICAgICAgICAgIHJlc3VsdHNba2V5XSA9IG9iajtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcmV0dXJuIHJlc3VsdHM7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBpbmRleDtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIF9sb2FkSW5kZXgoc3RvcmFnZTogU3RvcmFnZTxhbnk+KTogUHJvbWlzZTxJbmRleDxPPj4ge1xuICAgIGNvbnN0IHJvb3RQYXRoID0gdGhpcy5yb290RGlyO1xuICAgIGNvbnN0IGRpcnMgPSBhd2FpdCBzdG9yYWdlLmZzLnJlYWRkaXIocGF0aC5qb2luKHN0b3JhZ2Uud29ya0Rpciwgcm9vdFBhdGgpKTtcbiAgICB2YXIgaWR4OiBJbmRleDxPPiA9IHt9O1xuXG4gICAgZm9yIChjb25zdCBkaXIgb2YgZGlycykge1xuICAgICAgaWYgKGRpciAhPSAnLkRTX1N0b3JlJykge1xuICAgICAgICBjb25zdCBvYmpEYXRhID0gYXdhaXQgc3RvcmFnZS5sb2FkT2JqZWN0KHBhdGguam9pbihyb290UGF0aCwgZGlyKSk7XG4gICAgICAgIGlmIChvYmpEYXRhKSB7XG4gICAgICAgICAgY29uc3Qgb2JqOiBPID0gdGhpcy5wb3N0TG9hZChvYmpEYXRhKTtcbiAgICAgICAgICBpZiAob2JqLmlkKSB7XG4gICAgICAgICAgICBpZHhbb2JqLmlkXSA9IG9iajtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGlkeDtcbiAgfVxuXG4gIC8vIFRPRE86IFVzZSBgdG9Vc2VhYmxlT2JqZWN0KGRhdGE6IGFueSkgPT4gT2AgdG8gcG9zdC1wcm9jZXNzIGxvYWRlZCBkYXRhXG5cbiAgLy8gU3RvcmVzIG9iamVjdCBpbiBEQlxuICBwdWJsaWMgYXN5bmMgc3RvcmUob2JqOiBPLCBzdG9yYWdlOiBTdG9yYWdlPGFueT4sIHVwZGF0ZUluZGV4ID0gdHJ1ZSk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIC8vbG9nLmRlYnVnKGBTU0U6IFN0b3JhZ2VNYW5hZ2VyIGZvciAke3RoaXMucm9vdERpcn06IFN0b3Jpbmcgb2JqZWN0ICR7b2JqLmlkfWApO1xuICAgIC8vbG9nLnNpbGx5KGBTU0U6IFN0b3JhZ2VNYW5hZ2VyIGZvciAke3RoaXMucm9vdERpcn06IFN0b3Jpbmcgb2JqZWN0ICR7b2JqLmlkfTogJHtKU09OLnN0cmluZ2lmeShvYmopfWApO1xuXG4gICAgY29uc3Qgb2JqRGlyID0gcGF0aC5qb2luKHRoaXMucm9vdERpciwgYCR7b2JqLmlkfWApO1xuICAgIGNvbnN0IG9ialBhdGggPSBwYXRoLmpvaW4oc3RvcmFnZS53b3JrRGlyLCBvYmpEaXIpO1xuICAgIGNvbnN0IHN0b3JlYWJsZSA9IHRoaXMudG9TdG9yZWFibGVPYmplY3Qob2JqKTtcblxuICAgIGF3YWl0IHN0b3JhZ2UuZnMuZW5zdXJlRGlyKG9ialBhdGgpO1xuICAgIGZvciAoY29uc3Qga2V5IG9mIE9iamVjdC5rZXlzKHN0b3JlYWJsZSkpIHtcbiAgICAgIGNvbnN0IGRhdGEgPSBzdG9yZWFibGVba2V5XTtcbiAgICAgIGF3YWl0IHN0b3JhZ2UueWFtbC5zdG9yZShwYXRoLmpvaW4ob2JqUGF0aCwgYCR7a2V5fS55YW1sYCksIGRhdGEpO1xuICAgIH1cblxuICAgIGlmICh1cGRhdGVJbmRleCA9PT0gdHJ1ZSkge1xuICAgICAgLy9sb2cuZGVidWcoYFNTRTogU3RvcmFnZU1hbmFnZXIgZm9yICR7dGhpcy5yb290RGlyfTogU3RvcmluZyBvYmplY3QgJHtvYmouaWR9OiBVcGRhdGluZyBpbmRleGApO1xuICAgICAgYXdhaXQgdGhpcy51cGRhdGVJbmRleGVkSXRlbShvYmosIHN0b3JhZ2UpO1xuICAgIH1cblxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIHVwZGF0ZUluZGV4ZWRJdGVtKG9iajogTywgc3RvcmFnZTogU3RvcmFnZTxhbnk+KSB7XG4gICAgYXdhaXQgdGhpcy5nZXRJbmRleChzdG9yYWdlKTtcbiAgICAodGhpcy5faW5kZXggYXMgSW5kZXg8Tz4pW29iai5pZF0gPSBvYmo7XG4gIH1cblxuICBwdWJsaWMgdG9TdG9yZWFibGVPYmplY3Qob2JqOiBPKTogYW55IHtcbiAgICByZXR1cm4geyBtZXRhOiBvYmogYXMgYW55IH07XG4gIH07XG5cbiAgLy8gQ29udmVydHMgb2JqZWN0IGRhdGEgaW50byB2YWxpZCBvYmplY3QsIGlmIG5lZWRlZFxuICAvLyAoaW4gY2FzZXMgd2hlbiBwYXJ0aWFsIGRhdGEgaXMgc3RvcmVkIG9yIG1pZ3JhdGlvbiB0b29rIHBsYWNlIHByZXZpb3VzbHkpXG4gIHB1YmxpYyBwb3N0TG9hZChvYmo6IGFueSk6IE8ge1xuICAgIHJldHVybiBvYmogYXMgTztcbiAgfVxuXG4gIHB1YmxpYyBvYmplY3RNYXRjaGVzUXVlcnkob2JqOiBPLCBxdWVyeTogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG59XG5cblxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIFN0b3JhZ2U8VyBleHRlbmRzIFdvcmtzcGFjZT4ge1xuICBwdWJsaWMgeWFtbDogWUFNTFN0b3JhZ2U7XG4gIHB1YmxpYyB3b3Jrc3BhY2U6IFc7XG5cbiAgY29uc3RydWN0b3IocHVibGljIGZzOiB0eXBlb2YgaW1wb3J0KCdmcy1leHRyYScpLCBwdWJsaWMgd29ya0Rpcjogc3RyaW5nLFxuICAgICAgcHVibGljIHN0b3JlTWFuYWdlcnM6IHsgW2tleTogc3RyaW5nXTogU3RvcmVNYW5hZ2VyPGFueT4gfSkge1xuICAgIHRoaXMuZnMgPSBmcztcbiAgICB0aGlzLndvcmtEaXIgPSB3b3JrRGlyO1xuICAgIHRoaXMueWFtbCA9IG5ldyBZQU1MU3RvcmFnZShmcyk7XG5cbiAgICB0aGlzLndvcmtzcGFjZSA9IE9iamVjdC5rZXlzKHN0b3JlTWFuYWdlcnMpLnJlZHVjZSgob2JqOiBhbnksIGtleTogc3RyaW5nKSA9PiB7XG4gICAgICBvYmpba2V5XSA9IHt9O1xuICAgICAgcmV0dXJuIG9iajtcbiAgICB9LCB7fSkgYXMgVztcbiAgfVxuXG4gIHB1YmxpYyBhYnN0cmFjdCBhc3luYyBmaW5kT2JqZWN0cyhxdWVyeT86IHN0cmluZyk6IFByb21pc2U8Vz5cblxuICBwdWJsaWMgYXN5bmMgbG9hZFdvcmtzcGFjZSgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0aGlzLndvcmtzcGFjZSA9IGF3YWl0IE9iamVjdC5rZXlzKHRoaXMuc3RvcmVNYW5hZ2VycykucmVkdWNlKGFzeW5jIChvYmpQOiBQcm9taXNlPGFueT4sIGtleTogc3RyaW5nKSA9PiB7XG4gICAgICBjb25zdCBvYmogPSBhd2FpdCBvYmpQO1xuICAgICAgb2JqW2tleV0gPSBhd2FpdCB0aGlzLnN0b3JlTWFuYWdlcnNba2V5XS5nZXRJbmRleCh0aGlzKTtcbiAgICAgIHJldHVybiBvYmo7XG4gICAgfSwgUHJvbWlzZS5yZXNvbHZlKHt9KSkgYXMgVztcbiAgfVxuXG4gIGFzeW5jIHN0b3JlV29ya3NwYWNlKCk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIHJldHVybiBQcm9taXNlLmFsbChbLi4uT2JqZWN0LmtleXModGhpcy5zdG9yZU1hbmFnZXJzKS5tYXAoYXN5bmMgKGtleSkgPT4ge1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuc3RvcmVNYW5hZ2Vyc1trZXldLnN0b3JlSW5kZXgodGhpcywgdGhpcy53b3Jrc3BhY2Vba2V5XSk7XG4gICAgfSldKS50aGVuKCgpID0+IHRydWUpO1xuICB9XG5cbiAgLy8gTG9hZHMgb2JqZWN0IGRhdGEgZnJvbSBnaXZlbiBkaXJlY3RvcnksIHJlYWRpbmcgWUFNTCBmaWxlcy5cbiAgLy8gbWV0YS55YW1sIGlzIHRyZWF0ZWQgc3BlY2lhbGx5LCBwb3B1bGF0aW5nIHRvcC1sZXZlbCBvYmplY3QgcGF5bG9hZC5cbiAgLy8gT3RoZXIgWUFNTCBmaWxlcyBwb3B1bGF0ZSBjb3JyZXNwb25kaW5nIG9iamVjdCBwcm9wZXJ0aWVzLlxuICBwdWJsaWMgYXN5bmMgbG9hZE9iamVjdChvYmpEaXI6IHN0cmluZyk6IFByb21pc2U8YW55IHwgdW5kZWZpbmVkPiB7XG4gICAgbGV0IG9iakRhdGE6IHtbcHJvcE5hbWU6IHN0cmluZ106IGFueX07XG5cbiAgICBjb25zdCBtZXRhRmlsZSA9IHBhdGguam9pbih0aGlzLndvcmtEaXIsIG9iakRpciwgJ21ldGEueWFtbCcpO1xuICAgIGxldCBtZXRhRmlsZUlzRmlsZTogYm9vbGVhbjtcbiAgICB0cnkge1xuICAgICAgbWV0YUZpbGVJc0ZpbGUgPSAoYXdhaXQgdGhpcy5mcy5zdGF0KG1ldGFGaWxlKSkuaXNGaWxlKCk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG4gICAgaWYgKCFtZXRhRmlsZUlzRmlsZSkge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG4gICAgb2JqRGF0YSA9IGF3YWl0IHRoaXMueWFtbC5sb2FkKG1ldGFGaWxlKTtcblxuICAgIGNvbnN0IGRpckNvbnRlbnRzID0gYXdhaXQgdGhpcy5mcy5yZWFkZGlyKHBhdGguam9pbih0aGlzLndvcmtEaXIsIG9iakRpcikpO1xuICAgIGZvciAoY29uc3QgaXRlbSBvZiBkaXJDb250ZW50cykge1xuICAgICAgaWYgKHBhdGguZXh0bmFtZShpdGVtKSA9PSBZQU1MX0VYVCkge1xuICAgICAgICBjb25zdCBiYXNlbmFtZSA9IHBhdGguYmFzZW5hbWUoaXRlbSwgWUFNTF9FWFQpO1xuICAgICAgICBpZiAoYmFzZW5hbWUgIT0gJ21ldGEnKSB7XG4gICAgICAgICAgb2JqRGF0YVtiYXNlbmFtZV0gPSBhd2FpdCB0aGlzLnlhbWwubG9hZChwYXRoLmpvaW4odGhpcy53b3JrRGlyLCBvYmpEaXIsIGl0ZW0pKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIC8vIEJsaW5kbHkgaG9wZSB0aGF0IGRhdGEgc3RydWN0dXJlIGxvYWRlZCBmcm9tIFlBTUxcbiAgICAvLyBpcyB2YWxpZCBmb3IgZ2l2ZW4gdHlwZS5cbiAgICByZXR1cm4gb2JqRGF0YTtcbiAgfVxuXG4gIHNldFVwQVBJRW5kcG9pbnRzKG5vdGlmaWVyOiAobm90aWZ5OiBzdHJpbmdbXSkgPT4gdm9pZCkge1xuICAgIGxvZy52ZXJib3NlKFwiU1NFOiBTdG9yYWdlOiBTZXR0aW5nIEFQSSBlbmRwb2ludHNcIik7XG5cbiAgICBmb3IgKGxldCBpbmRleE5hbWUgb2YgT2JqZWN0LmtleXModGhpcy53b3Jrc3BhY2UpKSB7XG5cbiAgICAgIG1ha2VFbmRwb2ludDxJbmRleDxhbnk+Pihgc3RvcmFnZS0ke2luZGV4TmFtZX0tYWxsYCwgYXN5bmMgKCkgPT4ge1xuICAgICAgICByZXR1cm4gdGhpcy53b3Jrc3BhY2VbaW5kZXhOYW1lXTtcbiAgICAgIH0sIGFzeW5jICh7IG5ld0RhdGEsIG5vdGlmeSB9KSA9PiB7XG4gICAgICAgIGF3YWl0IHRoaXMuc3RvcmVNYW5hZ2Vyc1tpbmRleE5hbWVdLnN0b3JlSW5kZXgodGhpcywgbmV3RGF0YSk7XG4gICAgICAgIG5vdGlmaWVyKFtpbmRleE5hbWUsIC4uLihub3RpZnkgfHwgW10pXSk7XG4gICAgICB9KTtcblxuICAgICAgbWFrZUVuZHBvaW50PEluZGV4YWJsZU9iamVjdD4oYHN0b3JhZ2UtJHtpbmRleE5hbWV9YCwgYXN5bmMgKHsgb2JqZWN0SWQgfTogeyBvYmplY3RJZDogc3RyaW5nIH0pID0+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMud29ya3NwYWNlW2luZGV4TmFtZV1bb2JqZWN0SWRdO1xuICAgICAgfSwgYXN5bmMgKHsgbmV3RGF0YSwgbm90aWZ5IH0pID0+IHtcbiAgICAgICAgYXdhaXQgdGhpcy5zdG9yZU1hbmFnZXJzW2luZGV4TmFtZV0uc3RvcmUobmV3RGF0YSwgdGhpcyk7XG4gICAgICAgIG5vdGlmaWVyKFtpbmRleE5hbWUsIC4uLihub3RpZnkgfHwgW10pXSk7XG4gICAgICB9KTtcblxuICAgICAgbWFrZUVuZHBvaW50PGJvb2xlYW4+KGBzdG9yYWdlLSR7aW5kZXhOYW1lfS1kZWxldGVgLCBhc3luYyAoeyBvYmplY3RJZCB9OiB7IG9iamVjdElkOiBzdHJpbmcgfSkgPT4ge1xuICAgICAgICBkZWxldGUgdGhpcy53b3Jrc3BhY2VbaW5kZXhOYW1lXVtvYmplY3RJZF07XG4gICAgICAgIGF3YWl0IHRoaXMuc3RvcmVNYW5hZ2Vyc1tpbmRleE5hbWVdLnN0b3JlSW5kZXgodGhpcywgdGhpcy53b3Jrc3BhY2VbaW5kZXhOYW1lXSk7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfSk7XG5cbiAgICB9XG4gIH1cbn1cbiJdfQ==