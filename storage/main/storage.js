import * as path from 'path';
import * as log from 'electron-log';
import { listen } from '../../api/main';
import { YAMLStorage } from './yaml';
const YAML_EXT = '.yaml';
export class StoreManager {
    constructor(rootDir) {
        this.rootDir = rootDir;
        this._index = undefined;
    }
    /* Intended to be overridden */
    // Converts object into data valid for storage
    toStoreableObject(obj) {
        return { meta: obj };
    }
    ;
    // Converts raw loaded data into valid object
    toUseableObject(data) {
        return data;
    }
    objectMatchesQuery(obj, query) {
        return false;
    }
    formatObjectNameForCommitMessage(obj) {
        return `${path.basename(this.rootDir)}#${obj.id}`;
    }
    /* Can be called from outside */
    async getIndex(storage, force = false) {
        if (this._index === undefined || force === true) {
            this._index = await this._loadIndex(storage);
        }
        return this._index;
    }
    async findObjects(storage, query) {
        const index = await this.getIndex(storage);
        if (query !== undefined) {
            var results = {};
            for (let key of Object.keys(index)) {
                const obj = index[key];
                if (this.objectMatchesQuery(obj, query)) {
                    results[key] = obj;
                }
            }
            return results;
        }
        else {
            return index;
        }
    }
    // Loads object data from given directory, reading YAML files.
    // meta.yaml is treated specially, populating top-level object payload.
    // Other YAML files populate corresponding object properties.
    async load(objDir, storage) {
        const objPath = path.join(storage.workDir, objDir);
        const metaFile = path.join(objPath, 'meta.yaml');
        let metaFileIsFile;
        try {
            metaFileIsFile = (await storage.fs.stat(metaFile)).isFile();
        }
        catch (e) {
            return undefined;
        }
        if (!metaFileIsFile) {
            return undefined;
        }
        var objData = await storage.yaml.load(metaFile) || {};
        const dirContents = await storage.fs.readdir(objPath);
        for (const item of dirContents) {
            if (path.extname(item) == YAML_EXT) {
                const basename = path.basename(item, YAML_EXT);
                if (basename != 'meta') {
                    objData[basename] = await storage.yaml.load(path.join(objPath, item));
                }
            }
        }
        // Blindly hope that data structure loaded from YAML
        // is valid for given type.
        return objData;
    }
    async store(obj, storage, updateIndex = true) {
        //log.debug(`SSE: StorageManager for ${this.rootDir}: Storing object ${obj.id}`);
        //log.silly(`SSE: StorageManager for ${this.rootDir}: Storing object ${obj.id}: ${JSON.stringify(obj)}`);
        const objPath = this.resolveObjectPath(`${obj.id}`, storage);
        const storeable = this.toStoreableObject(obj);
        await storage.fs.ensureDir(objPath);
        for (const key of Object.keys(storeable)) {
            const data = storeable[key];
            await storage.yaml.store(path.join(objPath, `${key}.yaml`), data);
        }
        if (updateIndex === true) {
            await this.updateInIndex(obj, storage);
        }
        return true;
    }
    async delete(objId, storage, updateIndex = true) {
        const objPath = this.resolveObjectPath(objId, storage);
        log.info(`Deleting path with subdirectories: ${objPath}`);
        await storage.fs.remove(objPath);
        if (updateIndex === true) {
            await this.deleteFromIndex(objId, storage);
        }
        return true;
    }
    /* Private */
    resolveObjectPath(objId, storage) {
        const objDir = path.join(this.rootDir, objId);
        return path.join(storage.workDir, objDir);
    }
    async updateInIndex(obj, storage) {
        await this.getIndex(storage);
        this._index[obj.id] = obj;
    }
    async deleteFromIndex(objId, storage) {
        await this.getIndex(storage);
        delete this._index[objId];
    }
    async _loadIndex(storage) {
        const rootPath = this.rootDir;
        const dirs = await storage.fs.readdir(path.join(storage.workDir, rootPath));
        var idx = {};
        for (const dir of dirs) {
            if (dir != '.DS_Store') {
                let objData;
                try {
                    objData = await this.load(path.join(rootPath, dir), storage);
                }
                catch (e) {
                    log.error(`Failed to load object from ${dir} when loading index ${this.rootDir}`);
                }
                if (objData) {
                    const obj = this.toUseableObject(objData);
                    if (obj.id) {
                        idx[`${obj.id}`] = obj;
                    }
                }
            }
        }
        return idx;
    }
}
export class Storage {
    constructor(fs, workDir, storeManagers, debugBackend) {
        this.fs = fs;
        this.workDir = workDir;
        this.storeManagers = storeManagers;
        this.fs = fs;
        this.workDir = workDir;
        this.yaml = new YAMLStorage(fs, { debugLog: debugBackend || false });
        this.workspace = Object.keys(storeManagers).
            reduce((ws, indexName) => {
            ws[indexName] = {};
            return ws;
        }, {});
    }
    async loadWorkspace(force = false) {
        // Loads workspace object with an index for each store manager.
        // To force store manager to re-read index from filesystem, pass force = true.
        this.workspace = await Object.keys(this.storeManagers).
            reduce(async (wsP, indexName) => {
            const ws = await wsP;
            ws[indexName] = await this.storeManagers[indexName].getIndex(this, force);
            return ws;
        }, Promise.resolve({}));
    }
    setUpAPIEndpoints(notifier) {
        log.verbose("SSE: Storage: Setting API endpoints");
        for (let indexName of Object.keys(this.workspace)) {
            listen(`storage-read-all-in-${indexName}`, async () => {
                return this.workspace[indexName];
            });
            listen(`storage-create-one-in-${indexName}`, async ({ objectId, newData }) => {
                await this.storeManagers[indexName].store(newData, this);
                notifier([indexName]);
                return { success: true };
            });
            listen(`storage-read-one-in-${indexName}`, async ({ objectId }) => {
                return this.workspace[indexName][objectId] || undefined;
            });
            listen(`storage-update-one-in-${indexName}`, async ({ objectId, newData }) => {
                await this.storeManagers[indexName].store(newData, this);
                notifier([indexName]);
                return { success: true };
            });
            listen(`storage-delete-one-in-${indexName}`, async ({ objectId }) => {
                await this.storeManagers[indexName].delete(objectId, this);
                notifier([indexName]);
                return { success: true };
            });
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RvcmFnZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zdG9yYWdlL21haW4vc3RvcmFnZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEtBQUssSUFBSSxNQUFNLE1BQU0sQ0FBQztBQUM3QixPQUFPLEtBQUssR0FBRyxNQUFNLGNBQWMsQ0FBQztBQUVwQyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFLeEMsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLFFBQVEsQ0FBQztBQUdyQyxNQUFNLFFBQVEsR0FBRyxPQUFPLENBQUM7QUFHekIsTUFBTSxPQUFnQixZQUFZO0lBR2hDLFlBQW1CLE9BQWU7UUFBZixZQUFPLEdBQVAsT0FBTyxDQUFRO1FBRnhCLFdBQU0sR0FBeUIsU0FBUyxDQUFDO0lBRWQsQ0FBQztJQUd0QywrQkFBK0I7SUFFL0IsOENBQThDO0lBQ3ZDLGlCQUFpQixDQUFDLEdBQU07UUFDN0IsT0FBTyxFQUFFLElBQUksRUFBRSxHQUFVLEVBQUUsQ0FBQztJQUM5QixDQUFDO0lBQUEsQ0FBQztJQUVGLDZDQUE2QztJQUN0QyxlQUFlLENBQUMsSUFBUztRQUM5QixPQUFPLElBQVMsQ0FBQztJQUNuQixDQUFDO0lBRU0sa0JBQWtCLENBQUMsR0FBTSxFQUFFLEtBQWE7UUFDN0MsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDO0lBRU0sZ0NBQWdDLENBQUMsR0FBTTtRQUM1QyxPQUFPLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksR0FBRyxDQUFDLEVBQUUsRUFBRSxDQUFDO0lBQ3BELENBQUM7SUFHRCxnQ0FBZ0M7SUFFekIsS0FBSyxDQUFDLFFBQVEsQ0FBQyxPQUFxQixFQUFFLEtBQUssR0FBRyxLQUFLO1FBQ3hELElBQUksSUFBSSxDQUFDLE1BQU0sS0FBSyxTQUFTLElBQUksS0FBSyxLQUFLLElBQUksRUFBRTtZQUMvQyxJ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QUFTLENBQUM7WUFDMUQsQ0FBQyxDQUFDLENBQUM7WUFFSCxNQUFNLENBQ0wseUJBQXlCLFNBQVMsRUFBRSxFQUFFLEtBQUssRUFBRSxFQUFFLFFBQVEsRUFBRSxPQUFPLEVBQUUsRUFBRSxFQUFFO2dCQUNyRSxNQUFNLElBQUksQ0FBQyxhQUFhLENBQUMsU0FBUyxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQztnQkFDekQsUUFBUSxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztnQkFDdEIsT0FBTyxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsQ0FBQztZQUMzQixDQUFDLENBQUMsQ0FBQztZQUVILE1BQU0sQ0FDTCx5QkFBeUIsU0FBUyxFQUFFLEVBQUUsS0FBSyxFQUFFLEVBQUUsUUFBUSxFQUFFLEVBQUUsRUFBRTtnQkFDNUQsTUFBTSxJQUFJLENBQUMsYUFBYSxDQUFDLFNBQVMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUM7Z0JBQzNELFFBQVEsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7Z0JBQ3RCLE9BQU8sRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLENBQUM7WUFDM0IsQ0FBQyxDQUFDLENBQUM7U0FFSjtJQUNILENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgKiBhcyBsb2cgZnJvbSAnZWxlY3Ryb24tbG9nJztcblxuaW1wb3J0IHsgbGlzdGVuIH0gZnJvbSAnLi4vLi4vYXBpL21haW4nO1xuXG5pbXBvcnQgeyBJbmRleCwgSW5kZXhhYmxlT2JqZWN0IH0gZnJvbSAnLi4vcXVlcnknO1xuaW1wb3J0IHsgV29ya3NwYWNlLCBFbXB0eVBhcnRpYWxXb3Jrc3BhY2UgfSBmcm9tICcuLi93b3Jrc3BhY2UnO1xuXG5pbXBvcnQgeyBZQU1MU3RvcmFnZSB9IGZyb20gJy4veWFtbCc7XG5cblxuY29uc3QgWUFNTF9FWFQgPSAnLnlhbWwnO1xuXG5cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBTdG9yZU1hbmFnZXI8TyBleHRlbmRzIEluZGV4YWJsZU9iamVjdD4ge1xuICBwcm90ZWN0ZWQgX2luZGV4OiBJbmRleDxPPiB8IHVuZGVmaW5lZCA9IHVuZGVmaW5lZDtcblxuICBjb25zdHJ1Y3RvcihwdWJsaWMgcm9vdERpcjogc3RyaW5nKSB7fVxuXG5cbiAgLyogSW50ZW5kZWQgdG8gYmUgb3ZlcnJpZGRlbiAqL1xuXG4gIC8vIENvbnZlcnRzIG9iamVjdCBpbnRvIGRhdGEgdmFsaWQgZm9yIHN0b3JhZ2VcbiAgcHVibGljIHRvU3RvcmVhYmxlT2JqZWN0KG9iajogTyk6IGFueSB7XG4gICAgcmV0dXJuIHsgbWV0YTogb2JqIGFzIGFueSB9O1xuICB9O1xuXG4gIC8vIENvbnZlcnRzIHJhdyBsb2FkZWQgZGF0YSBpbnRvIHZhbGlkIG9iamVjdFxuICBwdWJsaWMgdG9Vc2VhYmxlT2JqZWN0KGRhdGE6IGFueSk6IE8ge1xuICAgIHJldHVybiBkYXRhIGFzIE87XG4gIH1cblxuICBwdWJsaWMgb2JqZWN0TWF0Y2hlc1F1ZXJ5KG9iajogTywgcXVlcnk6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIHB1YmxpYyBmb3JtYXRPYmplY3ROYW1lRm9yQ29tbWl0TWVzc2FnZShvYmo6IE8pOiBzdHJpbmcge1xuICAgIHJldHVybiBgJHtwYXRoLmJhc2VuYW1lKHRoaXMucm9vdERpcil9IyR7b2JqLmlkfWA7XG4gIH1cblxuXG4gIC8qIENhbiBiZSBjYWxsZWQgZnJvbSBvdXRzaWRlICovXG5cbiAgcHVibGljIGFzeW5jIGdldEluZGV4KHN0b3JhZ2U6IFN0b3JhZ2U8YW55PiwgZm9yY2UgPSBmYWxzZSk6IFByb21pc2U8SW5kZXg8Tz4+IHtcbiAgICBpZiAodGhpcy5faW5kZXggPT09IHVuZGVmaW5lZCB8fCBmb3JjZSA9PT0gdHJ1ZSkge1xuICAgICAgdGhpcy5faW5kZXggPSBhd2FpdCB0aGlzLl9sb2FkSW5kZXgoc3RvcmFnZSk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLl9pbmRleDtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBmaW5kT2JqZWN0cyhzdG9yYWdlOiBTdG9yYWdlPGFueT4sIHF1ZXJ5Pzogc3RyaW5nKTogUHJvbWlzZTxJbmRleDxPPj4ge1xuICAgIGNvbnN0IGluZGV4ID0gYXdhaXQgdGhpcy5nZXRJbmRleChzdG9yYWdlKTtcbiAgICBpZiAocXVlcnkgIT09IHVuZGVmaW5lZCkge1xuICAgICAgdmFyIHJlc3VsdHM6IEluZGV4PE8+ID0ge307XG4gICAgICBmb3IgKGxldCBrZXkgb2YgT2JqZWN0LmtleXMoaW5kZXgpKSB7XG4gICAgICAgIGNvbnN0IG9iaiA9IGluZGV4W2tleV1cbiAgICAgICAgaWYgKHRoaXMub2JqZWN0TWF0Y2hlc1F1ZXJ5KG9iaiwgcXVlcnkpKSB7XG4gICAgICAgICAgcmVzdWx0c1trZXldID0gb2JqO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm4gcmVzdWx0cztcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIGluZGV4O1xuICAgIH1cbiAgfVxuXG4gIC8vIExvYWRzIG9iamVjdCBkYXRhIGZyb20gZ2l2ZW4gZGlyZWN0b3J5LCByZWFkaW5nIFlBTUwgZmlsZXMuXG4gIC8vIG1ldGEueWFtbCBpcyB0cmVhdGVkIHNwZWNpYWxseSwgcG9wdWxhdGluZyB0b3AtbGV2ZWwgb2JqZWN0IHBheWxvYWQuXG4gIC8vIE90aGVyIFlBTUwgZmlsZXMgcG9wdWxhdGUgY29ycmVzcG9uZGluZyBvYmplY3QgcHJvcGVydGllcy5cbiAgcHVibGljIGFzeW5jIGxvYWQob2JqRGlyOiBzdHJpbmcsIHN0b3JhZ2U6IFN0b3JhZ2U8YW55Pik6IFByb21pc2U8YW55IHwgdW5kZWZpbmVkPiB7XG4gICAgY29uc3Qgb2JqUGF0aCA9IHBhdGguam9pbihzdG9yYWdlLndvcmtEaXIsIG9iakRpcik7XG4gICAgY29uc3QgbWV0YUZpbGUgPSBwYXRoLmpvaW4ob2JqUGF0aCwgJ21ldGEueWFtbCcpO1xuXG4gICAgbGV0IG1ldGFGaWxlSXNGaWxlOiBib29sZWFuO1xuICAgIHRyeSB7XG4gICAgICBtZXRhRmlsZUlzRmlsZSA9IChhd2FpdCBzdG9yYWdlLmZzLnN0YXQobWV0YUZpbGUpKS5pc0ZpbGUoKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cbiAgICBpZiAoIW1ldGFGaWxlSXNGaWxlKSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIHZhciBvYmpEYXRhOiBhbnkgPSBhd2FpdCBzdG9yYWdlLnlhbWwubG9hZChtZXRhRmlsZSkgfHwge307XG5cbiAgICBjb25zdCBkaXJDb250ZW50cyA9IGF3YWl0IHN0b3JhZ2UuZnMucmVhZGRpcihvYmpQYXRoKTtcbiAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgZGlyQ29udGVudHMpIHtcbiAgICAgIGlmIChwYXRoLmV4dG5hbWUoaXRlbSkgPT0gWUFNTF9FWFQpIHtcbiAgICAgICAgY29uc3QgYmFzZW5hbWUgPSBwYXRoLmJhc2VuYW1lKGl0ZW0sIFlBTUxfRVhUKTtcbiAgICAgICAgaWYgKGJhc2VuYW1lICE9ICdtZXRhJykge1xuICAgICAgICAgIG9iakRhdGFbYmFzZW5hbWVdID0gYXdhaXQgc3RvcmFnZS55YW1sLmxvYWQocGF0aC5qb2luKG9ialBhdGgsIGl0ZW0pKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIC8vIEJsaW5kbHkgaG9wZSB0aGF0IGRhdGEgc3RydWN0dXJlIGxvYWRlZCBmcm9tIFlBTUxcbiAgICAvLyBpcyB2YWxpZCBmb3IgZ2l2ZW4gdHlwZS5cbiAgICByZXR1cm4gb2JqRGF0YTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBzdG9yZShvYmo6IE8sIHN0b3JhZ2U6IFN0b3JhZ2U8YW55PiwgdXBkYXRlSW5kZXggPSB0cnVlKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgLy9sb2cuZGVidWcoYFNTRTogU3RvcmFnZU1hbmFnZXIgZm9yICR7dGhpcy5yb290RGlyfTogU3RvcmluZyBvYmplY3QgJHtvYmouaWR9YCk7XG4gICAgLy9sb2cuc2lsbHkoYFNTRTogU3RvcmFnZU1hbmFnZXIgZm9yICR7dGhpcy5yb290RGlyfTogU3RvcmluZyBvYmplY3QgJHtvYmouaWR9OiAke0pTT04uc3RyaW5naWZ5KG9iail9YCk7XG5cbiAgICBjb25zdCBvYmpQYXRoID0gdGhpcy5yZXNvbHZlT2JqZWN0UGF0aChgJHtvYmouaWR9YCwgc3RvcmFnZSk7XG4gICAgY29uc3Qgc3RvcmVhYmxlID0gdGhpcy50b1N0b3JlYWJsZU9iamVjdChvYmopO1xuXG4gICAgYXdhaXQgc3RvcmFnZS5mcy5lbnN1cmVEaXIob2JqUGF0aCk7XG4gICAgZm9yIChjb25zdCBrZXkgb2YgT2JqZWN0LmtleXMoc3RvcmVhYmxlKSkge1xuICAgICAgY29uc3QgZGF0YSA9IHN0b3JlYWJsZVtrZXldO1xuICAgICAgYXdhaXQgc3RvcmFnZS55YW1sLnN0b3JlKHBhdGguam9pbihvYmpQYXRoLCBgJHtrZXl9LnlhbWxgKSwgZGF0YSk7XG4gICAgfVxuXG4gICAgaWYgKHVwZGF0ZUluZGV4ID09PSB0cnVlKSB7XG4gICAgICBhd2FpdCB0aGlzLnVwZGF0ZUluSW5kZXgob2JqLCBzdG9yYWdlKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBkZWxldGUob2JqSWQ6IHN0cmluZywgc3RvcmFnZTogU3RvcmFnZTxhbnk+LCB1cGRhdGVJbmRleCA9IHRydWUpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBjb25zdCBvYmpQYXRoID0gdGhpcy5yZXNvbHZlT2JqZWN0UGF0aChvYmpJZCwgc3RvcmFnZSk7XG5cbiAgICBsb2cuaW5mbyhgRGVsZXRpbmcgcGF0aCB3aXRoIHN1YmRpcmVjdG9yaWVzOiAke29ialBhdGh9YCk7XG5cbiAgICBhd2FpdCBzdG9yYWdlLmZzLnJlbW92ZShvYmpQYXRoKTtcblxuICAgIGlmICh1cGRhdGVJbmRleCA9PT0gdHJ1ZSkge1xuICAgICAgYXdhaXQgdGhpcy5kZWxldGVGcm9tSW5kZXgob2JqSWQsIHN0b3JhZ2UpO1xuICAgIH1cblxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cblxuICAvKiBQcml2YXRlICovXG5cbiAgcHVibGljIHJlc29sdmVPYmplY3RQYXRoKG9iaklkOiBzdHJpbmcsIHN0b3JhZ2U6IFN0b3JhZ2U8YW55Pik6IHN0cmluZyB7XG4gICAgY29uc3Qgb2JqRGlyID0gcGF0aC5qb2luKHRoaXMucm9vdERpciwgb2JqSWQpO1xuICAgIHJldHVybiBwYXRoLmpvaW4oc3RvcmFnZS53b3JrRGlyLCBvYmpEaXIpO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyB1cGRhdGVJbkluZGV4KG9iajogTywgc3RvcmFnZTogU3RvcmFnZTxhbnk+KSB7XG4gICAgYXdhaXQgdGhpcy5nZXRJbmRleChzdG9yYWdlKTtcbiAgICAodGhpcy5faW5kZXggYXMgSW5kZXg8Tz4pW29iai5pZF0gPSBvYmo7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGRlbGV0ZUZyb21JbmRleChvYmpJZDogc3RyaW5nLCBzdG9yYWdlOiBTdG9yYWdlPGFueT4pIHtcbiAgICBhd2FpdCB0aGlzLmdldEluZGV4KHN0b3JhZ2UpO1xuICAgIGRlbGV0ZSAodGhpcy5faW5kZXggYXMgSW5kZXg8Tz4pW29iaklkXTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgX2xvYWRJbmRleChzdG9yYWdlOiBTdG9yYWdlPGFueT4pOiBQcm9taXNlPEluZGV4PE8+PiB7XG4gICAgY29uc3Qgcm9vdFBhdGggPSB0aGlzLnJvb3REaXI7XG4gICAgY29uc3QgZGlycyA9IGF3YWl0IHN0b3JhZ2UuZnMucmVhZGRpcihwYXRoLmpvaW4oc3RvcmFnZS53b3JrRGlyLCByb290UGF0aCkpO1xuICAgIHZhciBpZHg6IEluZGV4PE8+ID0ge307XG5cbiAgICBmb3IgKGNvbnN0IGRpciBvZiBkaXJzKSB7XG4gICAgICBpZiAoZGlyICE9ICcuRFNfU3RvcmUnKSB7XG4gICAgICAgIGxldCBvYmpEYXRhOiBhbnk7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgb2JqRGF0YSA9IGF3YWl0IHRoaXMubG9hZChwYXRoLmpvaW4ocm9vdFBhdGgsIGRpciksIHN0b3JhZ2UpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgbG9nLmVycm9yKGBGYWlsZWQgdG8gbG9hZCBvYmplY3QgZnJvbSAke2Rpcn0gd2hlbiBsb2FkaW5nIGluZGV4ICR7dGhpcy5yb290RGlyfWApO1xuICAgICAgICB9XG4gICAgICAgIGlmIChvYmpEYXRhKSB7XG4gICAgICAgICAgY29uc3Qgb2JqOiBPID0gdGhpcy50b1VzZWFibGVPYmplY3Qob2JqRGF0YSk7XG4gICAgICAgICAgaWYgKG9iai5pZCkge1xuICAgICAgICAgICAgaWR4W2Ake29iai5pZH1gXSA9IG9iajtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGlkeDtcbiAgfVxufVxuXG5cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBTdG9yYWdlPFcgZXh0ZW5kcyBXb3Jrc3BhY2U+IHtcbiAgcHVibGljIHlhbWw6IFlBTUxTdG9yYWdlO1xuICBwdWJsaWMgd29ya3NwYWNlOiBXO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgICAgcHVibGljIGZzOiB0eXBlb2YgaW1wb3J0KCdmcy1leHRyYScpLFxuICAgICAgcHVibGljIHdvcmtEaXI6IHN0cmluZyxcbiAgICAgIHB1YmxpYyBzdG9yZU1hbmFnZXJzOiB7IFtLIGluIGtleW9mIFddOiBTdG9yZU1hbmFnZXI8YW55PiB9LFxuICAgICAgZGVidWdCYWNrZW5kPzogdHJ1ZSkge1xuICAgIHRoaXMuZnMgPSBmcztcbiAgICB0aGlzLndvcmtEaXIgPSB3b3JrRGlyO1xuICAgIHRoaXMueWFtbCA9IG5ldyBZQU1MU3RvcmFnZShmcywgeyBkZWJ1Z0xvZzogZGVidWdCYWNrZW5kIHx8IGZhbHNlIH0pO1xuXG4gICAgdGhpcy53b3Jrc3BhY2UgPSBPYmplY3Qua2V5cyhzdG9yZU1hbmFnZXJzKS5cbiAgICByZWR1Y2UoKHdzOiBFbXB0eVBhcnRpYWxXb3Jrc3BhY2U8Vz4sIGluZGV4TmFtZToga2V5b2YgVykgPT4ge1xuICAgICAgd3NbaW5kZXhOYW1lXSA9IHt9O1xuICAgICAgcmV0dXJuIHdzO1xuICAgIH0sIHt9KSBhcyBXO1xuICB9XG5cbiAgcHVibGljIGFic3RyYWN0IGFzeW5jIGZpbmRPYmplY3RzKHF1ZXJ5Pzogc3RyaW5nKTogUHJvbWlzZTxXPlxuXG4gIHB1YmxpYyBhc3luYyBsb2FkV29ya3NwYWNlKGZvcmNlID0gZmFsc2UpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAvLyBMb2FkcyB3b3Jrc3BhY2Ugb2JqZWN0IHdpdGggYW4gaW5kZXggZm9yIGVhY2ggc3RvcmUgbWFuYWdlci5cbiAgICAvLyBUbyBmb3JjZSBzdG9yZSBtYW5hZ2VyIHRvIHJlLXJlYWQgaW5kZXggZnJvbSBmaWxlc3lzdGVtLCBwYXNzIGZvcmNlID0gdHJ1ZS5cbiAgICB0aGlzLndvcmtzcGFjZSA9IGF3YWl0IE9iamVjdC5rZXlzKHRoaXMuc3RvcmVNYW5hZ2VycykuXG4gICAgcmVkdWNlKGFzeW5jICh3c1A6IFByb21pc2U8RW1wdHlQYXJ0aWFsV29ya3NwYWNlPFc+PiwgaW5kZXhOYW1lOiBrZXlvZiBXKSA9PiB7XG4gICAgICBjb25zdCB3cyA9IGF3YWl0IHdzUDtcbiAgICAgIHdzW2luZGV4TmFtZV0gPSBhd2FpdCB0aGlzLnN0b3JlTWFuYWdlcnNbaW5kZXhOYW1lXS5nZXRJbmRleCh0aGlzLCBmb3JjZSk7XG4gICAgICByZXR1cm4gd3M7XG4gICAgfSwgUHJvbWlzZS5yZXNvbHZlKHt9KSkgYXMgVztcbiAgfVxuXG4gIHNldFVwQVBJRW5kcG9pbnRzKG5vdGlmaWVyOiAobm90aWZ5OiBzdHJpbmdbXSkgPT4gdm9pZCkge1xuICAgIGxvZy52ZXJib3NlKFwiU1NFOiBTdG9yYWdlOiBTZXR0aW5nIEFQSSBlbmRwb2ludHNcIik7XG5cbiAgICBmb3IgKGxldCBpbmRleE5hbWUgb2YgT2JqZWN0LmtleXModGhpcy53b3Jrc3BhY2UpKSB7XG5cbiAgICAgIGxpc3Rlbjx7fSwgSW5kZXg8YW55Pj5cbiAgICAgIChgc3RvcmFnZS1yZWFkLWFsbC1pbi0ke2luZGV4TmFtZX1gLCBhc3luYyAoKSA9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLndvcmtzcGFjZVtpbmRleE5hbWVdO1xuICAgICAgfSk7XG5cbiAgICAgIGxpc3Rlbjx7IG9iamVjdElkOiBzdHJpbmcsIG5ld0RhdGE6IEluZGV4YWJsZU9iamVjdCAgfSwgeyBzdWNjZXNzOiBib29sZWFuIH0+XG4gICAgICAoYHN0b3JhZ2UtY3JlYXRlLW9uZS1pbi0ke2luZGV4TmFtZX1gLCBhc3luYyAoeyBvYmplY3RJZCwgbmV3RGF0YSB9KSA9PiB7XG4gICAgICAgIGF3YWl0IHRoaXMuc3RvcmVNYW5hZ2Vyc1tpbmRleE5hbWVdLnN0b3JlKG5ld0RhdGEsIHRoaXMpO1xuICAgICAgICBub3RpZmllcihbaW5kZXhOYW1lXSk7XG4gICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUgfTtcbiAgICAgIH0pO1xuXG4gICAgICBsaXN0ZW48eyBvYmplY3RJZDogc3RyaW5nIH0sIEluZGV4YWJsZU9iamVjdCB8IHVuZGVmaW5lZD5cbiAgICAgIChgc3RvcmFnZS1yZWFkLW9uZS1pbi0ke2luZGV4TmFtZX1gLCBhc3luYyAoeyBvYmplY3RJZCB9KSA9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLndvcmtzcGFjZVtpbmRleE5hbWVdW29iamVjdElkXSB8fCB1bmRlZmluZWQ7XG4gICAgICB9KTtcblxuICAgICAgbGlzdGVuPHsgb2JqZWN0SWQ6IHN0cmluZywgbmV3RGF0YTogSW5kZXhhYmxlT2JqZWN0ICB9LCB7IHN1Y2Nlc3M6IGJvb2xlYW4gfT5cbiAgICAgIChgc3RvcmFnZS11cGRhdGUtb25lLWluLSR7aW5kZXhOYW1lfWAsIGFzeW5jICh7IG9iamVjdElkLCBuZXdEYXRhIH0pID0+IHtcbiAgICAgICAgYXdhaXQgdGhpcy5zdG9yZU1hbmFnZXJzW2luZGV4TmFtZV0uc3RvcmUobmV3RGF0YSwgdGhpcyk7XG4gICAgICAgIG5vdGlmaWVyKFtpbmRleE5hbWVdKTtcbiAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSB9O1xuICAgICAgfSk7XG5cbiAgICAgIGxpc3Rlbjx7IG9iamVjdElkOiBzdHJpbmcgfSwgeyBzdWNjZXNzOiBib29sZWFuIH0+XG4gICAgICAoYHN0b3JhZ2UtZGVsZXRlLW9uZS1pbi0ke2luZGV4TmFtZX1gLCBhc3luYyAoeyBvYmplY3RJZCB9KSA9PiB7XG4gICAgICAgIGF3YWl0IHRoaXMuc3RvcmVNYW5hZ2Vyc1tpbmRleE5hbWVdLmRlbGV0ZShvYmplY3RJZCwgdGhpcyk7XG4gICAgICAgIG5vdGlmaWVyKFtpbmRleE5hbWVdKTtcbiAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSB9O1xuICAgICAgfSk7XG5cbiAgICB9XG4gIH1cbn1cbiJdfQ==