import * as path from 'path';
import * as log from 'electron-log';
import { listen } from '../../api/main';
import { YAMLStorage } from './yaml';
const YAML_EXT = '.yaml';
export class StoreManager {
    constructor(rootDir) {
        this.rootDir = rootDir;
        this._index = undefined;
    }
    async storeIndex(storage, newIdx) {
        log.debug(`SSE: StorageManager for ${this.rootDir}: Storing index`);
        const idx = newIdx || await this.getIndex(storage);
        const items = Object.values(idx);
        for (const obj of items) {
            await this.store(obj, storage, false);
        }
        this._index = idx;
        return true;
    }
    async getIndex(storage) {
        if (this._index === undefined) {
            this._index = await this._loadIndex(storage);
        }
        return this._index;
    }
    async findObjects(storage, query) {
        const index = await this.getIndex(storage);
        if (query !== undefined) {
            var results = {};
            for (let key of Object.keys(index)) {
                const obj = index[key];
                if (this.objectMatchesQuery(obj, query)) {
                    results[key] = obj;
                }
            }
            return results;
        }
        else {
            return index;
        }
    }
    async _loadIndex(storage) {
        const rootPath = this.rootDir;
        const dirs = await storage.fs.readdir(path.join(storage.workDir, rootPath));
        var idx = {};
        for (const dir of dirs) {
            if (dir != '.DS_Store') {
                let objData;
                try {
                    objData = await storage.loadObject(path.join(rootPath, dir));
                }
                catch (e) {
                    log.error(`Failed to load object from ${dir} when loading index ${this.rootDir}`);
                }
                if (objData) {
                    const obj = this.postLoad(objData);
                    if (obj.id) {
                        idx[obj.id] = obj;
                    }
                }
            }
        }
        return idx;
    }
    // TODO: Use `toUseableObject(data: any) => O` to post-process loaded data
    // Stores object in DB
    async store(obj, storage, updateIndex = true) {
        //log.debug(`SSE: StorageManager for ${this.rootDir}: Storing object ${obj.id}`);
        //log.silly(`SSE: StorageManager for ${this.rootDir}: Storing object ${obj.id}: ${JSON.stringify(obj)}`);
        const objDir = path.join(this.rootDir, `${obj.id}`);
        const objPath = path.join(storage.workDir, objDir);
        const storeable = this.toStoreableObject(obj);
        await storage.fs.ensureDir(objPath);
        for (const key of Object.keys(storeable)) {
            const data = storeable[key];
            await storage.yaml.store(path.join(objPath, `${key}.yaml`), data);
        }
        if (updateIndex === true) {
            //log.debug(`SSE: StorageManager for ${this.rootDir}: Storing object ${obj.id}: Updating index`);
            await this.updateIndexedItem(obj, storage);
        }
        return true;
    }
    async updateIndexedItem(obj, storage) {
        await this.getIndex(storage);
        this._index[obj.id] = obj;
    }
    toStoreableObject(obj) {
        return { meta: obj };
    }
    ;
    // Converts object data into valid object, if needed
    // (in cases when partial data is stored or migration took place previously)
    postLoad(obj) {
        return obj;
    }
    objectMatchesQuery(obj, query) {
        return false;
    }
}
export class Storage {
    constructor(fs, workDir, storeManagers) {
        this.fs = fs;
        this.workDir = workDir;
        this.storeManagers = storeManagers;
        this.fs = fs;
        this.workDir = workDir;
        this.yaml = new YAMLStorage(fs);
        this.workspace = Object.keys(storeManagers).reduce((obj, key) => {
            obj[key] = {};
            return obj;
        }, {});
    }
    async loadWorkspace() {
        // Loads workspace object with an index for each store manager
        this.workspace = await Object.keys(this.storeManagers).reduce(async (objP, key) => {
            const obj = await objP;
            obj[key] = await this.storeManagers[key].getIndex(this);
            return obj;
        }, Promise.resolve({}));
    }
    async storeWorkspace() {
        return Promise.all([...Object.keys(this.storeManagers).map(async (key) => {
                return await this.storeManagers[key].storeIndex(this, this.workspace[key]);
            })]).then(() => true);
    }
    // Loads object data from given directory, reading YAML files.
    // meta.yaml is treated specially, populating top-level object payload.
    // Other YAML files populate corresponding object properties.
    async loadObject(objDir) {
        let objData;
        const metaFile = path.join(this.workDir, objDir, 'meta.yaml');
        let metaFileIsFile;
        try {
            metaFileIsFile = (await this.fs.stat(metaFile)).isFile();
        }
        catch (e) {
            return undefined;
        }
        if (!metaFileIsFile) {
            return undefined;
        }
        objData = await this.yaml.load(metaFile) || {};
        const dirContents = await this.fs.readdir(path.join(this.workDir, objDir));
        for (const item of dirContents) {
            if (path.extname(item) == YAML_EXT) {
                const basename = path.basename(item, YAML_EXT);
                if (basename != 'meta') {
                    objData[basename] = await this.yaml.load(path.join(this.workDir, objDir, item));
                }
            }
        }
        // Blindly hope that data structure loaded from YAML
        // is valid for given type.
        return objData;
    }
    setUpAPIEndpoints(notifier) {
        log.verbose("SSE: Storage: Setting API endpoints");
        for (let indexName of Object.keys(this.workspace)) {
            listen(`storage-get-all-${indexName}`, async () => {
                return this.workspace[indexName];
            });
            listen(`storage-get-one-in-${indexName}`, async ({ objectId }) => {
                return this.workspace[indexName][objectId] || null;
            });
            listen(`storage-store-one-in-${indexName}`, async ({ objectId, newData }) => {
                await this.storeManagers[indexName].store(newData, this);
                notifier([indexName]);
                return { success: true };
            });
            listen(`storage-delete-one-in-${indexName}`, async ({ objectId }) => {
                delete this.workspace[indexName][objectId];
                // TODO: WARNING: Race condition, since storing the whole index may take a little while
                await this.storeManagers[indexName].storeIndex(this, this.workspace[indexName]);
                notifier([indexName]);
                return { success: true };
            });
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RvcmFnZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zdG9yYWdlL21haW4vc3RvcmFnZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEtBQUssSUFBSSxNQUFNLE1BQU0sQ0FBQztBQUM3QixPQUFPLEtBQUssR0FBRyxNQUFNLGNBQWMsQ0FBQztBQUVwQyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFLeEMsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLFFBQVEsQ0FBQztBQUdyQyxNQUFNLFFBQVEsR0FBRyxPQUFPLENBQUM7QUFHekIsTUFBTSxPQUFnQixZQUFZO0lBR2hDLFlBQW1CLE9BQWU7UUFBZixZQUFPLEdBQVAsT0FBTyxDQUFRO1FBRnhCLFdBQU0sR0FBeUIsU0FBUyxDQUFDO0lBRWQsQ0FBQztJQUUvQixLQUFLLENBQUMsVUFBVSxDQUFDLE9BQXFCLEVBQUUsTUFBNEI7UUFDekUsR0FBRyxDQUFDLEtBQUssQ0FBQywyQkFBMkIsSUFBSSxDQUFDLE9BQU8saUJBQWlCLENBQUMsQ0FBQztRQUVwRSxNQUFNLEdBQUcsR0FBYSxNQUFNLElBQUksTUFBTSxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQzdELE1BQU0sS0FBSyxHQUFRLE1BQU0sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFdEMsS0FBSyxNQUFNLEdBQUcsSUFBSSxLQUFLLEVBQUU7WUFDdkIsTUFBTSxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxPQUFPLEVBQUUsS0FBSyxDQUFDLENBQUM7U0FDdkM7UUFFRCxJQUFJLENBQUMsTUFBTSxHQUFHLEdBQUcsQ0FBQztRQUNsQixPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFFTSxLQUFLLENBQUMsUUFBUSxDQUFDLE9BQXFCO1FBQ3pDLElBQUksSUFBSSxDQUFDLE1BQU0sS0FBSyxTQUFTLEVBQUU7WUFDN0IsSUFB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QyxTQUFTLENBQUMsU0FBUyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUM7Z0JBRTNDLHVGQUF1RjtnQkFDdkYsTUFBTSxJQUFJLENBQUMsYUFBYSxDQUFDLFNBQVMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO2dCQUVoRixRQUFRLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO2dCQUN0QixPQUFPLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxDQUFDO1lBQzNCLENBQUMsQ0FBQyxDQUFDO1NBRUo7SUFDSCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0ICogYXMgbG9nIGZyb20gJ2VsZWN0cm9uLWxvZyc7XG5cbmltcG9ydCB7IGxpc3RlbiB9IGZyb20gJy4uLy4uL2FwaS9tYWluJztcblxuaW1wb3J0IHsgSW5kZXgsIEluZGV4YWJsZU9iamVjdCB9IGZyb20gJy4uL3F1ZXJ5JztcbmltcG9ydCB7IFdvcmtzcGFjZSB9IGZyb20gJy4uL3dvcmtzcGFjZSc7XG5cbmltcG9ydCB7IFlBTUxTdG9yYWdlIH0gZnJvbSAnLi95YW1sJztcblxuXG5jb25zdCBZQU1MX0VYVCA9ICcueWFtbCc7XG5cblxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIFN0b3JlTWFuYWdlcjxPIGV4dGVuZHMgSW5kZXhhYmxlT2JqZWN0PiB7XG4gIHByb3RlY3RlZCBfaW5kZXg6IEluZGV4PE8+IHwgdW5kZWZpbmVkID0gdW5kZWZpbmVkO1xuXG4gIGNvbnN0cnVjdG9yKHB1YmxpYyByb290RGlyOiBzdHJpbmcpIHt9XG5cbiAgcHVibGljIGFzeW5jIHN0b3JlSW5kZXgoc3RvcmFnZTogU3RvcmFnZTxhbnk+LCBuZXdJZHg6IEluZGV4PE8+IHwgdW5kZWZpbmVkKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgbG9nLmRlYnVnKGBTU0U6IFN0b3JhZ2VNYW5hZ2VyIGZvciAke3RoaXMucm9vdERpcn06IFN0b3JpbmcgaW5kZXhgKTtcblxuICAgIGNvbnN0IGlkeDogSW5kZXg8Tz4gPSBuZXdJZHggfHwgYXdhaXQgdGhpcy5nZXRJbmRleChzdG9yYWdlKTtcbiAgICBjb25zdCBpdGVtczogT1tdID0gT2JqZWN0LnZhbHVlcyhpZHgpO1xuXG4gICAgZm9yIChjb25zdCBvYmogb2YgaXRlbXMpIHtcbiAgICAgIGF3YWl0IHRoaXMuc3RvcmUob2JqLCBzdG9yYWdlLCBmYWxzZSk7XG4gICAgfVxuXG4gICAgdGhpcy5faW5kZXggPSBpZHg7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZ2V0SW5kZXgoc3RvcmFnZTogU3RvcmFnZTxhbnk+KTogUHJvbWlzZTxJbmRleDxPPj4ge1xuICAgIGlmICh0aGlzLl9pbmRleCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aGlzLl9pbmRleCA9IGF3YWl0IHRoaXMuX2xvYWRJbmRleChzdG9yYWdlKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuX2luZGV4O1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGZpbmRPYmplY3RzKHN0b3JhZ2U6IFN0b3JhZ2U8YW55PiwgcXVlcnk/OiBzdHJpbmcpOiBQcm9taXNlPEluZGV4PE8+PiB7XG4gICAgY29uc3QgaW5kZXggPSBhd2FpdCB0aGlzLmdldEluZGV4KHN0b3JhZ2UpO1xuICAgIGlmIChxdWVyeSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICB2YXIgcmVzdWx0czogSW5kZXg8Tz4gPSB7fTtcbiAgICAgIGZvciAobGV0IGtleSBvZiBPYmplY3Qua2V5cyhpbmRleCkpIHtcbiAgICAgICAgY29uc3Qgb2JqID0gaW5kZXhba2V5XVxuICAgICAgICBpZiAodGhpcy5vYmplY3RNYXRjaGVzUXVlcnkob2JqLCBxdWVyeSkpIHtcbiAgICAgICAgICByZXN1bHRzW2tleV0gPSBvYmo7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJldHVybiByZXN1bHRzO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gaW5kZXg7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBfbG9hZEluZGV4KHN0b3JhZ2U6IFN0b3JhZ2U8YW55Pik6IFByb21pc2U8SW5kZXg8Tz4+IHtcbiAgICBjb25zdCByb290UGF0aCA9IHRoaXMucm9vdERpcjtcbiAgICBjb25zdCBkaXJzID0gYXdhaXQgc3RvcmFnZS5mcy5yZWFkZGlyKHBhdGguam9pbihzdG9yYWdlLndvcmtEaXIsIHJvb3RQYXRoKSk7XG4gICAgdmFyIGlkeDogSW5kZXg8Tz4gPSB7fTtcblxuICAgIGZvciAoY29uc3QgZGlyIG9mIGRpcnMpIHtcbiAgICAgIGlmIChkaXIgIT0gJy5EU19TdG9yZScpIHtcbiAgICAgICAgbGV0IG9iakRhdGE6IGFueTtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBvYmpEYXRhID0gYXdhaXQgc3RvcmFnZS5sb2FkT2JqZWN0KHBhdGguam9pbihyb290UGF0aCwgZGlyKSk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICBsb2cuZXJyb3IoYEZhaWxlZCB0byBsb2FkIG9iamVjdCBmcm9tICR7ZGlyfSB3aGVuIGxvYWRpbmcgaW5kZXggJHt0aGlzLnJvb3REaXJ9YCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG9iakRhdGEpIHtcbiAgICAgICAgICBjb25zdCBvYmo6IE8gPSB0aGlzLnBvc3RMb2FkKG9iakRhdGEpO1xuICAgICAgICAgIGlmIChvYmouaWQpIHtcbiAgICAgICAgICAgIGlkeFtvYmouaWRdID0gb2JqO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gaWR4O1xuICB9XG5cbiAgLy8gVE9ETzogVXNlIGB0b1VzZWFibGVPYmplY3QoZGF0YTogYW55KSA9PiBPYCB0byBwb3N0LXByb2Nlc3MgbG9hZGVkIGRhdGFcblxuICAvLyBTdG9yZXMgb2JqZWN0IGluIERCXG4gIHB1YmxpYyBhc3luYyBzdG9yZShvYmo6IE8sIHN0b3JhZ2U6IFN0b3JhZ2U8YW55PiwgdXBkYXRlSW5kZXggPSB0cnVlKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgLy9sb2cuZGVidWcoYFNTRTogU3RvcmFnZU1hbmFnZXIgZm9yICR7dGhpcy5yb290RGlyfTogU3RvcmluZyBvYmplY3QgJHtvYmouaWR9YCk7XG4gICAgLy9sb2cuc2lsbHkoYFNTRTogU3RvcmFnZU1hbmFnZXIgZm9yICR7dGhpcy5yb290RGlyfTogU3RvcmluZyBvYmplY3QgJHtvYmouaWR9OiAke0pTT04uc3RyaW5naWZ5KG9iail9YCk7XG5cbiAgICBjb25zdCBvYmpEaXIgPSBwYXRoLmpvaW4odGhpcy5yb290RGlyLCBgJHtvYmouaWR9YCk7XG4gICAgY29uc3Qgb2JqUGF0aCA9IHBhdGguam9pbihzdG9yYWdlLndvcmtEaXIsIG9iakRpcik7XG4gICAgY29uc3Qgc3RvcmVhYmxlID0gdGhpcy50b1N0b3JlYWJsZU9iamVjdChvYmopO1xuXG4gICAgYXdhaXQgc3RvcmFnZS5mcy5lbnN1cmVEaXIob2JqUGF0aCk7XG4gICAgZm9yIChjb25zdCBrZXkgb2YgT2JqZWN0LmtleXMoc3RvcmVhYmxlKSkge1xuICAgICAgY29uc3QgZGF0YSA9IHN0b3JlYWJsZVtrZXldO1xuICAgICAgYXdhaXQgc3RvcmFnZS55YW1sLnN0b3JlKHBhdGguam9pbihvYmpQYXRoLCBgJHtrZXl9LnlhbWxgKSwgZGF0YSk7XG4gICAgfVxuXG4gICAgaWYgKHVwZGF0ZUluZGV4ID09PSB0cnVlKSB7XG4gICAgICAvL2xvZy5kZWJ1ZyhgU1NFOiBTdG9yYWdlTWFuYWdlciBmb3IgJHt0aGlzLnJvb3REaXJ9OiBTdG9yaW5nIG9iamVjdCAke29iai5pZH06IFVwZGF0aW5nIGluZGV4YCk7XG4gICAgICBhd2FpdCB0aGlzLnVwZGF0ZUluZGV4ZWRJdGVtKG9iaiwgc3RvcmFnZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgdXBkYXRlSW5kZXhlZEl0ZW0ob2JqOiBPLCBzdG9yYWdlOiBTdG9yYWdlPGFueT4pIHtcbiAgICBhd2FpdCB0aGlzLmdldEluZGV4KHN0b3JhZ2UpO1xuICAgICh0aGlzLl9pbmRleCBhcyBJbmRleDxPPilbb2JqLmlkXSA9IG9iajtcbiAgfVxuXG4gIHB1YmxpYyB0b1N0b3JlYWJsZU9iamVjdChvYmo6IE8pOiBhbnkge1xuICAgIHJldHVybiB7IG1ldGE6IG9iaiBhcyBhbnkgfTtcbiAgfTtcblxuICAvLyBDb252ZXJ0cyBvYmplY3QgZGF0YSBpbnRvIHZhbGlkIG9iamVjdCwgaWYgbmVlZGVkXG4gIC8vIChpbiBjYXNlcyB3aGVuIHBhcnRpYWwgZGF0YSBpcyBzdG9yZWQgb3IgbWlncmF0aW9uIHRvb2sgcGxhY2UgcHJldmlvdXNseSlcbiAgcHVibGljIHBvc3RMb2FkKG9iajogYW55KTogTyB7XG4gICAgcmV0dXJuIG9iaiBhcyBPO1xuICB9XG5cbiAgcHVibGljIG9iamVjdE1hdGNoZXNRdWVyeShvYmo6IE8sIHF1ZXJ5OiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbn1cblxuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgU3RvcmFnZTxXIGV4dGVuZHMgV29ya3NwYWNlPiB7XG4gIHB1YmxpYyB5YW1sOiBZQU1MU3RvcmFnZTtcbiAgcHVibGljIHdvcmtzcGFjZTogVztcblxuICBjb25zdHJ1Y3RvcihwdWJsaWMgZnM6IHR5cGVvZiBpbXBvcnQoJ2ZzLWV4dHJhJyksIHB1YmxpYyB3b3JrRGlyOiBzdHJpbmcsXG4gICAgICBwdWJsaWMgc3RvcmVNYW5hZ2VyczogeyBba2V5OiBzdHJpbmddOiBTdG9yZU1hbmFnZXI8YW55PiB9KSB7XG4gICAgdGhpcy5mcyA9IGZzO1xuICAgIHRoaXMud29ya0RpciA9IHdvcmtEaXI7XG4gICAgdGhpcy55YW1sID0gbmV3IFlBTUxTdG9yYWdlKGZzKTtcblxuICAgIHRoaXMud29ya3NwYWNlID0gT2JqZWN0LmtleXMoc3RvcmVNYW5hZ2VycykucmVkdWNlKChvYmo6IGFueSwga2V5OiBzdHJpbmcpID0+IHtcbiAgICAgIG9ialtrZXldID0ge307XG4gICAgICByZXR1cm4gb2JqO1xuICAgIH0sIHt9KSBhcyBXO1xuICB9XG5cbiAgcHVibGljIGFic3RyYWN0IGFzeW5jIGZpbmRPYmplY3RzKHF1ZXJ5Pzogc3RyaW5nKTogUHJvbWlzZTxXPlxuXG4gIHB1YmxpYyBhc3luYyBsb2FkV29ya3NwYWNlKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIC8vIExvYWRzIHdvcmtzcGFjZSBvYmplY3Qgd2l0aCBhbiBpbmRleCBmb3IgZWFjaCBzdG9yZSBtYW5hZ2VyXG4gICAgdGhpcy53b3Jrc3BhY2UgPSBhd2FpdCBPYmplY3Qua2V5cyh0aGlzLnN0b3JlTWFuYWdlcnMpLnJlZHVjZShhc3luYyAob2JqUDogUHJvbWlzZTxhbnk+LCBrZXk6IHN0cmluZykgPT4ge1xuICAgICAgY29uc3Qgb2JqID0gYXdhaXQgb2JqUDtcbiAgICAgIG9ialtrZXldID0gYXdhaXQgdGhpcy5zdG9yZU1hbmFnZXJzW2tleV0uZ2V0SW5kZXgodGhpcyk7XG4gICAgICByZXR1cm4gb2JqO1xuICAgIH0sIFByb21pc2UucmVzb2x2ZSh7fSkpIGFzIFc7XG4gIH1cblxuICBhc3luYyBzdG9yZVdvcmtzcGFjZSgpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICByZXR1cm4gUHJvbWlzZS5hbGwoWy4uLk9iamVjdC5rZXlzKHRoaXMuc3RvcmVNYW5hZ2VycykubWFwKGFzeW5jIChrZXkpID0+IHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLnN0b3JlTWFuYWdlcnNba2V5XS5zdG9yZUluZGV4KHRoaXMsIHRoaXMud29ya3NwYWNlW2tleV0pO1xuICAgIH0pXSkudGhlbigoKSA9PiB0cnVlKTtcbiAgfVxuXG4gIC8vIExvYWRzIG9iamVjdCBkYXRhIGZyb20gZ2l2ZW4gZGlyZWN0b3J5LCByZWFkaW5nIFlBTUwgZmlsZXMuXG4gIC8vIG1ldGEueWFtbCBpcyB0cmVhdGVkIHNwZWNpYWxseSwgcG9wdWxhdGluZyB0b3AtbGV2ZWwgb2JqZWN0IHBheWxvYWQuXG4gIC8vIE90aGVyIFlBTUwgZmlsZXMgcG9wdWxhdGUgY29ycmVzcG9uZGluZyBvYmplY3QgcHJvcGVydGllcy5cbiAgcHVibGljIGFzeW5jIGxvYWRPYmplY3Qob2JqRGlyOiBzdHJpbmcpOiBQcm9taXNlPGFueSB8IHVuZGVmaW5lZD4ge1xuICAgIGxldCBvYmpEYXRhOiB7W3Byb3BOYW1lOiBzdHJpbmddOiBhbnl9O1xuXG4gICAgY29uc3QgbWV0YUZpbGUgPSBwYXRoLmpvaW4odGhpcy53b3JrRGlyLCBvYmpEaXIsICdtZXRhLnlhbWwnKTtcbiAgICBsZXQgbWV0YUZpbGVJc0ZpbGU6IGJvb2xlYW47XG4gICAgdHJ5IHtcbiAgICAgIG1ldGFGaWxlSXNGaWxlID0gKGF3YWl0IHRoaXMuZnMuc3RhdChtZXRhRmlsZSkpLmlzRmlsZSgpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuICAgIGlmICghbWV0YUZpbGVJc0ZpbGUpIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuICAgIG9iakRhdGEgPSBhd2FpdCB0aGlzLnlhbWwubG9hZChtZXRhRmlsZSkgfHwge307XG5cbiAgICBjb25zdCBkaXJDb250ZW50cyA9IGF3YWl0IHRoaXMuZnMucmVhZGRpcihwYXRoLmpvaW4odGhpcy53b3JrRGlyLCBvYmpEaXIpKTtcbiAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgZGlyQ29udGVudHMpIHtcbiAgICAgIGlmIChwYXRoLmV4dG5hbWUoaXRlbSkgPT0gWUFNTF9FWFQpIHtcbiAgICAgICAgY29uc3QgYmFzZW5hbWUgPSBwYXRoLmJhc2VuYW1lKGl0ZW0sIFlBTUxfRVhUKTtcbiAgICAgICAgaWYgKGJhc2VuYW1lICE9ICdtZXRhJykge1xuICAgICAgICAgIG9iakRhdGFbYmFzZW5hbWVdID0gYXdhaXQgdGhpcy55YW1sLmxvYWQocGF0aC5qb2luKHRoaXMud29ya0Rpciwgb2JqRGlyLCBpdGVtKSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBCbGluZGx5IGhvcGUgdGhhdCBkYXRhIHN0cnVjdHVyZSBsb2FkZWQgZnJvbSBZQU1MXG4gICAgLy8gaXMgdmFsaWQgZm9yIGdpdmVuIHR5cGUuXG4gICAgcmV0dXJuIG9iakRhdGE7XG4gIH1cblxuICBzZXRVcEFQSUVuZHBvaW50cyhub3RpZmllcjogKG5vdGlmeTogc3RyaW5nW10pID0+IHZvaWQpIHtcbiAgICBsb2cudmVyYm9zZShcIlNTRTogU3RvcmFnZTogU2V0dGluZyBBUEkgZW5kcG9pbnRzXCIpO1xuXG4gICAgZm9yIChsZXQgaW5kZXhOYW1lIG9mIE9iamVjdC5rZXlzKHRoaXMud29ya3NwYWNlKSkge1xuXG4gICAgICBsaXN0ZW48e30sIEluZGV4PGFueT4+XG4gICAgICAoYHN0b3JhZ2UtZ2V0LWFsbC0ke2luZGV4TmFtZX1gLCBhc3luYyAoKSA9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLndvcmtzcGFjZVtpbmRleE5hbWVdO1xuICAgICAgfSk7XG5cbiAgICAgIGxpc3Rlbjx7IG9iamVjdElkOiBzdHJpbmcgfSwgSW5kZXhhYmxlT2JqZWN0PlxuICAgICAgKGBzdG9yYWdlLWdldC1vbmUtaW4tJHtpbmRleE5hbWV9YCwgYXN5bmMgKHsgb2JqZWN0SWQgfSkgPT4ge1xuICAgICAgICByZXR1cm4gdGhpcy53b3Jrc3BhY2VbaW5kZXhOYW1lXVtvYmplY3RJZF0gfHwgbnVsbDtcbiAgICAgIH0pO1xuXG4gICAgICBsaXN0ZW48eyBvYmplY3RJZDogc3RyaW5nLCBuZXdEYXRhOiBJbmRleGFibGVPYmplY3QgIH0sIHsgc3VjY2VzczogYm9vbGVhbiB9PlxuICAgICAgKGBzdG9yYWdlLXN0b3JlLW9uZS1pbi0ke2luZGV4TmFtZX1gLCBhc3luYyAoeyBvYmplY3RJZCwgbmV3RGF0YSB9KSA9PiB7XG4gICAgICAgIGF3YWl0IHRoaXMuc3RvcmVNYW5hZ2Vyc1tpbmRleE5hbWVdLnN0b3JlKG5ld0RhdGEsIHRoaXMpO1xuICAgICAgICBub3RpZmllcihbaW5kZXhOYW1lXSk7XG4gICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUgfTtcbiAgICAgIH0pO1xuXG4gICAgICBsaXN0ZW48eyBvYmplY3RJZDogc3RyaW5nIH0sIHsgc3VjY2VzczogYm9vbGVhbiB9PlxuICAgICAgKGBzdG9yYWdlLWRlbGV0ZS1vbmUtaW4tJHtpbmRleE5hbWV9YCwgYXN5bmMgKHsgb2JqZWN0SWQgfSkgPT4ge1xuICAgICAgICBkZWxldGUgdGhpcy53b3Jrc3BhY2VbaW5kZXhOYW1lXVtvYmplY3RJZF07XG5cbiAgICAgICAgLy8gVE9ETzogV0FSTklORzogUmFjZSBjb25kaXRpb24sIHNpbmNlIHN0b3JpbmcgdGhlIHdob2xlIGluZGV4IG1heSB0YWtlIGEgbGl0dGxlIHdoaWxlXG4gICAgICAgIGF3YWl0IHRoaXMuc3RvcmVNYW5hZ2Vyc1tpbmRleE5hbWVdLnN0b3JlSW5kZXgodGhpcywgdGhpcy53b3Jrc3BhY2VbaW5kZXhOYW1lXSk7XG5cbiAgICAgICAgbm90aWZpZXIoW2luZGV4TmFtZV0pO1xuICAgICAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlIH07XG4gICAgICB9KTtcblxuICAgIH1cbiAgfVxufVxuIl19