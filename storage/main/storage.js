import * as path from 'path';
import { makeEndpoint } from '../../api/main';
import { YAMLStorage } from './yaml';
const YAML_EXT = '.yaml';
export class StoreManager {
    constructor(rootDir) {
        this.rootDir = rootDir;
        this._index = undefined;
    }
    async storeIndex(storage, newIdx) {
        const idx = newIdx || await this.getIndex(storage);
        const items = Object.values(idx);
        for (const obj of items) {
            await this.store(obj, storage);
        }
        this._index = idx;
        return true;
    }
    async getIndex(storage) {
        if (this._index === undefined) {
            this._index = await this._loadIndex(storage);
        }
        return this._index;
    }
    async findObjects(storage, query) {
        const index = await this.getIndex(storage);
        if (query !== undefined) {
            var results = {};
            for (let key of Object.keys(index)) {
                const obj = index[key];
                if (this.objectMatchesQuery(obj, query)) {
                    results[key] = obj;
                }
            }
            return results;
        }
        else {
            return index;
        }
    }
    async _loadIndex(storage) {
        const rootPath = this.rootDir;
        const dirs = await storage.fs.readdir(path.join(storage.workDir, rootPath));
        var idx = {};
        for (const dir of dirs) {
            if (dir != '.DS_Store') {
                const objData = await storage.loadObject(path.join(rootPath, dir));
                if (objData) {
                    const obj = this.postLoad(objData);
                    if (obj.id) {
                        idx[obj.id] = obj;
                    }
                }
            }
        }
        return idx;
    }
    // TODO: Use `toUseableObject(data: any) => O` to post-process loaded data
    // Stores object in DB
    async store(obj, storage) {
        const objDir = path.join(this.rootDir, `${obj.id}`);
        const objPath = path.join(storage.workDir, objDir);
        const storeable = this.toStoreableObject(obj);
        const idx = await this.getIndex(storage);
        await storage.fs.ensureDir(objPath);
        for (const key of Object.keys(storeable)) {
            const data = storeable[key];
            await storage.yaml.store(path.join(objPath, `${key}.yaml`), data);
        }
        idx[obj.id] = obj;
        this._index = idx;
        return true;
    }
    toStoreableObject(obj) {
        return { meta: obj };
    }
    ;
    // Converts object data into valid object, if needed
    // (in cases when partial data is stored or migration took place previously)
    postLoad(obj) {
        return obj;
    }
    objectMatchesQuery(obj, query) {
        return false;
    }
}
export class Storage {
    constructor(fs, workDir, storeManagers) {
        this.fs = fs;
        this.workDir = workDir;
        this.storeManagers = storeManagers;
        this.fs = fs;
        this.workDir = workDir;
        this.yaml = new YAMLStorage(fs);
        this.workspace = Object.keys(storeManagers).reduce((obj, key) => {
            obj[key] = {};
            return obj;
        }, {});
    }
    async loadWorkspace() {
        this.workspace = await Object.keys(this.storeManagers).reduce(async (objP, key) => {
            const obj = await objP;
            obj[key] = await this.storeManagers[key].getIndex(this);
            return obj;
        }, Promise.resolve({}));
    }
    async storeWorkspace() {
        return Promise.all([...Object.keys(this.storeManagers).map(async (key) => {
                return await this.storeManagers[key].storeIndex(this, this.workspace[key]);
            })]).then(() => true);
    }
    // Loads object data from given directory, reading YAML files.
    // meta.yaml is treated specially, populating top-level object payload.
    // Other YAML files populate corresponding object properties.
    async loadObject(objDir) {
        let objData;
        const metaFile = path.join(this.workDir, objDir, 'meta.yaml');
        let metaFileIsFile;
        try {
            metaFileIsFile = (await this.fs.stat(metaFile)).isFile();
        }
        catch (e) {
            return undefined;
        }
        if (!metaFileIsFile) {
            return undefined;
        }
        objData = await this.yaml.load(metaFile);
        const dirContents = await this.fs.readdir(path.join(this.workDir, objDir));
        for (const item of dirContents) {
            if (path.extname(item) == YAML_EXT) {
                const basename = path.basename(item, YAML_EXT);
                if (basename != 'meta') {
                    objData[basename] = await this.yaml.load(path.join(this.workDir, objDir, item));
                }
            }
        }
        // Blindly hope that data structure loaded from YAML
        // is valid for given type.
        return objData;
    }
    setUpAPIEndpoints(notifier) {
        for (let indexName of Object.keys(this.workspace)) {
            makeEndpoint(`storage-${indexName}-all`, async () => {
                return this.workspace[indexName];
            }, async ({ newData, notify }) => {
                await this.storeManagers[indexName].storeIndex(this, newData);
                notifier([indexName, ...(notify || [])]);
            });
            makeEndpoint(`storage-${indexName}`, async ({ objectId }) => {
                return this.workspace[indexName][objectId];
            }, async ({ newData, notify }) => {
                await this.storeManagers[indexName].store(newData, this);
                notifier([indexName, ...(notify || [])]);
            });
            makeEndpoint(`storage-${indexName}-delete`, async ({ objectId }) => {
                delete this.workspace[indexName][objectId];
                await this.storeManagers[indexName].storeIndex(this, this.workspace[indexName]);
                return true;
            });
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RvcmFnZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zdG9yYWdlL21haW4vc3RvcmFnZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEtBQUssSUFBSSxNQUFNLE1BQU0sQ0FBQztBQUU3QixPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFLOUMsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLFFBQVEsQ0FBQztBQUdyQyxNQUFNLFFBQVEsR0FBRyxPQUFPLENBQUM7QUFHekIsTUFBTSxPQUFnQixZQUFZO0lBR2hDLFlBQW1CLE9BQWU7UUFBZixZQUFPLEdBQVAsT0FBTyxDQUFRO1FBRjFCLFdBQU0sR0FBeUIsU0FBUyxDQUFDO0lBRVosQ0FBQztJQUUvQixLQUFLLENBQUMsVUFBVSxDQUFDLE9BQXFCLEVBQUUsTUFBNEI7UUFDekUsTUFBTSxHQUFHLEdBQWEsTUFBTSxJQUFJLE1BQU0sSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUM3RCxNQUFNLEtBQUssR0FBUSxNQUFNLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRXRDLEtBQUssTUFBTSxHQUFHLElBQUksS0FBSyxFQUFFO1lBQ3ZCLE1BQU0sSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLENBQUM7U0FDaEM7UUFFRCxJQUFJLENBQUMsTUFBTSxHQUFHLEdBQUcsQ0FBQztRQUNsQixPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFFTSxLQUFLLENBQUMsUUFBUSxDQUFDLE9BQXFCO1FBQ3pDLElBQUksSUFBSSxDQUFDLE1BQU0sS0FBSyxTQUFTLEVBQUU7WUFDN0IsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLElBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUM7U0FDOUM7UUFDRCxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUM7SUFDckIsQ0FBQztJQUVNLEtB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QU8sQ0FBQyxDQUFDO2dCQUM5RCxRQUFRLENBQUMsQ0FBQyxTQUFTLEVBQUUsR0FBRyxDQUFDLE1BQU0sSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDM0MsQ0FBQyxDQUFDLENBQUM7WUFFSCxZQUFZLENBQWtCLFdBQVcsU0FBUyxFQUFFLEVBQUUsS0FBSyxFQUFFLEVBQUUsUUFBUSxFQUF3QixFQUFFLEVBQUU7Z0JBQ2pHLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUM3QyxDQUFDLEVBQUUsS0FBSyxFQUFFLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFLEVBQUU7Z0JBQy9CLE1BQU0sSUFBSSxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxDQUFDO2dCQUN6RCxRQUFRLENBQUMsQ0FBQyxTQUFTLEVBQUUsR0FBRyxDQUFDLE1BQU0sSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDM0MsQ0FBQyxDQUFDLENBQUM7WUFFSCxZQUFZLENBQVUsV0FBVyxTQUFTLFNBQVMsRUFBRSxLQUFLLEVBQUUsRUFBRSxRQUFRLEVBQXdCLEVBQUUsRUFBRTtnQkFDaEcsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDO2dCQUMzQyxNQUFNLElBQUksQ0FBQyxhQUFhLENBQUMsU0FBUyxDQUFDLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7Z0JBQ2hGLE9BQU8sSUFBSSxDQUFDO1lBQ2QsQ0FBQyxDQUFDLENBQUM7U0FFSjtJQUNILENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5cbmltcG9ydCB7IG1ha2VFbmRwb2ludCB9IGZyb20gJy4uLy4uL2FwaS9tYWluJztcblxuaW1wb3J0IHsgSW5kZXgsIEluZGV4YWJsZU9iamVjdCB9IGZyb20gJy4uL3F1ZXJ5JztcbmltcG9ydCB7IFdvcmtzcGFjZSB9IGZyb20gJy4uL3dvcmtzcGFjZSc7XG5cbmltcG9ydCB7IFlBTUxTdG9yYWdlIH0gZnJvbSAnLi95YW1sJztcblxuXG5jb25zdCBZQU1MX0VYVCA9ICcueWFtbCc7XG5cblxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIFN0b3JlTWFuYWdlcjxPIGV4dGVuZHMgSW5kZXhhYmxlT2JqZWN0PiB7XG4gIHByaXZhdGUgX2luZGV4OiBJbmRleDxPPiB8IHVuZGVmaW5lZCA9IHVuZGVmaW5lZDtcblxuICBjb25zdHJ1Y3RvcihwdWJsaWMgcm9vdERpcjogc3RyaW5nKSB7fVxuXG4gIHB1YmxpYyBhc3luYyBzdG9yZUluZGV4KHN0b3JhZ2U6IFN0b3JhZ2U8YW55PiwgbmV3SWR4OiBJbmRleDxPPiB8IHVuZGVmaW5lZCk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIGNvbnN0IGlkeDogSW5kZXg8Tz4gPSBuZXdJZHggfHwgYXdhaXQgdGhpcy5nZXRJbmRleChzdG9yYWdlKTtcbiAgICBjb25zdCBpdGVtczogT1tdID0gT2JqZWN0LnZhbHVlcyhpZHgpO1xuXG4gICAgZm9yIChjb25zdCBvYmogb2YgaXRlbXMpIHtcbiAgICAgIGF3YWl0IHRoaXMuc3RvcmUob2JqLCBzdG9yYWdlKTtcbiAgICB9XG5cbiAgICB0aGlzLl9pbmRleCA9IGlkeDtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBnZXRJbmRleChzdG9yYWdlOiBTdG9yYWdlPGFueT4pOiBQcm9taXNlPEluZGV4PE8+PiB7XG4gICAgaWYgKHRoaXMuX2luZGV4ID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHRoaXMuX2luZGV4ID0gYXdhaXQgdGhpcy5fbG9hZEluZGV4KHN0b3JhZ2UpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5faW5kZXg7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZmluZE9iamVjdHMoc3RvcmFnZTogU3RvcmFnZTxhbnk+LCBxdWVyeT86IHN0cmluZyk6IFByb21pc2U8SW5kZXg8Tz4+IHtcbiAgICBjb25zdCBpbmRleCA9IGF3YWl0IHRoaXMuZ2V0SW5kZXgoc3RvcmFnZSk7XG4gICAgaWYgKHF1ZXJ5ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHZhciByZXN1bHRzOiBJbmRleDxPPiA9IHt9O1xuICAgICAgZm9yIChsZXQga2V5IG9mIE9iamVjdC5rZXlzKGluZGV4KSkge1xuICAgICAgICBjb25zdCBvYmogPSBpbmRleFtrZXldXG4gICAgICAgIGlmICh0aGlzLm9iamVjdE1hdGNoZXNRdWVyeShvYmosIHF1ZXJ5KSkge1xuICAgICAgICAgIHJlc3VsdHNba2V5XSA9IG9iajtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcmV0dXJuIHJlc3VsdHM7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBpbmRleDtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIF9sb2FkSW5kZXgoc3RvcmFnZTogU3RvcmFnZTxhbnk+KTogUHJvbWlzZTxJbmRleDxPPj4ge1xuICAgIGNvbnN0IHJvb3RQYXRoID0gdGhpcy5yb290RGlyO1xuICAgIGNvbnN0IGRpcnMgPSBhd2FpdCBzdG9yYWdlLmZzLnJlYWRkaXIocGF0aC5qb2luKHN0b3JhZ2Uud29ya0Rpciwgcm9vdFBhdGgpKTtcbiAgICB2YXIgaWR4OiBJbmRleDxPPiA9IHt9O1xuXG4gICAgZm9yIChjb25zdCBkaXIgb2YgZGlycykge1xuICAgICAgaWYgKGRpciAhPSAnLkRTX1N0b3JlJykge1xuICAgICAgICBjb25zdCBvYmpEYXRhID0gYXdhaXQgc3RvcmFnZS5sb2FkT2JqZWN0KHBhdGguam9pbihyb290UGF0aCwgZGlyKSk7XG4gICAgICAgIGlmIChvYmpEYXRhKSB7XG4gICAgICAgICAgY29uc3Qgb2JqOiBPID0gdGhpcy5wb3N0TG9hZChvYmpEYXRhKTtcbiAgICAgICAgICBpZiAob2JqLmlkKSB7XG4gICAgICAgICAgICBpZHhbb2JqLmlkXSA9IG9iajtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGlkeDtcbiAgfVxuXG4gIC8vIFRPRE86IFVzZSBgdG9Vc2VhYmxlT2JqZWN0KGRhdGE6IGFueSkgPT4gT2AgdG8gcG9zdC1wcm9jZXNzIGxvYWRlZCBkYXRhXG5cbiAgLy8gU3RvcmVzIG9iamVjdCBpbiBEQlxuICBwdWJsaWMgYXN5bmMgc3RvcmUob2JqOiBPLCBzdG9yYWdlOiBTdG9yYWdlPGFueT4pOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBjb25zdCBvYmpEaXIgPSBwYXRoLmpvaW4odGhpcy5yb290RGlyLCBgJHtvYmouaWR9YCk7XG4gICAgY29uc3Qgb2JqUGF0aCA9IHBhdGguam9pbihzdG9yYWdlLndvcmtEaXIsIG9iakRpcik7XG4gICAgY29uc3Qgc3RvcmVhYmxlID0gdGhpcy50b1N0b3JlYWJsZU9iamVjdChvYmopO1xuICAgIGNvbnN0IGlkeCA9IGF3YWl0IHRoaXMuZ2V0SW5kZXgoc3RvcmFnZSk7XG5cbiAgICBhd2FpdCBzdG9yYWdlLmZzLmVuc3VyZURpcihvYmpQYXRoKTtcbiAgICBmb3IgKGNvbnN0IGtleSBvZiBPYmplY3Qua2V5cyhzdG9yZWFibGUpKSB7XG4gICAgICBjb25zdCBkYXRhID0gc3RvcmVhYmxlW2tleV07XG4gICAgICBhd2FpdCBzdG9yYWdlLnlhbWwuc3RvcmUocGF0aC5qb2luKG9ialBhdGgsIGAke2tleX0ueWFtbGApLCBkYXRhKTtcbiAgICB9XG5cbiAgICBpZHhbb2JqLmlkXSA9IG9iajtcbiAgICB0aGlzLl9pbmRleCA9IGlkeDtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIHB1YmxpYyB0b1N0b3JlYWJsZU9iamVjdChvYmo6IE8pOiBhbnkge1xuICAgIHJldHVybiB7IG1ldGE6IG9iaiBhcyBhbnkgfTtcbiAgfTtcblxuICAvLyBDb252ZXJ0cyBvYmplY3QgZGF0YSBpbnRvIHZhbGlkIG9iamVjdCwgaWYgbmVlZGVkXG4gIC8vIChpbiBjYXNlcyB3aGVuIHBhcnRpYWwgZGF0YSBpcyBzdG9yZWQgb3IgbWlncmF0aW9uIHRvb2sgcGxhY2UgcHJldmlvdXNseSlcbiAgcHVibGljIHBvc3RMb2FkKG9iajogYW55KTogTyB7XG4gICAgcmV0dXJuIG9iaiBhcyBPO1xuICB9XG5cbiAgcHVibGljIG9iamVjdE1hdGNoZXNRdWVyeShvYmo6IE8sIHF1ZXJ5OiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbn1cblxuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgU3RvcmFnZTxXIGV4dGVuZHMgV29ya3NwYWNlPiB7XG4gIHB1YmxpYyB5YW1sOiBZQU1MU3RvcmFnZTtcbiAgcHVibGljIHdvcmtzcGFjZTogVztcblxuICBjb25zdHJ1Y3RvcihwdWJsaWMgZnM6IHR5cGVvZiBpbXBvcnQoJ2ZzLWV4dHJhJyksIHB1YmxpYyB3b3JrRGlyOiBzdHJpbmcsXG4gICAgICBwdWJsaWMgc3RvcmVNYW5hZ2VyczogeyBba2V5OiBzdHJpbmddOiBTdG9yZU1hbmFnZXI8YW55PiB9KSB7XG4gICAgdGhpcy5mcyA9IGZzO1xuICAgIHRoaXMud29ya0RpciA9IHdvcmtEaXI7XG4gICAgdGhpcy55YW1sID0gbmV3IFlBTUxTdG9yYWdlKGZzKTtcblxuICAgIHRoaXMud29ya3NwYWNlID0gT2JqZWN0LmtleXMoc3RvcmVNYW5hZ2VycykucmVkdWNlKChvYmo6IGFueSwga2V5OiBzdHJpbmcpID0+IHtcbiAgICAgIG9ialtrZXldID0ge307XG4gICAgICByZXR1cm4gb2JqO1xuICAgIH0sIHt9KSBhcyBXO1xuICB9XG5cbiAgcHVibGljIGFic3RyYWN0IGFzeW5jIGZpbmRPYmplY3RzKHF1ZXJ5Pzogc3RyaW5nKTogUHJvbWlzZTxXPlxuXG4gIHB1YmxpYyBhc3luYyBsb2FkV29ya3NwYWNlKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRoaXMud29ya3NwYWNlID0gYXdhaXQgT2JqZWN0LmtleXModGhpcy5zdG9yZU1hbmFnZXJzKS5yZWR1Y2UoYXN5bmMgKG9ialA6IFByb21pc2U8YW55Piwga2V5OiBzdHJpbmcpID0+IHtcbiAgICAgIGNvbnN0IG9iaiA9IGF3YWl0IG9ialA7XG4gICAgICBvYmpba2V5XSA9IGF3YWl0IHRoaXMuc3RvcmVNYW5hZ2Vyc1trZXldLmdldEluZGV4KHRoaXMpO1xuICAgICAgcmV0dXJuIG9iajtcbiAgICB9LCBQcm9taXNlLnJlc29sdmUoe30pKSBhcyBXO1xuICB9XG5cbiAgYXN5bmMgc3RvcmVXb3Jrc3BhY2UoKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgcmV0dXJuIFByb21pc2UuYWxsKFsuLi5PYmplY3Qua2V5cyh0aGlzLnN0b3JlTWFuYWdlcnMpLm1hcChhc3luYyAoa2V5KSA9PiB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5zdG9yZU1hbmFnZXJzW2tleV0uc3RvcmVJbmRleCh0aGlzLCB0aGlzLndvcmtzcGFjZVtrZXldKTtcbiAgICB9KV0pLnRoZW4oKCkgPT4gdHJ1ZSk7XG4gIH1cblxuICAvLyBMb2FkcyBvYmplY3QgZGF0YSBmcm9tIGdpdmVuIGRpcmVjdG9yeSwgcmVhZGluZyBZQU1MIGZpbGVzLlxuICAvLyBtZXRhLnlhbWwgaXMgdHJlYXRlZCBzcGVjaWFsbHksIHBvcHVsYXRpbmcgdG9wLWxldmVsIG9iamVjdCBwYXlsb2FkLlxuICAvLyBPdGhlciBZQU1MIGZpbGVzIHBvcHVsYXRlIGNvcnJlc3BvbmRpbmcgb2JqZWN0IHByb3BlcnRpZXMuXG4gIHB1YmxpYyBhc3luYyBsb2FkT2JqZWN0KG9iakRpcjogc3RyaW5nKTogUHJvbWlzZTxhbnkgfCB1bmRlZmluZWQ+IHtcbiAgICBsZXQgb2JqRGF0YToge1twcm9wTmFtZTogc3RyaW5nXTogYW55fTtcblxuICAgIGNvbnN0IG1ldGFGaWxlID0gcGF0aC5qb2luKHRoaXMud29ya0Rpciwgb2JqRGlyLCAnbWV0YS55YW1sJyk7XG4gICAgbGV0IG1ldGFGaWxlSXNGaWxlOiBib29sZWFuO1xuICAgIHRyeSB7XG4gICAgICBtZXRhRmlsZUlzRmlsZSA9IChhd2FpdCB0aGlzLmZzLnN0YXQobWV0YUZpbGUpKS5pc0ZpbGUoKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cbiAgICBpZiAoIW1ldGFGaWxlSXNGaWxlKSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cbiAgICBvYmpEYXRhID0gYXdhaXQgdGhpcy55YW1sLmxvYWQobWV0YUZpbGUpO1xuXG4gICAgY29uc3QgZGlyQ29udGVudHMgPSBhd2FpdCB0aGlzLmZzLnJlYWRkaXIocGF0aC5qb2luKHRoaXMud29ya0Rpciwgb2JqRGlyKSk7XG4gICAgZm9yIChjb25zdCBpdGVtIG9mIGRpckNvbnRlbnRzKSB7XG4gICAgICBpZiAocGF0aC5leHRuYW1lKGl0ZW0pID09IFlBTUxfRVhUKSB7XG4gICAgICAgIGNvbnN0IGJhc2VuYW1lID0gcGF0aC5iYXNlbmFtZShpdGVtLCBZQU1MX0VYVCk7XG4gICAgICAgIGlmIChiYXNlbmFtZSAhPSAnbWV0YScpIHtcbiAgICAgICAgICBvYmpEYXRhW2Jhc2VuYW1lXSA9IGF3YWl0IHRoaXMueWFtbC5sb2FkKHBhdGguam9pbih0aGlzLndvcmtEaXIsIG9iakRpciwgaXRlbSkpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gQmxpbmRseSBob3BlIHRoYXQgZGF0YSBzdHJ1Y3R1cmUgbG9hZGVkIGZyb20gWUFNTFxuICAgIC8vIGlzIHZhbGlkIGZvciBnaXZlbiB0eXBlLlxuICAgIHJldHVybiBvYmpEYXRhO1xuICB9XG5cbiAgc2V0VXBBUElFbmRwb2ludHMobm90aWZpZXI6IChub3RpZnk6IHN0cmluZ1tdKSA9PiB2b2lkKSB7XG4gICAgZm9yIChsZXQgaW5kZXhOYW1lIG9mIE9iamVjdC5rZXlzKHRoaXMud29ya3NwYWNlKSkge1xuXG4gICAgICBtYWtlRW5kcG9pbnQ8SW5kZXg8YW55Pj4oYHN0b3JhZ2UtJHtpbmRleE5hbWV9LWFsbGAsIGFzeW5jICgpID0+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMud29ya3NwYWNlW2luZGV4TmFtZV07XG4gICAgICB9LCBhc3luYyAoeyBuZXdEYXRhLCBub3RpZnkgfSkgPT4ge1xuICAgICAgICBhd2FpdCB0aGlzLnN0b3JlTWFuYWdlcnNbaW5kZXhOYW1lXS5zdG9yZUluZGV4KHRoaXMsIG5ld0RhdGEpO1xuICAgICAgICBub3RpZmllcihbaW5kZXhOYW1lLCAuLi4obm90aWZ5IHx8IFtdKV0pO1xuICAgICAgfSk7XG5cbiAgICAgIG1ha2VFbmRwb2ludDxJbmRleGFibGVPYmplY3Q+KGBzdG9yYWdlLSR7aW5kZXhOYW1lfWAsIGFzeW5jICh7IG9iamVjdElkIH06IHsgb2JqZWN0SWQ6IHN0cmluZyB9KSA9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLndvcmtzcGFjZVtpbmRleE5hbWVdW29iamVjdElkXTtcbiAgICAgIH0sIGFzeW5jICh7IG5ld0RhdGEsIG5vdGlmeSB9KSA9PiB7XG4gICAgICAgIGF3YWl0IHRoaXMuc3RvcmVNYW5hZ2Vyc1tpbmRleE5hbWVdLnN0b3JlKG5ld0RhdGEsIHRoaXMpO1xuICAgICAgICBub3RpZmllcihbaW5kZXhOYW1lLCAuLi4obm90aWZ5IHx8IFtdKV0pO1xuICAgICAgfSk7XG5cbiAgICAgIG1ha2VFbmRwb2ludDxib29sZWFuPihgc3RvcmFnZS0ke2luZGV4TmFtZX0tZGVsZXRlYCwgYXN5bmMgKHsgb2JqZWN0SWQgfTogeyBvYmplY3RJZDogc3RyaW5nIH0pID0+IHtcbiAgICAgICAgZGVsZXRlIHRoaXMud29ya3NwYWNlW2luZGV4TmFtZV1bb2JqZWN0SWRdO1xuICAgICAgICBhd2FpdCB0aGlzLnN0b3JlTWFuYWdlcnNbaW5kZXhOYW1lXS5zdG9yZUluZGV4KHRoaXMsIHRoaXMud29ya3NwYWNlW2luZGV4TmFtZV0pO1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH0pO1xuXG4gICAgfVxuICB9XG59XG4iXX0=