import * as path from 'path';
import * as log from 'electron-log';
import { listen } from '../../api/main';
import { YAMLStorage } from './yaml';
const YAML_EXT = '.yaml';
export class StoreManager {
    constructor(rootDir) {
        this.rootDir = rootDir;
        this._index = undefined;
    }
    async storeIndex(storage, newIdx) {
        log.debug(`SSE: StorageManager for ${this.rootDir}: Storing index`);
        const idx = newIdx || await this.getIndex(storage);
        const items = Object.values(idx);
        for (const obj of items) {
            await this.store(obj, storage, false);
        }
        this._index = idx;
        return true;
    }
    async getIndex(storage) {
        if (this._index === undefined) {
            this._index = await this._loadIndex(storage);
        }
        return this._index;
    }
    async findObjects(storage, query) {
        const index = await this.getIndex(storage);
        if (query !== undefined) {
            var results = {};
            for (let key of Object.keys(index)) {
                const obj = index[key];
                if (this.objectMatchesQuery(obj, query)) {
                    results[key] = obj;
                }
            }
            return results;
        }
        else {
            return index;
        }
    }
    async _loadIndex(storage) {
        const rootPath = this.rootDir;
        const dirs = await storage.fs.readdir(path.join(storage.workDir, rootPath));
        var idx = {};
        for (const dir of dirs) {
            if (dir != '.DS_Store') {
                let objData;
                try {
                    objData = await storage.loadObject(path.join(rootPath, dir));
                }
                catch (e) {
                    log.error(`Failed to load object from ${dir} when loading index ${this.rootDir}`);
                }
                if (objData) {
                    const obj = this.postLoad(objData);
                    if (obj.id) {
                        idx[obj.id] = obj;
                    }
                }
            }
        }
        return idx;
    }
    // TODO: Use `toUseableObject(data: any) => O` to post-process loaded data
    // Stores object in DB
    async store(obj, storage, updateIndex = true) {
        //log.debug(`SSE: StorageManager for ${this.rootDir}: Storing object ${obj.id}`);
        //log.silly(`SSE: StorageManager for ${this.rootDir}: Storing object ${obj.id}: ${JSON.stringify(obj)}`);
        const objDir = path.join(this.rootDir, `${obj.id}`);
        const objPath = path.join(storage.workDir, objDir);
        const storeable = this.toStoreableObject(obj);
        await storage.fs.ensureDir(objPath);
        for (const key of Object.keys(storeable)) {
            const data = storeable[key];
            await storage.yaml.store(path.join(objPath, `${key}.yaml`), data);
        }
        if (updateIndex === true) {
            //log.debug(`SSE: StorageManager for ${this.rootDir}: Storing object ${obj.id}: Updating index`);
            await this.updateIndexedItem(obj, storage);
        }
        return true;
    }
    async updateIndexedItem(obj, storage) {
        await this.getIndex(storage);
        this._index[obj.id] = obj;
    }
    toStoreableObject(obj) {
        return { meta: obj };
    }
    ;
    // Converts object data into valid object, if needed
    // (in cases when partial data is stored or migration took place previously)
    postLoad(obj) {
        return obj;
    }
    objectMatchesQuery(obj, query) {
        return false;
    }
}
export class Storage {
    constructor(fs, workDir, storeManagers, debugBackend) {
        this.fs = fs;
        this.workDir = workDir;
        this.storeManagers = storeManagers;
        this.fs = fs;
        this.workDir = workDir;
        this.yaml = new YAMLStorage(fs, { debugLog: debugBackend || false });
        this.workspace = Object.keys(storeManagers).reduce((obj, key) => {
            obj[key] = {};
            return obj;
        }, {});
    }
    async loadWorkspace() {
        // Loads workspace object with an index for each store manager
        this.workspace = await Object.keys(this.storeManagers).reduce(async (objP, key) => {
            const obj = await objP;
            obj[key] = await this.storeManagers[key].getIndex(this);
            return obj;
        }, Promise.resolve({}));
    }
    async storeWorkspace() {
        return Promise.all([...Object.keys(this.storeManagers).map(async (key) => {
                return await this.storeManagers[key].storeIndex(this, this.workspace[key]);
            })]).then(() => true);
    }
    // Loads object data from given directory, reading YAML files.
    // meta.yaml is treated specially, populating top-level object payload.
    // Other YAML files populate corresponding object properties.
    async loadObject(objDir) {
        let objData;
        const metaFile = path.join(this.workDir, objDir, 'meta.yaml');
        let metaFileIsFile;
        try {
            metaFileIsFile = (await this.fs.stat(metaFile)).isFile();
        }
        catch (e) {
            return undefined;
        }
        if (!metaFileIsFile) {
            return undefined;
        }
        objData = await this.yaml.load(metaFile) || {};
        const dirContents = await this.fs.readdir(path.join(this.workDir, objDir));
        for (const item of dirContents) {
            if (path.extname(item) == YAML_EXT) {
                const basename = path.basename(item, YAML_EXT);
                if (basename != 'meta') {
                    objData[basename] = await this.yaml.load(path.join(this.workDir, objDir, item));
                }
            }
        }
        // Blindly hope that data structure loaded from YAML
        // is valid for given type.
        return objData;
    }
    setUpAPIEndpoints(notifier) {
        log.verbose("SSE: Storage: Setting API endpoints");
        for (let indexName of Object.keys(this.workspace)) {
            listen(`storage-get-all-${indexName}`, async () => {
                return this.workspace[indexName];
            });
            listen(`storage-get-one-in-${indexName}`, async ({ objectId }) => {
                return this.workspace[indexName][objectId] || null;
            });
            listen(`storage-store-one-in-${indexName}`, async ({ objectId, newData }) => {
                await this.storeManagers[indexName].store(newData, this);
                notifier([indexName]);
                return { success: true };
            });
            listen(`storage-delete-one-in-${indexName}`, async ({ objectId }) => {
                delete this.workspace[indexName][objectId];
                // TODO: WARNING: Race condition, since storing the whole index may take a little while
                await this.storeManagers[indexName].storeIndex(this, this.workspace[indexName]);
                notifier([indexName]);
                return { success: true };
            });
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RvcmFnZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zdG9yYWdlL21haW4vc3RvcmFnZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEtBQUssSUFBSSxNQUFNLE1BQU0sQ0FBQztBQUM3QixPQUFPLEtBQUssR0FBRyxNQUFNLGNBQWMsQ0FBQztBQUVwQyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFLeEMsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLFFBQVEsQ0FBQztBQUdyQyxNQUFNLFFBQVEsR0FBRyxPQUFPLENBQUM7QUFHekIsTUFBTSxPQUFnQixZQUFZO0lBR2hDLFlBQW1CLE9BQWU7UUFBZixZQUFPLEdBQVAsT0FBTyxDQUFRO1FBRnhCLFdBQU0sR0FBeUIsU0FBUyxDQUFDO0lBRWQsQ0FBQztJQUUvQixLQUFLLENBQUMsVUFBVSxDQUFDLE9BQXFCLEVBQUUsTUFBNEI7UUFDekUsR0FBRyxDQUFDLEtBQUssQ0FBQywyQkFBMkIsSUFBSSxDQUFDLE9BQU8saUJBQWlCLENBQUMsQ0FBQztRQUVwRSxNQUFNLEdBQUcsR0FBYSxNQUFNLElBQUksTUFBTSxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQzdELE1BQU0sS0FBSyxHQUFRLE1BQU0sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFdEMsS0FBSyxNQUFNLEdBQUcsSUFBSSxLQUFLLEVBQUU7WUFDdkIsTUFBTSxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxPQUFPLEVBQUUsS0FBSyxDQUFDLENBQUM7U0FDdkM7UUFFRCxJQUFJLENBQUMsTUFBTSxHQUFHLEdBQUcsQ0FBQztRQUNsQixPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFFTSxLQUFLLENBQUMsUUFBUSxDQUFDLE9BQXFCO1FBQ3pDLElBQUksSUFBSSxDQUFDLE1BQU0sS0FBSyxTQUFTLEVBQUU7WUFDN0IsSUFB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RUFBRSxFQUFFLFFBQVEsRUFBRSxFQUFFLEVBQUU7Z0JBQzVELE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQztnQkFFM0MsdUZBQXVGO2dCQUN2RixNQUFNLElBQUksQ0FBQyxhQUFhLENBQUMsU0FBUyxDQUFDLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7Z0JBRWhGLFFBQVEsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7Z0JBQ3RCLE9BQU8sRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLENBQUM7WUFDM0IsQ0FBQyxDQUFDLENBQUM7U0FFSjtJQUNILENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgKiBhcyBsb2cgZnJvbSAnZWxlY3Ryb24tbG9nJztcblxuaW1wb3J0IHsgbGlzdGVuIH0gZnJvbSAnLi4vLi4vYXBpL21haW4nO1xuXG5pbXBvcnQgeyBJbmRleCwgSW5kZXhhYmxlT2JqZWN0IH0gZnJvbSAnLi4vcXVlcnknO1xuaW1wb3J0IHsgV29ya3NwYWNlIH0gZnJvbSAnLi4vd29ya3NwYWNlJztcblxuaW1wb3J0IHsgWUFNTFN0b3JhZ2UgfSBmcm9tICcuL3lhbWwnO1xuXG5cbmNvbnN0IFlBTUxfRVhUID0gJy55YW1sJztcblxuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgU3RvcmVNYW5hZ2VyPE8gZXh0ZW5kcyBJbmRleGFibGVPYmplY3Q+IHtcbiAgcHJvdGVjdGVkIF9pbmRleDogSW5kZXg8Tz4gfCB1bmRlZmluZWQgPSB1bmRlZmluZWQ7XG5cbiAgY29uc3RydWN0b3IocHVibGljIHJvb3REaXI6IHN0cmluZykge31cblxuICBwdWJsaWMgYXN5bmMgc3RvcmVJbmRleChzdG9yYWdlOiBTdG9yYWdlPGFueT4sIG5ld0lkeDogSW5kZXg8Tz4gfCB1bmRlZmluZWQpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBsb2cuZGVidWcoYFNTRTogU3RvcmFnZU1hbmFnZXIgZm9yICR7dGhpcy5yb290RGlyfTogU3RvcmluZyBpbmRleGApO1xuXG4gICAgY29uc3QgaWR4OiBJbmRleDxPPiA9IG5ld0lkeCB8fCBhd2FpdCB0aGlzLmdldEluZGV4KHN0b3JhZ2UpO1xuICAgIGNvbnN0IGl0ZW1zOiBPW10gPSBPYmplY3QudmFsdWVzKGlkeCk7XG5cbiAgICBmb3IgKGNvbnN0IG9iaiBvZiBpdGVtcykge1xuICAgICAgYXdhaXQgdGhpcy5zdG9yZShvYmosIHN0b3JhZ2UsIGZhbHNlKTtcbiAgICB9XG5cbiAgICB0aGlzLl9pbmRleCA9IGlkeDtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBnZXRJbmRleChzdG9yYWdlOiBTdG9yYWdlPGFueT4pOiBQcm9taXNlPEluZGV4PE8+PiB7XG4gICAgaWYgKHRoaXMuX2luZGV4ID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHRoaXMuX2luZGV4ID0gYXdhaXQgdGhpcy5fbG9hZEluZGV4KHN0b3JhZ2UpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5faW5kZXg7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZmluZE9iamVjdHMoc3RvcmFnZTogU3RvcmFnZTxhbnk+LCBxdWVyeT86IHN0cmluZyk6IFByb21pc2U8SW5kZXg8Tz4+IHtcbiAgICBjb25zdCBpbmRleCA9IGF3YWl0IHRoaXMuZ2V0SW5kZXgoc3RvcmFnZSk7XG4gICAgaWYgKHF1ZXJ5ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHZhciByZXN1bHRzOiBJbmRleDxPPiA9IHt9O1xuICAgICAgZm9yIChsZXQga2V5IG9mIE9iamVjdC5rZXlzKGluZGV4KSkge1xuICAgICAgICBjb25zdCBvYmogPSBpbmRleFtrZXldXG4gICAgICAgIGlmICh0aGlzLm9iamVjdE1hdGNoZXNRdWVyeShvYmosIHF1ZXJ5KSkge1xuICAgICAgICAgIHJlc3VsdHNba2V5XSA9IG9iajtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcmV0dXJuIHJlc3VsdHM7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBpbmRleDtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIF9sb2FkSW5kZXgoc3RvcmFnZTogU3RvcmFnZTxhbnk+KTogUHJvbWlzZTxJbmRleDxPPj4ge1xuICAgIGNvbnN0IHJvb3RQYXRoID0gdGhpcy5yb290RGlyO1xuICAgIGNvbnN0IGRpcnMgPSBhd2FpdCBzdG9yYWdlLmZzLnJlYWRkaXIocGF0aC5qb2luKHN0b3JhZ2Uud29ya0Rpciwgcm9vdFBhdGgpKTtcbiAgICB2YXIgaWR4OiBJbmRleDxPPiA9IHt9O1xuXG4gICAgZm9yIChjb25zdCBkaXIgb2YgZGlycykge1xuICAgICAgaWYgKGRpciAhPSAnLkRTX1N0b3JlJykge1xuICAgICAgICBsZXQgb2JqRGF0YTogYW55O1xuICAgICAgICB0cnkge1xuICAgICAgICAgIG9iakRhdGEgPSBhd2FpdCBzdG9yYWdlLmxvYWRPYmplY3QocGF0aC5qb2luKHJvb3RQYXRoLCBkaXIpKTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgIGxvZy5lcnJvcihgRmFpbGVkIHRvIGxvYWQgb2JqZWN0IGZyb20gJHtkaXJ9IHdoZW4gbG9hZGluZyBpbmRleCAke3RoaXMucm9vdERpcn1gKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAob2JqRGF0YSkge1xuICAgICAgICAgIGNvbnN0IG9iajogTyA9IHRoaXMucG9zdExvYWQob2JqRGF0YSk7XG4gICAgICAgICAgaWYgKG9iai5pZCkge1xuICAgICAgICAgICAgaWR4W29iai5pZF0gPSBvYmo7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBpZHg7XG4gIH1cblxuICAvLyBUT0RPOiBVc2UgYHRvVXNlYWJsZU9iamVjdChkYXRhOiBhbnkpID0+IE9gIHRvIHBvc3QtcHJvY2VzcyBsb2FkZWQgZGF0YVxuXG4gIC8vIFN0b3JlcyBvYmplY3QgaW4gREJcbiAgcHVibGljIGFzeW5jIHN0b3JlKG9iajogTywgc3RvcmFnZTogU3RvcmFnZTxhbnk+LCB1cGRhdGVJbmRleCA9IHRydWUpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICAvL2xvZy5kZWJ1ZyhgU1NFOiBTdG9yYWdlTWFuYWdlciBmb3IgJHt0aGlzLnJvb3REaXJ9OiBTdG9yaW5nIG9iamVjdCAke29iai5pZH1gKTtcbiAgICAvL2xvZy5zaWxseShgU1NFOiBTdG9yYWdlTWFuYWdlciBmb3IgJHt0aGlzLnJvb3REaXJ9OiBTdG9yaW5nIG9iamVjdCAke29iai5pZH06ICR7SlNPTi5zdHJpbmdpZnkob2JqKX1gKTtcblxuICAgIGNvbnN0IG9iakRpciA9IHBhdGguam9pbih0aGlzLnJvb3REaXIsIGAke29iai5pZH1gKTtcbiAgICBjb25zdCBvYmpQYXRoID0gcGF0aC5qb2luKHN0b3JhZ2Uud29ya0Rpciwgb2JqRGlyKTtcbiAgICBjb25zdCBzdG9yZWFibGUgPSB0aGlzLnRvU3RvcmVhYmxlT2JqZWN0KG9iaik7XG5cbiAgICBhd2FpdCBzdG9yYWdlLmZzLmVuc3VyZURpcihvYmpQYXRoKTtcbiAgICBmb3IgKGNvbnN0IGtleSBvZiBPYmplY3Qua2V5cyhzdG9yZWFibGUpKSB7XG4gICAgICBjb25zdCBkYXRhID0gc3RvcmVhYmxlW2tleV07XG4gICAgICBhd2FpdCBzdG9yYWdlLnlhbWwuc3RvcmUocGF0aC5qb2luKG9ialBhdGgsIGAke2tleX0ueWFtbGApLCBkYXRhKTtcbiAgICB9XG5cbiAgICBpZiAodXBkYXRlSW5kZXggPT09IHRydWUpIHtcbiAgICAgIC8vbG9nLmRlYnVnKGBTU0U6IFN0b3JhZ2VNYW5hZ2VyIGZvciAke3RoaXMucm9vdERpcn06IFN0b3Jpbmcgb2JqZWN0ICR7b2JqLmlkfTogVXBkYXRpbmcgaW5kZXhgKTtcbiAgICAgIGF3YWl0IHRoaXMudXBkYXRlSW5kZXhlZEl0ZW0ob2JqLCBzdG9yYWdlKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyB1cGRhdGVJbmRleGVkSXRlbShvYmo6IE8sIHN0b3JhZ2U6IFN0b3JhZ2U8YW55Pikge1xuICAgIGF3YWl0IHRoaXMuZ2V0SW5kZXgoc3RvcmFnZSk7XG4gICAgKHRoaXMuX2luZGV4IGFzIEluZGV4PE8+KVtvYmouaWRdID0gb2JqO1xuICB9XG5cbiAgcHVibGljIHRvU3RvcmVhYmxlT2JqZWN0KG9iajogTyk6IGFueSB7XG4gICAgcmV0dXJuIHsgbWV0YTogb2JqIGFzIGFueSB9O1xuICB9O1xuXG4gIC8vIENvbnZlcnRzIG9iamVjdCBkYXRhIGludG8gdmFsaWQgb2JqZWN0LCBpZiBuZWVkZWRcbiAgLy8gKGluIGNhc2VzIHdoZW4gcGFydGlhbCBkYXRhIGlzIHN0b3JlZCBvciBtaWdyYXRpb24gdG9vayBwbGFjZSBwcmV2aW91c2x5KVxuICBwdWJsaWMgcG9zdExvYWQob2JqOiBhbnkpOiBPIHtcbiAgICByZXR1cm4gb2JqIGFzIE87XG4gIH1cblxuICBwdWJsaWMgb2JqZWN0TWF0Y2hlc1F1ZXJ5KG9iajogTywgcXVlcnk6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxufVxuXG5cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBTdG9yYWdlPFcgZXh0ZW5kcyBXb3Jrc3BhY2U+IHtcbiAgcHVibGljIHlhbWw6IFlBTUxTdG9yYWdlO1xuICBwdWJsaWMgd29ya3NwYWNlOiBXO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgICAgcHVibGljIGZzOiB0eXBlb2YgaW1wb3J0KCdmcy1leHRyYScpLFxuICAgICAgcHVibGljIHdvcmtEaXI6IHN0cmluZyxcbiAgICAgIHB1YmxpYyBzdG9yZU1hbmFnZXJzOiB7IFtrZXk6IHN0cmluZ106IFN0b3JlTWFuYWdlcjxhbnk+IH0sXG4gICAgICBkZWJ1Z0JhY2tlbmQ/OiB0cnVlKSB7XG4gICAgdGhpcy5mcyA9IGZzO1xuICAgIHRoaXMud29ya0RpciA9IHdvcmtEaXI7XG4gICAgdGhpcy55YW1sID0gbmV3IFlBTUxTdG9yYWdlKGZzLCB7IGRlYnVnTG9nOiBkZWJ1Z0JhY2tlbmQgfHwgZmFsc2UgfSk7XG5cbiAgICB0aGlzLndvcmtzcGFjZSA9IE9iamVjdC5rZXlzKHN0b3JlTWFuYWdlcnMpLnJlZHVjZSgob2JqOiBhbnksIGtleTogc3RyaW5nKSA9PiB7XG4gICAgICBvYmpba2V5XSA9IHt9O1xuICAgICAgcmV0dXJuIG9iajtcbiAgICB9LCB7fSkgYXMgVztcbiAgfVxuXG4gIHB1YmxpYyBhYnN0cmFjdCBhc3luYyBmaW5kT2JqZWN0cyhxdWVyeT86IHN0cmluZyk6IFByb21pc2U8Vz5cblxuICBwdWJsaWMgYXN5bmMgbG9hZFdvcmtzcGFjZSgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAvLyBMb2FkcyB3b3Jrc3BhY2Ugb2JqZWN0IHdpdGggYW4gaW5kZXggZm9yIGVhY2ggc3RvcmUgbWFuYWdlclxuICAgIHRoaXMud29ya3NwYWNlID0gYXdhaXQgT2JqZWN0LmtleXModGhpcy5zdG9yZU1hbmFnZXJzKS5yZWR1Y2UoYXN5bmMgKG9ialA6IFByb21pc2U8YW55Piwga2V5OiBzdHJpbmcpID0+IHtcbiAgICAgIGNvbnN0IG9iaiA9IGF3YWl0IG9ialA7XG4gICAgICBvYmpba2V5XSA9IGF3YWl0IHRoaXMuc3RvcmVNYW5hZ2Vyc1trZXldLmdldEluZGV4KHRoaXMpO1xuICAgICAgcmV0dXJuIG9iajtcbiAgICB9LCBQcm9taXNlLnJlc29sdmUoe30pKSBhcyBXO1xuICB9XG5cbiAgYXN5bmMgc3RvcmVXb3Jrc3BhY2UoKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgcmV0dXJuIFByb21pc2UuYWxsKFsuLi5PYmplY3Qua2V5cyh0aGlzLnN0b3JlTWFuYWdlcnMpLm1hcChhc3luYyAoa2V5KSA9PiB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5zdG9yZU1hbmFnZXJzW2tleV0uc3RvcmVJbmRleCh0aGlzLCB0aGlzLndvcmtzcGFjZVtrZXldKTtcbiAgICB9KV0pLnRoZW4oKCkgPT4gdHJ1ZSk7XG4gIH1cblxuICAvLyBMb2FkcyBvYmplY3QgZGF0YSBmcm9tIGdpdmVuIGRpcmVjdG9yeSwgcmVhZGluZyBZQU1MIGZpbGVzLlxuICAvLyBtZXRhLnlhbWwgaXMgdHJlYXRlZCBzcGVjaWFsbHksIHBvcHVsYXRpbmcgdG9wLWxldmVsIG9iamVjdCBwYXlsb2FkLlxuICAvLyBPdGhlciBZQU1MIGZpbGVzIHBvcHVsYXRlIGNvcnJlc3BvbmRpbmcgb2JqZWN0IHByb3BlcnRpZXMuXG4gIHB1YmxpYyBhc3luYyBsb2FkT2JqZWN0KG9iakRpcjogc3RyaW5nKTogUHJvbWlzZTxhbnkgfCB1bmRlZmluZWQ+IHtcbiAgICBsZXQgb2JqRGF0YToge1twcm9wTmFtZTogc3RyaW5nXTogYW55fTtcblxuICAgIGNvbnN0IG1ldGFGaWxlID0gcGF0aC5qb2luKHRoaXMud29ya0Rpciwgb2JqRGlyLCAnbWV0YS55YW1sJyk7XG4gICAgbGV0IG1ldGFGaWxlSXNGaWxlOiBib29sZWFuO1xuICAgIHRyeSB7XG4gICAgICBtZXRhRmlsZUlzRmlsZSA9IChhd2FpdCB0aGlzLmZzLnN0YXQobWV0YUZpbGUpKS5pc0ZpbGUoKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cbiAgICBpZiAoIW1ldGFGaWxlSXNGaWxlKSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cbiAgICBvYmpEYXRhID0gYXdhaXQgdGhpcy55YW1sLmxvYWQobWV0YUZpbGUpIHx8IHt9O1xuXG4gICAgY29uc3QgZGlyQ29udGVudHMgPSBhd2FpdCB0aGlzLmZzLnJlYWRkaXIocGF0aC5qb2luKHRoaXMud29ya0Rpciwgb2JqRGlyKSk7XG4gICAgZm9yIChjb25zdCBpdGVtIG9mIGRpckNvbnRlbnRzKSB7XG4gICAgICBpZiAocGF0aC5leHRuYW1lKGl0ZW0pID09IFlBTUxfRVhUKSB7XG4gICAgICAgIGNvbnN0IGJhc2VuYW1lID0gcGF0aC5iYXNlbmFtZShpdGVtLCBZQU1MX0VYVCk7XG4gICAgICAgIGlmIChiYXNlbmFtZSAhPSAnbWV0YScpIHtcbiAgICAgICAgICBvYmpEYXRhW2Jhc2VuYW1lXSA9IGF3YWl0IHRoaXMueWFtbC5sb2FkKHBhdGguam9pbih0aGlzLndvcmtEaXIsIG9iakRpciwgaXRlbSkpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gQmxpbmRseSBob3BlIHRoYXQgZGF0YSBzdHJ1Y3R1cmUgbG9hZGVkIGZyb20gWUFNTFxuICAgIC8vIGlzIHZhbGlkIGZvciBnaXZlbiB0eXBlLlxuICAgIHJldHVybiBvYmpEYXRhO1xuICB9XG5cbiAgc2V0VXBBUElFbmRwb2ludHMobm90aWZpZXI6IChub3RpZnk6IHN0cmluZ1tdKSA9PiB2b2lkKSB7XG4gICAgbG9nLnZlcmJvc2UoXCJTU0U6IFN0b3JhZ2U6IFNldHRpbmcgQVBJIGVuZHBvaW50c1wiKTtcblxuICAgIGZvciAobGV0IGluZGV4TmFtZSBvZiBPYmplY3Qua2V5cyh0aGlzLndvcmtzcGFjZSkpIHtcblxuICAgICAgbGlzdGVuPHt9LCBJbmRleDxhbnk+PlxuICAgICAgKGBzdG9yYWdlLWdldC1hbGwtJHtpbmRleE5hbWV9YCwgYXN5bmMgKCkgPT4ge1xuICAgICAgICByZXR1cm4gdGhpcy53b3Jrc3BhY2VbaW5kZXhOYW1lXTtcbiAgICAgIH0pO1xuXG4gICAgICBsaXN0ZW48eyBvYmplY3RJZDogc3RyaW5nIH0sIEluZGV4YWJsZU9iamVjdD5cbiAgICAgIChgc3RvcmFnZS1nZXQtb25lLWluLSR7aW5kZXhOYW1lfWAsIGFzeW5jICh7IG9iamVjdElkIH0pID0+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMud29ya3NwYWNlW2luZGV4TmFtZV1bb2JqZWN0SWRdIHx8IG51bGw7XG4gICAgICB9KTtcblxuICAgICAgbGlzdGVuPHsgb2JqZWN0SWQ6IHN0cmluZywgbmV3RGF0YTogSW5kZXhhYmxlT2JqZWN0ICB9LCB7IHN1Y2Nlc3M6IGJvb2xlYW4gfT5cbiAgICAgIChgc3RvcmFnZS1zdG9yZS1vbmUtaW4tJHtpbmRleE5hbWV9YCwgYXN5bmMgKHsgb2JqZWN0SWQsIG5ld0RhdGEgfSkgPT4ge1xuICAgICAgICBhd2FpdCB0aGlzLnN0b3JlTWFuYWdlcnNbaW5kZXhOYW1lXS5zdG9yZShuZXdEYXRhLCB0aGlzKTtcbiAgICAgICAgbm90aWZpZXIoW2luZGV4TmFtZV0pO1xuICAgICAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlIH07XG4gICAgICB9KTtcblxuICAgICAgbGlzdGVuPHsgb2JqZWN0SWQ6IHN0cmluZyB9LCB7IHN1Y2Nlc3M6IGJvb2xlYW4gfT5cbiAgICAgIChgc3RvcmFnZS1kZWxldGUtb25lLWluLSR7aW5kZXhOYW1lfWAsIGFzeW5jICh7IG9iamVjdElkIH0pID0+IHtcbiAgICAgICAgZGVsZXRlIHRoaXMud29ya3NwYWNlW2luZGV4TmFtZV1bb2JqZWN0SWRdO1xuXG4gICAgICAgIC8vIFRPRE86IFdBUk5JTkc6IFJhY2UgY29uZGl0aW9uLCBzaW5jZSBzdG9yaW5nIHRoZSB3aG9sZSBpbmRleCBtYXkgdGFrZSBhIGxpdHRsZSB3aGlsZVxuICAgICAgICBhd2FpdCB0aGlzLnN0b3JlTWFuYWdlcnNbaW5kZXhOYW1lXS5zdG9yZUluZGV4KHRoaXMsIHRoaXMud29ya3NwYWNlW2luZGV4TmFtZV0pO1xuXG4gICAgICAgIG5vdGlmaWVyKFtpbmRleE5hbWVdKTtcbiAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSB9O1xuICAgICAgfSk7XG5cbiAgICB9XG4gIH1cbn1cbiJdfQ==