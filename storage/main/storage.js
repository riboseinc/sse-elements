import * as path from 'path';
import * as log from 'electron-log';
import { makeEndpoint } from '../../api/main';
import { YAMLStorage } from './yaml';
const YAML_EXT = '.yaml';
export class StoreManager {
    constructor(rootDir) {
        this.rootDir = rootDir;
        this._index = undefined;
    }
    async storeIndex(storage, newIdx) {
        log.debug(`SSE: StorageManager for ${this.rootDir}: Storing index`);
        const idx = newIdx || await this.getIndex(storage);
        const items = Object.values(idx);
        for (const obj of items) {
            await this.store(obj, storage, false);
        }
        this._index = idx;
        return true;
    }
    async getIndex(storage) {
        if (this._index === undefined) {
            this._index = await this._loadIndex(storage);
        }
        return this._index;
    }
    async findObjects(storage, query) {
        const index = await this.getIndex(storage);
        if (query !== undefined) {
            var results = {};
            for (let key of Object.keys(index)) {
                const obj = index[key];
                if (this.objectMatchesQuery(obj, query)) {
                    results[key] = obj;
                }
            }
            return results;
        }
        else {
            return index;
        }
    }
    async _loadIndex(storage) {
        const rootPath = this.rootDir;
        const dirs = await storage.fs.readdir(path.join(storage.workDir, rootPath));
        var idx = {};
        for (const dir of dirs) {
            if (dir != '.DS_Store') {
                const objData = await storage.loadObject(path.join(rootPath, dir));
                if (objData) {
                    const obj = this.postLoad(objData);
                    if (obj.id) {
                        idx[obj.id] = obj;
                    }
                }
            }
        }
        return idx;
    }
    // TODO: Use `toUseableObject(data: any) => O` to post-process loaded data
    // Stores object in DB
    async store(obj, storage, updateIndex = true) {
        log.debug(`SSE: StorageManager for ${this.rootDir}: Storing object ${obj.id}`);
        log.silly(`SSE: StorageManager for ${this.rootDir}: Storing object ${obj.id}: ${JSON.stringify(obj)}`);
        const objDir = path.join(this.rootDir, `${obj.id}`);
        const objPath = path.join(storage.workDir, objDir);
        const storeable = this.toStoreableObject(obj);
        await storage.fs.ensureDir(objPath);
        for (const key of Object.keys(storeable)) {
            const data = storeable[key];
            await storage.yaml.store(path.join(objPath, `${key}.yaml`), data);
        }
        if (updateIndex === true) {
            log.debug(`SSE: StorageManager for ${this.rootDir}: Storing object ${obj.id}: Updating index`);
            await this.updateIndexedItem(obj, storage);
        }
        return true;
    }
    async updateIndexedItem(obj, storage) {
        await this.getIndex(storage);
        this._index[obj.id] = obj;
    }
    toStoreableObject(obj) {
        return { meta: obj };
    }
    ;
    // Converts object data into valid object, if needed
    // (in cases when partial data is stored or migration took place previously)
    postLoad(obj) {
        return obj;
    }
    objectMatchesQuery(obj, query) {
        return false;
    }
}
export class Storage {
    constructor(fs, workDir, storeManagers) {
        this.fs = fs;
        this.workDir = workDir;
        this.storeManagers = storeManagers;
        this.fs = fs;
        this.workDir = workDir;
        this.yaml = new YAMLStorage(fs);
        this.workspace = Object.keys(storeManagers).reduce((obj, key) => {
            obj[key] = {};
            return obj;
        }, {});
    }
    async loadWorkspace() {
        this.workspace = await Object.keys(this.storeManagers).reduce(async (objP, key) => {
            const obj = await objP;
            obj[key] = await this.storeManagers[key].getIndex(this);
            return obj;
        }, Promise.resolve({}));
    }
    async storeWorkspace() {
        return Promise.all([...Object.keys(this.storeManagers).map(async (key) => {
                return await this.storeManagers[key].storeIndex(this, this.workspace[key]);
            })]).then(() => true);
    }
    // Loads object data from given directory, reading YAML files.
    // meta.yaml is treated specially, populating top-level object payload.
    // Other YAML files populate corresponding object properties.
    async loadObject(objDir) {
        let objData;
        const metaFile = path.join(this.workDir, objDir, 'meta.yaml');
        let metaFileIsFile;
        try {
            metaFileIsFile = (await this.fs.stat(metaFile)).isFile();
        }
        catch (e) {
            return undefined;
        }
        if (!metaFileIsFile) {
            return undefined;
        }
        objData = await this.yaml.load(metaFile);
        const dirContents = await this.fs.readdir(path.join(this.workDir, objDir));
        for (const item of dirContents) {
            if (path.extname(item) == YAML_EXT) {
                const basename = path.basename(item, YAML_EXT);
                if (basename != 'meta') {
                    objData[basename] = await this.yaml.load(path.join(this.workDir, objDir, item));
                }
            }
        }
        // Blindly hope that data structure loaded from YAML
        // is valid for given type.
        return objData;
    }
    setUpAPIEndpoints(notifier) {
        log.verbose("SSE: Storage: Setting API endpoints");
        for (let indexName of Object.keys(this.workspace)) {
            makeEndpoint(`storage-${indexName}-all`, async () => {
                return this.workspace[indexName];
            }, async ({ newData, notify }) => {
                await this.storeManagers[indexName].storeIndex(this, newData);
                notifier([indexName, ...(notify || [])]);
            });
            makeEndpoint(`storage-${indexName}`, async ({ objectId }) => {
                return this.workspace[indexName][objectId];
            }, async ({ newData, notify }) => {
                await this.storeManagers[indexName].store(newData, this);
                notifier([indexName, ...(notify || [])]);
            });
            makeEndpoint(`storage-${indexName}-delete`, async ({ objectId }) => {
                delete this.workspace[indexName][objectId];
                await this.storeManagers[indexName].storeIndex(this, this.workspace[indexName]);
                return true;
            });
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RvcmFnZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zdG9yYWdlL21haW4vc3RvcmFnZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEtBQUssSUFBSSxNQUFNLE1BQU0sQ0FBQztBQUM3QixPQUFPLEtBQUssR0FBRyxNQUFNLGNBQWMsQ0FBQztBQUVwQyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFLOUMsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLFFBQVEsQ0FBQztBQUdyQyxNQUFNLFFBQVEsR0FBRyxPQUFPLENBQUM7QUFHekIsTUFBTSxPQUFnQixZQUFZO0lBR2hDLFlBQW1CLE9BQWU7UUFBZixZQUFPLEdBQVAsT0FBTyxDQUFRO1FBRnhCLFdBQU0sR0FBeUIsU0FBUyxDQUFDO0lBRWQsQ0FBQztJQUUvQixLQUFLLENBQUMsVUFBVSxDQUFDLE9BQXFCLEVBQUUsTUFBNEI7UUFDekUsR0FBRyxDQUFDLEtBQUssQ0FBQywyQkFBMkIsSUFBSSxDQUFDLE9BQU8saUJBQWlCLENBQUMsQ0FBQztRQUVwRSxNQUFNLEdBQUcsR0FBYSxNQUFNLElBQUksTUFBTSxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQzdELE1BQU0sS0FBSyxHQUFRLE1BQU0sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFdEMsS0FBSyxNQUFNLEdBQUcsSUFBSSxLQUFLLEVBQUU7WUFDdkIsTUFBTSxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxPQUFPLEVBQUUsS0FBSyxDQUFDLENBQUM7U0FDdkM7UUFFRCxJQUFJLENBQUMsTUFBTSxHQUFHLEdBQUcsQ0FBQztRQUNsQixPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFFTSxLQUFLLENBQUMsUUFBUSxDQUFDLE9BQXFCO1FBQ3pDLElBQUksSUFBSSxDQUFDLE1BQU0sS0FBSyxTQUFTLEVBQUU7WUFDN0IsSUFB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QyxhQUFhLENBQUMsU0FBUyxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQztnQkFDekQsUUFBUSxDQUFDLENBQUMsU0FBUyxFQUFFLEdBQUcsQ0FBQyxNQUFNLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzNDLENBQUMsQ0FBQyxDQUFDO1lBRUgsWUFBWSxDQUFVLFdBQVcsU0FBUyxTQUFTLEVBQUUsS0FBSyxFQUFFLEVBQUUsUUFBUSxFQUF3QixFQUFFLEVBQUU7Z0JBQ2hHLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQztnQkFDM0MsTUFBTSxJQUFJLENBQUMsYUFBYSxDQUFDLFNBQVMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO2dCQUNoRixPQUFPLElBQUksQ0FBQztZQUNkLENBQUMsQ0FBQyxDQUFDO1NBRUo7SUFDSCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0ICogYXMgbG9nIGZyb20gJ2VsZWN0cm9uLWxvZyc7XG5cbmltcG9ydCB7IG1ha2VFbmRwb2ludCB9IGZyb20gJy4uLy4uL2FwaS9tYWluJztcblxuaW1wb3J0IHsgSW5kZXgsIEluZGV4YWJsZU9iamVjdCB9IGZyb20gJy4uL3F1ZXJ5JztcbmltcG9ydCB7IFdvcmtzcGFjZSB9IGZyb20gJy4uL3dvcmtzcGFjZSc7XG5cbmltcG9ydCB7IFlBTUxTdG9yYWdlIH0gZnJvbSAnLi95YW1sJztcblxuXG5jb25zdCBZQU1MX0VYVCA9ICcueWFtbCc7XG5cblxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIFN0b3JlTWFuYWdlcjxPIGV4dGVuZHMgSW5kZXhhYmxlT2JqZWN0PiB7XG4gIHByb3RlY3RlZCBfaW5kZXg6IEluZGV4PE8+IHwgdW5kZWZpbmVkID0gdW5kZWZpbmVkO1xuXG4gIGNvbnN0cnVjdG9yKHB1YmxpYyByb290RGlyOiBzdHJpbmcpIHt9XG5cbiAgcHVibGljIGFzeW5jIHN0b3JlSW5kZXgoc3RvcmFnZTogU3RvcmFnZTxhbnk+LCBuZXdJZHg6IEluZGV4PE8+IHwgdW5kZWZpbmVkKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgbG9nLmRlYnVnKGBTU0U6IFN0b3JhZ2VNYW5hZ2VyIGZvciAke3RoaXMucm9vdERpcn06IFN0b3JpbmcgaW5kZXhgKTtcblxuICAgIGNvbnN0IGlkeDogSW5kZXg8Tz4gPSBuZXdJZHggfHwgYXdhaXQgdGhpcy5nZXRJbmRleChzdG9yYWdlKTtcbiAgICBjb25zdCBpdGVtczogT1tdID0gT2JqZWN0LnZhbHVlcyhpZHgpO1xuXG4gICAgZm9yIChjb25zdCBvYmogb2YgaXRlbXMpIHtcbiAgICAgIGF3YWl0IHRoaXMuc3RvcmUob2JqLCBzdG9yYWdlLCBmYWxzZSk7XG4gICAgfVxuXG4gICAgdGhpcy5faW5kZXggPSBpZHg7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZ2V0SW5kZXgoc3RvcmFnZTogU3RvcmFnZTxhbnk+KTogUHJvbWlzZTxJbmRleDxPPj4ge1xuICAgIGlmICh0aGlzLl9pbmRleCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aGlzLl9pbmRleCA9IGF3YWl0IHRoaXMuX2xvYWRJbmRleChzdG9yYWdlKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuX2luZGV4O1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGZpbmRPYmplY3RzKHN0b3JhZ2U6IFN0b3JhZ2U8YW55PiwgcXVlcnk/OiBzdHJpbmcpOiBQcm9taXNlPEluZGV4PE8+PiB7XG4gICAgY29uc3QgaW5kZXggPSBhd2FpdCB0aGlzLmdldEluZGV4KHN0b3JhZ2UpO1xuICAgIGlmIChxdWVyeSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICB2YXIgcmVzdWx0czogSW5kZXg8Tz4gPSB7fTtcbiAgICAgIGZvciAobGV0IGtleSBvZiBPYmplY3Qua2V5cyhpbmRleCkpIHtcbiAgICAgICAgY29uc3Qgb2JqID0gaW5kZXhba2V5XVxuICAgICAgICBpZiAodGhpcy5vYmplY3RNYXRjaGVzUXVlcnkob2JqLCBxdWVyeSkpIHtcbiAgICAgICAgICByZXN1bHRzW2tleV0gPSBvYmo7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJldHVybiByZXN1bHRzO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gaW5kZXg7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBfbG9hZEluZGV4KHN0b3JhZ2U6IFN0b3JhZ2U8YW55Pik6IFByb21pc2U8SW5kZXg8Tz4+IHtcbiAgICBjb25zdCByb290UGF0aCA9IHRoaXMucm9vdERpcjtcbiAgICBjb25zdCBkaXJzID0gYXdhaXQgc3RvcmFnZS5mcy5yZWFkZGlyKHBhdGguam9pbihzdG9yYWdlLndvcmtEaXIsIHJvb3RQYXRoKSk7XG4gICAgdmFyIGlkeDogSW5kZXg8Tz4gPSB7fTtcblxuICAgIGZvciAoY29uc3QgZGlyIG9mIGRpcnMpIHtcbiAgICAgIGlmIChkaXIgIT0gJy5EU19TdG9yZScpIHtcbiAgICAgICAgY29uc3Qgb2JqRGF0YSA9IGF3YWl0IHN0b3JhZ2UubG9hZE9iamVjdChwYXRoLmpvaW4ocm9vdFBhdGgsIGRpcikpO1xuICAgICAgICBpZiAob2JqRGF0YSkge1xuICAgICAgICAgIGNvbnN0IG9iajogTyA9IHRoaXMucG9zdExvYWQob2JqRGF0YSk7XG4gICAgICAgICAgaWYgKG9iai5pZCkge1xuICAgICAgICAgICAgaWR4W29iai5pZF0gPSBvYmo7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBpZHg7XG4gIH1cblxuICAvLyBUT0RPOiBVc2UgYHRvVXNlYWJsZU9iamVjdChkYXRhOiBhbnkpID0+IE9gIHRvIHBvc3QtcHJvY2VzcyBsb2FkZWQgZGF0YVxuXG4gIC8vIFN0b3JlcyBvYmplY3QgaW4gREJcbiAgcHVibGljIGFzeW5jIHN0b3JlKG9iajogTywgc3RvcmFnZTogU3RvcmFnZTxhbnk+LCB1cGRhdGVJbmRleCA9IHRydWUpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBsb2cuZGVidWcoYFNTRTogU3RvcmFnZU1hbmFnZXIgZm9yICR7dGhpcy5yb290RGlyfTogU3RvcmluZyBvYmplY3QgJHtvYmouaWR9YCk7XG4gICAgbG9nLnNpbGx5KGBTU0U6IFN0b3JhZ2VNYW5hZ2VyIGZvciAke3RoaXMucm9vdERpcn06IFN0b3Jpbmcgb2JqZWN0ICR7b2JqLmlkfTogJHtKU09OLnN0cmluZ2lmeShvYmopfWApO1xuXG4gICAgY29uc3Qgb2JqRGlyID0gcGF0aC5qb2luKHRoaXMucm9vdERpciwgYCR7b2JqLmlkfWApO1xuICAgIGNvbnN0IG9ialBhdGggPSBwYXRoLmpvaW4oc3RvcmFnZS53b3JrRGlyLCBvYmpEaXIpO1xuICAgIGNvbnN0IHN0b3JlYWJsZSA9IHRoaXMudG9TdG9yZWFibGVPYmplY3Qob2JqKTtcblxuICAgIGF3YWl0IHN0b3JhZ2UuZnMuZW5zdXJlRGlyKG9ialBhdGgpO1xuICAgIGZvciAoY29uc3Qga2V5IG9mIE9iamVjdC5rZXlzKHN0b3JlYWJsZSkpIHtcbiAgICAgIGNvbnN0IGRhdGEgPSBzdG9yZWFibGVba2V5XTtcbiAgICAgIGF3YWl0IHN0b3JhZ2UueWFtbC5zdG9yZShwYXRoLmpvaW4ob2JqUGF0aCwgYCR7a2V5fS55YW1sYCksIGRhdGEpO1xuICAgIH1cblxuICAgIGlmICh1cGRhdGVJbmRleCA9PT0gdHJ1ZSkge1xuICAgICAgbG9nLmRlYnVnKGBTU0U6IFN0b3JhZ2VNYW5hZ2VyIGZvciAke3RoaXMucm9vdERpcn06IFN0b3Jpbmcgb2JqZWN0ICR7b2JqLmlkfTogVXBkYXRpbmcgaW5kZXhgKTtcbiAgICAgIGF3YWl0IHRoaXMudXBkYXRlSW5kZXhlZEl0ZW0ob2JqLCBzdG9yYWdlKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyB1cGRhdGVJbmRleGVkSXRlbShvYmo6IE8sIHN0b3JhZ2U6IFN0b3JhZ2U8YW55Pikge1xuICAgIGF3YWl0IHRoaXMuZ2V0SW5kZXgoc3RvcmFnZSk7XG4gICAgKHRoaXMuX2luZGV4IGFzIEluZGV4PE8+KVtvYmouaWRdID0gb2JqO1xuICB9XG5cbiAgcHVibGljIHRvU3RvcmVhYmxlT2JqZWN0KG9iajogTyk6IGFueSB7XG4gICAgcmV0dXJuIHsgbWV0YTogb2JqIGFzIGFueSB9O1xuICB9O1xuXG4gIC8vIENvbnZlcnRzIG9iamVjdCBkYXRhIGludG8gdmFsaWQgb2JqZWN0LCBpZiBuZWVkZWRcbiAgLy8gKGluIGNhc2VzIHdoZW4gcGFydGlhbCBkYXRhIGlzIHN0b3JlZCBvciBtaWdyYXRpb24gdG9vayBwbGFjZSBwcmV2aW91c2x5KVxuICBwdWJsaWMgcG9zdExvYWQob2JqOiBhbnkpOiBPIHtcbiAgICByZXR1cm4gb2JqIGFzIE87XG4gIH1cblxuICBwdWJsaWMgb2JqZWN0TWF0Y2hlc1F1ZXJ5KG9iajogTywgcXVlcnk6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxufVxuXG5cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBTdG9yYWdlPFcgZXh0ZW5kcyBXb3Jrc3BhY2U+IHtcbiAgcHVibGljIHlhbWw6IFlBTUxTdG9yYWdlO1xuICBwdWJsaWMgd29ya3NwYWNlOiBXO1xuXG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBmczogdHlwZW9mIGltcG9ydCgnZnMtZXh0cmEnKSwgcHVibGljIHdvcmtEaXI6IHN0cmluZyxcbiAgICAgIHB1YmxpYyBzdG9yZU1hbmFnZXJzOiB7IFtrZXk6IHN0cmluZ106IFN0b3JlTWFuYWdlcjxhbnk+IH0pIHtcbiAgICB0aGlzLmZzID0gZnM7XG4gICAgdGhpcy53b3JrRGlyID0gd29ya0RpcjtcbiAgICB0aGlzLnlhbWwgPSBuZXcgWUFNTFN0b3JhZ2UoZnMpO1xuXG4gICAgdGhpcy53b3Jrc3BhY2UgPSBPYmplY3Qua2V5cyhzdG9yZU1hbmFnZXJzKS5yZWR1Y2UoKG9iajogYW55LCBrZXk6IHN0cmluZykgPT4ge1xuICAgICAgb2JqW2tleV0gPSB7fTtcbiAgICAgIHJldHVybiBvYmo7XG4gICAgfSwge30pIGFzIFc7XG4gIH1cblxuICBwdWJsaWMgYWJzdHJhY3QgYXN5bmMgZmluZE9iamVjdHMocXVlcnk/OiBzdHJpbmcpOiBQcm9taXNlPFc+XG5cbiAgcHVibGljIGFzeW5jIGxvYWRXb3Jrc3BhY2UoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdGhpcy53b3Jrc3BhY2UgPSBhd2FpdCBPYmplY3Qua2V5cyh0aGlzLnN0b3JlTWFuYWdlcnMpLnJlZHVjZShhc3luYyAob2JqUDogUHJvbWlzZTxhbnk+LCBrZXk6IHN0cmluZykgPT4ge1xuICAgICAgY29uc3Qgb2JqID0gYXdhaXQgb2JqUDtcbiAgICAgIG9ialtrZXldID0gYXdhaXQgdGhpcy5zdG9yZU1hbmFnZXJzW2tleV0uZ2V0SW5kZXgodGhpcyk7XG4gICAgICByZXR1cm4gb2JqO1xuICAgIH0sIFByb21pc2UucmVzb2x2ZSh7fSkpIGFzIFc7XG4gIH1cblxuICBhc3luYyBzdG9yZVdvcmtzcGFjZSgpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICByZXR1cm4gUHJvbWlzZS5hbGwoWy4uLk9iamVjdC5rZXlzKHRoaXMuc3RvcmVNYW5hZ2VycykubWFwKGFzeW5jIChrZXkpID0+IHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLnN0b3JlTWFuYWdlcnNba2V5XS5zdG9yZUluZGV4KHRoaXMsIHRoaXMud29ya3NwYWNlW2tleV0pO1xuICAgIH0pXSkudGhlbigoKSA9PiB0cnVlKTtcbiAgfVxuXG4gIC8vIExvYWRzIG9iamVjdCBkYXRhIGZyb20gZ2l2ZW4gZGlyZWN0b3J5LCByZWFkaW5nIFlBTUwgZmlsZXMuXG4gIC8vIG1ldGEueWFtbCBpcyB0cmVhdGVkIHNwZWNpYWxseSwgcG9wdWxhdGluZyB0b3AtbGV2ZWwgb2JqZWN0IHBheWxvYWQuXG4gIC8vIE90aGVyIFlBTUwgZmlsZXMgcG9wdWxhdGUgY29ycmVzcG9uZGluZyBvYmplY3QgcHJvcGVydGllcy5cbiAgcHVibGljIGFzeW5jIGxvYWRPYmplY3Qob2JqRGlyOiBzdHJpbmcpOiBQcm9taXNlPGFueSB8IHVuZGVmaW5lZD4ge1xuICAgIGxldCBvYmpEYXRhOiB7W3Byb3BOYW1lOiBzdHJpbmddOiBhbnl9O1xuXG4gICAgY29uc3QgbWV0YUZpbGUgPSBwYXRoLmpvaW4odGhpcy53b3JrRGlyLCBvYmpEaXIsICdtZXRhLnlhbWwnKTtcbiAgICBsZXQgbWV0YUZpbGVJc0ZpbGU6IGJvb2xlYW47XG4gICAgdHJ5IHtcbiAgICAgIG1ldGFGaWxlSXNGaWxlID0gKGF3YWl0IHRoaXMuZnMuc3RhdChtZXRhRmlsZSkpLmlzRmlsZSgpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuICAgIGlmICghbWV0YUZpbGVJc0ZpbGUpIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuICAgIG9iakRhdGEgPSBhd2FpdCB0aGlzLnlhbWwubG9hZChtZXRhRmlsZSk7XG5cbiAgICBjb25zdCBkaXJDb250ZW50cyA9IGF3YWl0IHRoaXMuZnMucmVhZGRpcihwYXRoLmpvaW4odGhpcy53b3JrRGlyLCBvYmpEaXIpKTtcbiAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgZGlyQ29udGVudHMpIHtcbiAgICAgIGlmIChwYXRoLmV4dG5hbWUoaXRlbSkgPT0gWUFNTF9FWFQpIHtcbiAgICAgICAgY29uc3QgYmFzZW5hbWUgPSBwYXRoLmJhc2VuYW1lKGl0ZW0sIFlBTUxfRVhUKTtcbiAgICAgICAgaWYgKGJhc2VuYW1lICE9ICdtZXRhJykge1xuICAgICAgICAgIG9iakRhdGFbYmFzZW5hbWVdID0gYXdhaXQgdGhpcy55YW1sLmxvYWQocGF0aC5qb2luKHRoaXMud29ya0Rpciwgb2JqRGlyLCBpdGVtKSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBCbGluZGx5IGhvcGUgdGhhdCBkYXRhIHN0cnVjdHVyZSBsb2FkZWQgZnJvbSBZQU1MXG4gICAgLy8gaXMgdmFsaWQgZm9yIGdpdmVuIHR5cGUuXG4gICAgcmV0dXJuIG9iakRhdGE7XG4gIH1cblxuICBzZXRVcEFQSUVuZHBvaW50cyhub3RpZmllcjogKG5vdGlmeTogc3RyaW5nW10pID0+IHZvaWQpIHtcbiAgICBsb2cudmVyYm9zZShcIlNTRTogU3RvcmFnZTogU2V0dGluZyBBUEkgZW5kcG9pbnRzXCIpO1xuXG4gICAgZm9yIChsZXQgaW5kZXhOYW1lIG9mIE9iamVjdC5rZXlzKHRoaXMud29ya3NwYWNlKSkge1xuXG4gICAgICBtYWtlRW5kcG9pbnQ8SW5kZXg8YW55Pj4oYHN0b3JhZ2UtJHtpbmRleE5hbWV9LWFsbGAsIGFzeW5jICgpID0+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMud29ya3NwYWNlW2luZGV4TmFtZV07XG4gICAgICB9LCBhc3luYyAoeyBuZXdEYXRhLCBub3RpZnkgfSkgPT4ge1xuICAgICAgICBhd2FpdCB0aGlzLnN0b3JlTWFuYWdlcnNbaW5kZXhOYW1lXS5zdG9yZUluZGV4KHRoaXMsIG5ld0RhdGEpO1xuICAgICAgICBub3RpZmllcihbaW5kZXhOYW1lLCAuLi4obm90aWZ5IHx8IFtdKV0pO1xuICAgICAgfSk7XG5cbiAgICAgIG1ha2VFbmRwb2ludDxJbmRleGFibGVPYmplY3Q+KGBzdG9yYWdlLSR7aW5kZXhOYW1lfWAsIGFzeW5jICh7IG9iamVjdElkIH06IHsgb2JqZWN0SWQ6IHN0cmluZyB9KSA9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLndvcmtzcGFjZVtpbmRleE5hbWVdW29iamVjdElkXTtcbiAgICAgIH0sIGFzeW5jICh7IG5ld0RhdGEsIG5vdGlmeSB9KSA9PiB7XG4gICAgICAgIGF3YWl0IHRoaXMuc3RvcmVNYW5hZ2Vyc1tpbmRleE5hbWVdLnN0b3JlKG5ld0RhdGEsIHRoaXMpO1xuICAgICAgICBub3RpZmllcihbaW5kZXhOYW1lLCAuLi4obm90aWZ5IHx8IFtdKV0pO1xuICAgICAgfSk7XG5cbiAgICAgIG1ha2VFbmRwb2ludDxib29sZWFuPihgc3RvcmFnZS0ke2luZGV4TmFtZX0tZGVsZXRlYCwgYXN5bmMgKHsgb2JqZWN0SWQgfTogeyBvYmplY3RJZDogc3RyaW5nIH0pID0+IHtcbiAgICAgICAgZGVsZXRlIHRoaXMud29ya3NwYWNlW2luZGV4TmFtZV1bb2JqZWN0SWRdO1xuICAgICAgICBhd2FpdCB0aGlzLnN0b3JlTWFuYWdlcnNbaW5kZXhOYW1lXS5zdG9yZUluZGV4KHRoaXMsIHRoaXMud29ya3NwYWNlW2luZGV4TmFtZV0pO1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH0pO1xuXG4gICAgfVxuICB9XG59XG4iXX0=