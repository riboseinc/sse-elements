import * as path from 'path';
import * as fs from 'fs-extra';
import * as yaml from 'js-yaml';
import { Schema } from './schema';
import { AbstractLockingFilesystemBackend } from '../base';
const YAML_EXT = '.yaml';
export class YAMLBackend extends AbstractLockingFilesystemBackend {
    isYAMLFile(objId) {
        return path.extname(objId) === YAML_EXT;
    }
    async isValidId(objId) {
        return this.isYAMLFile(objId);
    }
    async resolveObjectId(objId) {
        // Drop YAML extension from resolved path fragment.
        const idWithExt = await super.resolveObjectId(objId);
        return path.basename(idWithExt, YAML_EXT);
    }
    expandPath(objId) {
        // In this case, path to object should include YAML extension.
        return `${super.expandPath(objId)}${YAML_EXT}`;
    }
    parseData(data) {
        return yaml.load(data, { schema: Schema });
    }
    dumpData(data) {
        if (data !== undefined && data !== null) {
            return yaml.dump(data, {
                schema: Schema,
                noRefs: true,
                noCompatMode: true,
            });
        }
        else {
            throw new Error("Attempt to write invalid data (null or undefined)");
        }
    }
}
;
export class YAMLDirectoryBackend extends YAMLBackend {
    constructor(baseDir, metaProperties) {
        super(baseDir);
        this.metaProperties = metaProperties;
    }
    expandDirectoryPath(objId) {
        return path.join(this.baseDir, objId);
    }
    async exists(objId) {
        const dirPath = this.expandDirectoryPath(objId);
        if (await fs.pathExists(dirPath)) {
            const stat = await fs.stat(dirPath);
            if (!stat.isDirectory()) {
                throw new Error("File is expected to be a directory");
            }
            return true;
        }
        return false;
    }
    async isValidId(value) {
        const metaFile = path.join(this.expandDirectoryPath(value), `meta${YAML_EXT}`);
        let metaFileIsFile;
        try {
            metaFileIsFile = (await fs.stat(metaFile)).isFile();
        }
        catch (e) {
            return false;
        }
        if (!metaFileIsFile) {
            return false;
        }
        return metaFileIsFile;
    }
    async read(objId) {
        const objAbsPath = this.expandDirectoryPath(objId);
        const metaId = 'meta';
        const metaAbsPath = path.join(objAbsPath, `${metaId}${YAML_EXT}`);
        let metaFileIsFile;
        try {
            metaFileIsFile = (await fs.stat(metaAbsPath)).isFile();
        }
        catch (e) {
            throw new Error(`Exception accessing meta file for ${objId}: ${metaAbsPath}: ${e.toString()} ${e.stack}`);
        }
        if (!metaFileIsFile) {
            throw new Error(`Meta file for ${objId} is not a file: ${metaAbsPath}`);
        }
        var objData = {};
        const metaPath = path.join(objId, metaId);
        const meta = await super.read(metaPath) || {};
        for (const key of this.metaProperties) {
            objData[key] = meta[key];
        }
        const dirContents = await fs.readdir(objAbsPath);
        for (const filename of dirContents) {
            if (this.isYAMLFile(filename)) {
                const fieldName = path.basename(filename, YAML_EXT);
                if (fieldName != 'meta') {
                    objData[fieldName] = await super.read(path.join(objId, fieldName));
                }
            }
        }
        // Blindly hope that data structure loaded from YAML
        // is valid for given type.
        return objData;
    }
    async write(objId, newData) {
        const objPath = this.expandDirectoryPath(objId);
        await fs.ensureDir(objPath);
        var dataToStore = { meta: {} };
        var modifiedPaths = [];
        for (const key of Object.keys(newData)) {
            if (this.metaProperties.indexOf(key) >= 0) {
                dataToStore.meta[key] = newData[key];
            }
            else {
                dataToStore[key] = newData[key];
            }
        }
        for (const [fieldName, fieldValue] of Object.entries(dataToStore)) {
            modifiedPaths = [
                ...modifiedPaths,
                ...(await super.write(path.join(objId, fieldName), fieldValue)),
            ];
        }
        return modifiedPaths;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvc3RvcmFnZS9tYWluL2ZpbGVzeXN0ZW0veWFtbC9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEtBQUssSUFBSSxNQUFNLE1BQU0sQ0FBQztBQUM3QixPQUFPLEtBQUssRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUMvQixPQUFPLEtBQUssSUFBSSxNQUFNLFNBQVMsQ0FBQztBQUNoQyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBRWxDLE9BQU8sRUFBRSxnQ0FBZ0MsRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUczRCxNQUFNLFFBQVEsR0FBRyxPQUFPLENBQUM7QUFHekIsTUFBTSxPQUFPLFdBQXFCLFNBQVEsZ0NBQW1DO0lBRWpFLFVBQVUsQ0FBQyxLQUFhO1FBQ2hDLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsS0FBSyxRQUFRLENBQUM7SUFDMUMsQ0FBQztJQUVNLEtBQUssQ0FBQyxTQUFTLENBQUMsS0FBYTtRQUNsQyxPQUFPLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDaEMsQ0FBQztJQUVNLEtBQUssQ0FBQyxlQUFlLENBQUMsS0FBYTtRQUN4QyxtREFBbUQ7UUFDbkQsTUFBTSxTQUFTLEdBQUcsTUFBTSxLQUFLLENBQUMsZUFBZSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3JELE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxTQUFTLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDNUMsQ0FBQztJQUVNLFVBQVUsQ0FBQyxLQUFhO1FBQzdCLDhEQUE4RDtRQUM5RCxPQUFPLEdBQUcsS0FBSyxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsR0FBRyxRQUFRLEVBQUUsQ0FBQztJQUNqRCxDQUFDO0lBRVMsU0FBUyxDQUFDLElBQVk7UUFDOUIsT0FBTyxJQUFJLENBQUMsSUFBSSxD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QW1DLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRSxDQUFDO1FBQy9ELElBQUksYUFBYSxHQUFHLEVBQWMsQ0FBQztRQUVuQyxLQUFLLE1BQU0sR0FBRyxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUU7WUFDdEMsSUFBSSxJQUFJLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUU7Z0JBQ3pDLFdBQVcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2FBQ3RDO2lCQUFNO2dCQUNMLFdBQVcsQ0FBQyxHQUFHLENBQUMsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7YUFDakM7U0FDRjtRQUVELEtBQUssTUFBTSxDQUFDLFNBQVMsRUFBRSxVQUFVLENBQUMsSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxFQUFFO1lBQ2pFLGFBQWEsR0FBRztnQkFDZCxHQUFHLGFBQWE7Z0JBQ2hCLEdBQUcsQ0FBQyxNQUFNLEtBQUssQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsU0FBUyxDQUFDLEVBQUUsVUFBVSxDQUFDLENBQUM7YUFDaEUsQ0FBQztTQUNIO1FBRUQsT0FBTyxhQUFhLENBQUM7SUFDdkIsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzLWV4dHJhJztcbmltcG9ydCAqIGFzIHlhbWwgZnJvbSAnanMteWFtbCc7XG5pbXBvcnQgeyBTY2hlbWEgfSBmcm9tICcuL3NjaGVtYSc7XG5cbmltcG9ydCB7IEFic3RyYWN0TG9ja2luZ0ZpbGVzeXN0ZW1CYWNrZW5kIH0gZnJvbSAnLi4vYmFzZSc7XG5cblxuY29uc3QgWUFNTF9FWFQgPSAnLnlhbWwnO1xuXG5cbmV4cG9ydCBjbGFzcyBZQU1MQmFja2VuZDxUID0gYW55PiBleHRlbmRzIEFic3RyYWN0TG9ja2luZ0ZpbGVzeXN0ZW1CYWNrZW5kPFQ+IHtcblxuICBwcm90ZWN0ZWQgaXNZQU1MRmlsZShvYmpJZDogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHBhdGguZXh0bmFtZShvYmpJZCkgPT09IFlBTUxfRVhUO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGlzVmFsaWRJZChvYmpJZDogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHRoaXMuaXNZQU1MRmlsZShvYmpJZCk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgcmVzb2x2ZU9iamVjdElkKG9iaklkOiBzdHJpbmcpIHtcbiAgICAvLyBEcm9wIFlBTUwgZXh0ZW5zaW9uIGZyb20gcmVzb2x2ZWQgcGF0aCBmcmFnbWVudC5cbiAgICBjb25zdCBpZFdpdGhFeHQgPSBhd2FpdCBzdXBlci5yZXNvbHZlT2JqZWN0SWQob2JqSWQpO1xuICAgIHJldHVybiBwYXRoLmJhc2VuYW1lKGlkV2l0aEV4dCwgWUFNTF9FWFQpO1xuICB9XG5cbiAgcHVibGljIGV4cGFuZFBhdGgob2JqSWQ6IHN0cmluZykge1xuICAgIC8vIEluIHRoaXMgY2FzZSwgcGF0aCB0byBvYmplY3Qgc2hvdWxkIGluY2x1ZGUgWUFNTCBleHRlbnNpb24uXG4gICAgcmV0dXJuIGAke3N1cGVyLmV4cGFuZFBhdGgob2JqSWQpfSR7WUFNTF9FWFR9YDtcbiAgfVxuXG4gIHByb3RlY3RlZCBwYXJzZURhdGEoZGF0YTogc3RyaW5nKTogYW55IHtcbiAgICByZXR1cm4geWFtbC5sb2FkKGRhdGEsIHsgc2NoZW1hOiBTY2hlbWEgfSk7XG4gIH1cblxuICBwcm90ZWN0ZWQgZHVtcERhdGEoZGF0YTogYW55KTogc3RyaW5nIHtcbiAgICBpZiAoZGF0YSAhPT0gdW5kZWZpbmVkICYmIGRhdGEgIT09IG51bGwpIHtcbiAgICAgIHJldHVybiB5YW1sLmR1bXAoZGF0YSwge1xuICAgICAgICBzY2hlbWE6IFNjaGVtYSxcbiAgICAgICAgbm9SZWZzOiB0cnVlLFxuICAgICAgICBub0NvbXBhdE1vZGU6IHRydWUsXG4gICAgICB9KTtcblxuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJBdHRlbXB0IHRvIHdyaXRlIGludmFsaWQgZGF0YSAobnVsbCBvciB1bmRlZmluZWQpXCIpO1xuXG4gICAgfVxuICB9XG59XG5cblxuaW50ZXJmYWNlIFlBTUxEaXJlY3RvcnlTdG9yZWFibGVDb250ZW50cyB7XG4gIG1ldGE6IGFueSxcbiAgW2tleTogc3RyaW5nXTogYW55LFxufTtcblxuZXhwb3J0IGNsYXNzIFlBTUxEaXJlY3RvcnlCYWNrZW5kIGV4dGVuZHMgWUFNTEJhY2tlbmQ8WUFNTERpcmVjdG9yeVN0b3JlYWJsZUNvbnRlbnRzPiB7XG5cbiAgY29uc3RydWN0b3IoYmFzZURpcjogc3RyaW5nLCBwcml2YXRlIG1ldGFQcm9wZXJ0aWVzOiBzdHJpbmdbXSkgeyBzdXBlcihiYXNlRGlyKTsgfVxuXG4gIHByaXZhdGUgZXhwYW5kRGlyZWN0b3J5UGF0aChvYmpJZDogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHBhdGguam9pbih0aGlzLmJhc2VEaXIsIG9iaklkKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBleGlzdHMob2JqSWQ6IHN0cmluZykge1xuICAgIGNvbnN0IGRpclBhdGggPSB0aGlzLmV4cGFuZERpcmVjdG9yeVBhdGgob2JqSWQpO1xuICAgIGlmIChhd2FpdCBmcy5wYXRoRXhpc3RzKGRpclBhdGgpKSB7XG4gICAgICBjb25zdCBzdGF0ID0gYXdhaXQgZnMuc3RhdChkaXJQYXRoKTtcbiAgICAgIGlmICghc3RhdC5pc0RpcmVjdG9yeSgpKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIkZpbGUgaXMgZXhwZWN0ZWQgdG8gYmUgYSBkaXJlY3RvcnlcIik7XG4gICAgICB9XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGlzVmFsaWRJZCh2YWx1ZTogc3RyaW5nKSB7XG4gICAgY29uc3QgbWV0YUZpbGUgPSBwYXRoLmpvaW4odGhpcy5leHBhbmREaXJlY3RvcnlQYXRoKHZhbHVlKSwgYG1ldGEke1lBTUxfRVhUfWApO1xuICAgIGxldCBtZXRhRmlsZUlzRmlsZTogYm9vbGVhbjtcbiAgICB0cnkge1xuICAgICAgbWV0YUZpbGVJc0ZpbGUgPSAoYXdhaXQgZnMuc3RhdChtZXRhRmlsZSkpLmlzRmlsZSgpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgaWYgKCFtZXRhRmlsZUlzRmlsZSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICByZXR1cm4gbWV0YUZpbGVJc0ZpbGU7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgcmVhZChvYmpJZDogc3RyaW5nKSB7XG4gICAgY29uc3Qgb2JqQWJzUGF0aCA9IHRoaXMuZXhwYW5kRGlyZWN0b3J5UGF0aChvYmpJZCk7XG5cbiAgICBjb25zdCBtZXRhSWQgPSAnbWV0YSc7XG5cbiAgICBjb25zdCBtZXRhQWJzUGF0aCA9IHBhdGguam9pbihvYmpBYnNQYXRoLCBgJHttZXRhSWR9JHtZQU1MX0VYVH1gKTtcbiAgICBsZXQgbWV0YUZpbGVJc0ZpbGU6IGJvb2xlYW47XG4gICAgdHJ5IHtcbiAgICAgIG1ldGFGaWxlSXNGaWxlID0gKGF3YWl0IGZzLnN0YXQobWV0YUFic1BhdGgpKS5pc0ZpbGUoKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEV4Y2VwdGlvbiBhY2Nlc3NpbmcgbWV0YSBmaWxlIGZvciAke29iaklkfTogJHttZXRhQWJzUGF0aH06ICR7ZS50b1N0cmluZygpfSAke2Uuc3RhY2t9YCk7XG4gICAgfVxuICAgIGlmICghbWV0YUZpbGVJc0ZpbGUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgTWV0YSBmaWxlIGZvciAke29iaklkfSBpcyBub3QgYSBmaWxlOiAke21ldGFBYnNQYXRofWApO1xuICAgIH1cblxuICAgIHZhciBvYmpEYXRhOiBhbnkgPSB7fTtcblxuICAgIGNvbnN0IG1ldGFQYXRoID0gcGF0aC5qb2luKG9iaklkLCBtZXRhSWQpO1xuICAgIGNvbnN0IG1ldGEgPSBhd2FpdCBzdXBlci5yZWFkKG1ldGFQYXRoKSB8fCB7fTtcbiAgICBmb3IgKGNvbnN0IGtleSBvZiB0aGlzLm1ldGFQcm9wZXJ0aWVzKSB7XG4gICAgICBvYmpEYXRhW2tleV0gPSBtZXRhW2tleV07XG4gICAgfVxuXG4gICAgY29uc3QgZGlyQ29udGVudHMgPSBhd2FpdCBmcy5yZWFkZGlyKG9iakFic1BhdGgpO1xuICAgIGZvciAoY29uc3QgZmlsZW5hbWUgb2YgZGlyQ29udGVudHMpIHtcbiAgICAgIGlmICh0aGlzLmlzWUFNTEZpbGUoZmlsZW5hbWUpKSB7XG4gICAgICAgIGNvbnN0IGZpZWxkTmFtZSA9IHBhdGguYmFzZW5hbWUoZmlsZW5hbWUsIFlBTUxfRVhUKTtcbiAgICAgICAgaWYgKGZpZWxkTmFtZSAhPSAnbWV0YScpIHtcbiAgICAgICAgICBvYmpEYXRhW2ZpZWxkTmFtZV0gPSBhd2FpdCBzdXBlci5yZWFkKHBhdGguam9pbihvYmpJZCwgZmllbGROYW1lKSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBCbGluZGx5IGhvcGUgdGhhdCBkYXRhIHN0cnVjdHVyZSBsb2FkZWQgZnJvbSBZQU1MXG4gICAgLy8gaXMgdmFsaWQgZm9yIGdpdmVuIHR5cGUuXG4gICAgcmV0dXJuIG9iakRhdGE7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgd3JpdGUob2JqSWQ6IHN0cmluZywgbmV3RGF0YTogYW55KSB7XG4gICAgY29uc3Qgb2JqUGF0aCA9IHRoaXMuZXhwYW5kRGlyZWN0b3J5UGF0aChvYmpJZCk7XG5cbiAgICBhd2FpdCBmcy5lbnN1cmVEaXIob2JqUGF0aCk7XG5cbiAgICB2YXIgZGF0YVRvU3RvcmU6IFlBTUxEaXJlY3RvcnlTdG9yZWFibGVDb250ZW50cyA9IHsgbWV0YToge30gfTtcbiAgICB2YXIgbW9kaWZpZWRQYXRocyA9IFtdIGFzIHN0cmluZ1tdO1xuXG4gICAgZm9yIChjb25zdCBrZXkgb2YgT2JqZWN0LmtleXMobmV3RGF0YSkpIHtcbiAgICAgIGlmICh0aGlzLm1ldGFQcm9wZXJ0aWVzLmluZGV4T2Yoa2V5KSA+PSAwKSB7XG4gICAgICAgIGRhdGFUb1N0b3JlLm1ldGFba2V5XSA9IG5ld0RhdGFba2V5XTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGRhdGFUb1N0b3JlW2tleV0gPSBuZXdEYXRhW2tleV07XG4gICAgICB9XG4gICAgfVxuXG4gICAgZm9yIChjb25zdCBbZmllbGROYW1lLCBmaWVsZFZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhkYXRhVG9TdG9yZSkpIHtcbiAgICAgIG1vZGlmaWVkUGF0aHMgPSBbXG4gICAgICAgIC4uLm1vZGlmaWVkUGF0aHMsXG4gICAgICAgIC4uLihhd2FpdCBzdXBlci53cml0ZShwYXRoLmpvaW4ob2JqSWQsIGZpZWxkTmFtZSksIGZpZWxkVmFsdWUpKSxcbiAgICAgIF07XG4gICAgfVxuXG4gICAgcmV0dXJuIG1vZGlmaWVkUGF0aHM7XG4gIH1cbn1cbiJdfQ==