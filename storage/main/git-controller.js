import * as path from 'path';
import * as fs from 'fs-extra';
import * as git from 'isomorphic-git';
import { ipcMain } from 'electron';
import { makeEndpoint } from 'api/main';
import { Setting, manager as settings } from 'settings/main';
import { openWindow } from 'main/window';
settings.configurePane({
    id: 'dataSync',
    label: "Data synchronization",
    icon: 'git-merge',
});
settings.register(new Setting('gitRepoUrl', "Git repository URL", 'dataSync'));
export class GitController {
    constructor(fs, repoUrl, workDir, corsProxy) {
        this.fs = fs;
        this.repoUrl = repoUrl;
        this.workDir = workDir;
        this.corsProxy = corsProxy;
        this.auth = {};
        git.plugins.set('fs', fs);
    }
    async getAuthor() {
        const name = await git.config({ dir: this.workDir, path: 'user.name' });
        const email = await git.config({ dir: this.workDir, path: 'user.email' });
        return { name: name, email: email };
    }
    async setAuthor(author) {
        await git.config({ dir: this.workDir, path: 'user.name', value: author.name });
        await git.config({ dir: this.workDir, path: 'user.email', value: author.email });
    }
    async setAuth(auth) {
        try {
            // Try fetching with auth; will throw if auth is invalid
            git.fetch(Object.assign({ dir: this.workDir }, auth));
        }
        catch (e) {
            return false;
        }
        this.auth = auth;
        return true;
    }
    async isInitialized() {
        let gitInitialized;
        try {
            gitInitialized = (await this.fs.stat(path.join(this.workDir, '.git'))).isDirectory();
        }
        catch (e) {
            gitInitialized = false;
        }
        return gitInitialized;
    }
    async getOriginUrl() {
        return ((await git.listRemotes({
            dir: this.workDir,
        })).find(r => r.remote === 'origin') || { url: null }).url;
    }
    async getUpstreamUrl() {
        return ((await git.listRemotes({
            dir: this.workDir,
        })).find(r => r.remote === 'upstream') || { url: null }).url;
    }
    async addAllChanges() {
        await git.add({
            dir: this.workDir,
            filepath: '.',
        });
    }
    async listChangedFiles() {
        const FILE = 0, HEAD = 1, WORKDIR = 2;
        return (await git.statusMatrix({ dir: this.workDir }))
            .filter(row => row[HEAD] !== row[WORKDIR])
            .map(row => row[FILE]);
    }
    async pull() {
        await git.pull(Object.assign({ dir: this.workDir, ref: 'master', singleBranch: true, fastForwardOnly: true }, this.auth));
    }
    async commit(msg) {
        await git.commit({
            dir: this.workDir,
            message: msg,
            author: {},
        });
    }
    async push() {
        await git.push(Object.assign({ dir: this.workDir, remote: 'origin' }, this.auth));
    }
    async reset() {
        await this.fs.remove(this.workDir);
        await this.fs.ensureDir(this.workDir);
        await git.clone(Object.assign({ dir: this.workDir, url: this.repoUrl, ref: 'master', singleBranch: true, depth: 10, corsProxy: this.corsProxy }, this.auth));
    }
    setUpAPIEndpoints() {
        makeEndpoint('git-config', async () => {
            return {
                originURL: await this.getOriginUrl(),
                author: await this.getAuthor(),
            };
        });
        makeEndpoint('fetch-commit-push', async ({ commitMsg, authorName, authorEmail, gitUsername, gitPassword, }) => {
            await this.setAuthor({ name: authorName, email: authorEmail });
            try {
                await this.setAuth({ username: gitUsername, password: gitPassword });
            }
            catch (e) {
                return { errors: [`Error while authenticating: ${e.toString()}`] };
            }
            try {
                await this.pull();
            }
            catch (e) {
                return { errors: [`Error while fetching and merging changes: ${e.toString()}`] };
            }
            const changedFiles = await this.listChangedFiles();
            if (changedFiles.length < 1) {
                return { errors: ["No changes to submit!"] };
            }
            await this.addAllChanges();
            await this.commit(commitMsg);
            try {
                await this.push();
            }
            catch (e) {
                return { errors: [`Error while pushing changes: ${e.toString()}`] };
            }
            return { errors: [] };
        });
    }
}
export async function initRepo(workDir, repoUrl, corsProxyUrl) {
    const gitCtrl = new GitController(fs, repoUrl, workDir, corsProxyUrl);
    if ((await gitCtrl.isInitialized()) === true) {
        const remoteUrl = await gitCtrl.getOriginUrl();
        if (remoteUrl !== null && remoteUrl.trim() === repoUrl.trim()) {
            await gitCtrl.pull();
        }
        else {
            await gitCtrl.reset();
        }
    }
    else {
        await gitCtrl.reset();
    }
    return gitCtrl;
}
/* Promises to return a string containing configured repository URL.
   If repository URL is not configured (e.g., on first run, or after reset)
   opens a window with specified options.
   The window is expected to ask the user to specify the URL and send a `'set-setting'`
   event for `'gitRepoUrl'`. */
export async function setRepoUrl(configWindow) {
    const repoUrl = await settings.getValue('gitRepoUrl');
    return new Promise(async (resolve, reject) => {
        if (!repoUrl) {
            await openWindow(configWindow);
            ipcMain.on('set-setting', handleSetting);
            function handleSetting(evt, name, value) {
                if (name === 'gitRepoUrl') {
                    ipcMain.removeListener('set-setting', handleSetting);
                    resolve(value);
                }
                evt.reply('ok');
            }
        }
        else {
            resolve(repoUrl);
        }
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2l0LWNvbnRyb2xsZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvc3RvcmFnZS9tYWluL2dpdC1jb250cm9sbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sS0FBSyxJQUFJLE1BQU0sTUFBTSxDQUFDO0FBQzdCLE9BQU8sS0FBSyxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBQy9CLE9BQU8sS0FBSyxHQUFHLE1BQU0sZ0JBQWdCLENBQUM7QUFFdEMsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUVuQyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBQ3hDLE9BQU8sRUFBRSxPQUFPLEVBQUUsT0FBTyxJQUFJLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM3RCxPQUFPLEVBQXNCLFVBQVUsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUs3RCxRQUFRLENBQUMsYUFBYSxDQUFDO0lBQ3JCLEVBQUUsRUFBRSxVQUFVO0lBQ2QsS0FBSyxFQUFFLHNCQUFzQjtJQUM3QixJQUFJLEVBQUUsV0FBVztDQUNsQixDQUFDLENBQUM7QUFDSCxRQUFRLENBQUMsUUFBUSxDQUFDLElBQUksT0FBTyxDQUMzQixZQUFZLEVBQ1osb0JBQW9CLEVBQ3BCLFVBQVUsQ0FDWCxDQUFDLENBQUM7QUFHSCxNQUFNLE9BQU8sYUFBYTtJQUd4QixZQUNZLEVBQU8sRUFDUCxPQUFlLEVBQ2YsT0FBZSxFQUNmLFNBQWlCO1FBSGpCLE9BQUUsR0FBRixFQUFFLENBQUs7UUFDUCxZQUFPLEdBQVAsT0FBTyxDQUFRO1FBQ2YsWUFBTyxHQUFQLE9BQU8sQ0FBUTtRQUNmLGNBQVMsR0FBVCxTQUFTLENBQVE7UUFOckIsU0FBSSxHQUFzQixFQUFFLENBQUM7UUFRbkMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQzVCLENBQUM7SUFFRCxLQUFLLENB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LENBQUMsS0FBSyxFQUFFLENBQUM7U0FDdkI7S0FDRjtTQUFNO1FBQ0wsTUFBTSxPQUFPLENBQUMsS0FBSyxFQUFFLENBQUM7S0FDdkI7SUFFRCxPQUFPLE9BQU8sQ0FBQztBQUNqQixDQUFDO0FBR0Q7Ozs7K0JBSStCO0FBQy9CLE1BQU0sQ0FBQyxLQUFLLFVBQVUsVUFBVSxDQUFDLFlBQWdDO0lBQy9ELE1BQU0sT0FBTyxHQUFXLE1BQU0sUUFBUSxDQUFDLFFBQVEsQ0FBQyxZQUFZLENBQVcsQ0FBQztJQUV4RSxPQUFPLElBQUksT0FBTyxDQUFTLEtBQUssRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7UUFDbkQsSUFBSSxDQUFDLE9BQU8sRUFBRTtZQUNaLE1BQU0sVUFBVSxDQUFDLFlBQVksQ0FBQyxDQUFDO1lBQy9CLE9BQU8sQ0FBQyxFQUFFLENBQUMsYUFBYSxFQUFFLGFBQWEsQ0FBQyxDQUFDO1lBRXpDLFNBQVMsYUFBYSxDQUFDLEdBQVEsRUFBRSxJQUFZLEVBQUUsS0FBYTtnQkFDMUQsSUFBSSxJQUFJLEtBQUssWUFBWSxFQUFFO29CQUN6QixPQUFPLENBQUMsY0FBYyxDQUFDLGFBQWEsRUFBRSxhQUFhLENBQUMsQ0FBQztvQkFDckQsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO2lCQUNoQjtnQkFDRCxHQUFHLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ2xCLENBQUM7U0FDRjthQUFNO1lBQ0wsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1NBQ2xCO0lBQ0gsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzLWV4dHJhJztcbmltcG9ydCAqIGFzIGdpdCBmcm9tICdpc29tb3JwaGljLWdpdCc7XG5cbmltcG9ydCB7IGlwY01haW4gfSBmcm9tICdlbGVjdHJvbic7XG5cbmltcG9ydCB7IG1ha2VFbmRwb2ludCB9IGZyb20gJ2FwaS9tYWluJztcbmltcG9ydCB7IFNldHRpbmcsIG1hbmFnZXIgYXMgc2V0dGluZ3MgfSBmcm9tICdzZXR0aW5ncy9tYWluJztcbmltcG9ydCB7IFdpbmRvd09wZW5lclBhcmFtcywgb3BlbldpbmRvdyB9IGZyb20gJ21haW4vd2luZG93JztcblxuaW1wb3J0IHsgR2l0QXV0aG9yLCBHaXRBdXRoZW50aWNhdGlvbiB9IGZyb20gJy4uL2dpdCc7XG5cblxuc2V0dGluZ3MuY29uZmlndXJlUGFuZSh7XG4gIGlkOiAnZGF0YVN5bmMnLFxuICBsYWJlbDogXCJEYXRhIHN5bmNocm9uaXphdGlvblwiLFxuICBpY29uOiAnZ2l0LW1lcmdlJyxcbn0pO1xuc2V0dGluZ3MucmVnaXN0ZXIobmV3IFNldHRpbmc8c3RyaW5nPihcbiAgJ2dpdFJlcG9VcmwnLFxuICBcIkdpdCByZXBvc2l0b3J5IFVSTFwiLFxuICAnZGF0YVN5bmMnLFxuKSk7XG5cblxuZXhwb3J0IGNsYXNzIEdpdENvbnRyb2xsZXIge1xuICBwcml2YXRlIGF1dGg6IEdpdEF1dGhlbnRpY2F0aW9uID0ge307XG5cbiAgY29uc3RydWN0b3IoXG4gICAgICBwcml2YXRlIGZzOiBhbnksXG4gICAgICBwcml2YXRlIHJlcG9Vcmw6IHN0cmluZyxcbiAgICAgIHByaXZhdGUgd29ya0Rpcjogc3RyaW5nLFxuICAgICAgcHJpdmF0ZSBjb3JzUHJveHk6IHN0cmluZykge1xuXG4gICAgZ2l0LnBsdWdpbnMuc2V0KCdmcycsIGZzKTtcbiAgfVxuXG4gIGFzeW5jIGdldEF1dGhvcigpOiBQcm9taXNlPEdpdEF1dGhvcj4ge1xuICAgIGNvbnN0IG5hbWUgPSBhd2FpdCBnaXQuY29uZmlnKHsgZGlyOiB0aGlzLndvcmtEaXIsIHBhdGg6ICd1c2VyLm5hbWUnIH0pO1xuICAgIGNvbnN0IGVtYWlsID0gYXdhaXQgZ2l0LmNvbmZpZyh7IGRpcjogdGhpcy53b3JrRGlyLCBwYXRoOiAndXNlci5lbWFpbCcgfSk7XG4gICAgcmV0dXJuIHsgbmFtZTogbmFtZSwgZW1haWw6IGVtYWlsIH07XG4gIH1cblxuICBhc3luYyBzZXRBdXRob3IoYXV0aG9yOiBHaXRBdXRob3IpIHtcbiAgICBhd2FpdCBnaXQuY29uZmlnKHsgZGlyOiB0aGlzLndvcmtEaXIsIHBhdGg6ICd1c2VyLm5hbWUnLCB2YWx1ZTogYXV0aG9yLm5hbWUgfSk7XG4gICAgYXdhaXQgZ2l0LmNvbmZpZyh7IGRpcjogdGhpcy53b3JrRGlyLCBwYXRoOiAndXNlci5lbWFpbCcsIHZhbHVlOiBhdXRob3IuZW1haWwgfSk7XG4gIH1cblxuICBhc3luYyBzZXRBdXRoKGF1dGg6IEdpdEF1dGhlbnRpY2F0aW9uKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIFRyeSBmZXRjaGluZyB3aXRoIGF1dGg7IHdpbGwgdGhyb3cgaWYgYXV0aCBpcyBpbnZhbGlkXG4gICAgICBnaXQuZmV0Y2goe2RpcjogdGhpcy53b3JrRGlyLCAuLi5hdXRoIH0pO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICB0aGlzLmF1dGggPSBhdXRoO1xuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgYXN5bmMgaXNJbml0aWFsaXplZCgpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBsZXQgZ2l0SW5pdGlhbGl6ZWQ6IGJvb2xlYW47XG5cbiAgICB0cnkge1xuICAgICAgZ2l0SW5pdGlhbGl6ZWQgPSAoYXdhaXQgdGhpcy5mcy5zdGF0KHBhdGguam9pbih0aGlzLndvcmtEaXIsICcuZ2l0JykpKS5pc0RpcmVjdG9yeSgpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGdpdEluaXRpYWxpemVkID0gZmFsc2U7XG4gICAgfVxuXG4gICAgcmV0dXJuIGdpdEluaXRpYWxpemVkO1xuICB9XG5cbiAgYXN5bmMgZ2V0T3JpZ2luVXJsKCk6IFByb21pc2U8c3RyaW5nIHwgbnVsbD4ge1xuICAgIHJldHVybiAoKGF3YWl0IGdpdC5saXN0UmVtb3Rlcyh7XG4gICAgICBkaXI6IHRoaXMud29ya0RpcixcbiAgICB9KSkuZmluZChyID0+IHIucmVtb3RlID09PSAnb3JpZ2luJykgfHwgeyB1cmw6IG51bGwgfSkudXJsO1xuICB9XG5cbiAgYXN5bmMgZ2V0VXBzdHJlYW1VcmwoKTogUHJvbWlzZTxzdHJpbmcgfCBudWxsPiB7XG4gICAgcmV0dXJuICgoYXdhaXQgZ2l0Lmxpc3RSZW1vdGVzKHtcbiAgICAgIGRpcjogdGhpcy53b3JrRGlyLFxuICAgIH0pKS5maW5kKHIgPT4gci5yZW1vdGUgPT09ICd1cHN0cmVhbScpIHx8IHsgdXJsOiBudWxsIH0pLnVybDtcbiAgfVxuXG4gIGFzeW5jIGFkZEFsbENoYW5nZXMoKSB7XG4gICAgYXdhaXQgZ2l0LmFkZCh7XG4gICAgICBkaXI6IHRoaXMud29ya0RpcixcbiAgICAgIGZpbGVwYXRoOiAnLicsXG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBsaXN0Q2hhbmdlZEZpbGVzKCk6IFByb21pc2U8c3RyaW5nW10+IHtcbiAgICBjb25zdCBGSUxFID0gMCwgSEVBRCA9IDEsIFdPUktESVIgPSAyO1xuXG4gICAgcmV0dXJuIChhd2FpdCBnaXQuc3RhdHVzTWF0cml4KHsgZGlyOiB0aGlzLndvcmtEaXIgfSkpXG4gICAgICAuZmlsdGVyKHJvdyA9PiByb3dbSEVBRF0gIT09IHJvd1tXT1JLRElSXSlcbiAgICAgIC5tYXAocm93ID0+IHJvd1tGSUxFXSk7XG4gIH1cblxuICBhc3luYyBwdWxsKCkge1xuICAgIGF3YWl0IGdpdC5wdWxsKHtcbiAgICAgIGRpcjogdGhpcy53b3JrRGlyLFxuICAgICAgcmVmOiAnbWFzdGVyJyxcbiAgICAgIHNpbmdsZUJyYW5jaDogdHJ1ZSxcbiAgICAgIGZhc3RGb3J3YXJkT25seTogdHJ1ZSxcbiAgICAgIC4uLnRoaXMuYXV0aCxcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGNvbW1pdChtc2c6IHN0cmluZykge1xuICAgIGF3YWl0IGdpdC5jb21taXQoe1xuICAgICAgZGlyOiB0aGlzLndvcmtEaXIsXG4gICAgICBtZXNzYWdlOiBtc2csXG4gICAgICBhdXRob3I6IHt9LFxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgcHVzaCgpIHtcbiAgICBhd2FpdCBnaXQucHVzaCh7XG4gICAgICBkaXI6IHRoaXMud29ya0RpcixcbiAgICAgIHJlbW90ZTogJ29yaWdpbicsXG4gICAgICAuLi50aGlzLmF1dGgsXG4gICAgfSk7XG4gIH1cblxuICBhc3luYyByZXNldCgpIHtcbiAgICBhd2FpdCB0aGlzLmZzLnJlbW92ZSh0aGlzLndvcmtEaXIpO1xuICAgIGF3YWl0IHRoaXMuZnMuZW5zdXJlRGlyKHRoaXMud29ya0Rpcik7XG4gICAgYXdhaXQgZ2l0LmNsb25lKHtcbiAgICAgIGRpcjogdGhpcy53b3JrRGlyLFxuICAgICAgdXJsOiB0aGlzLnJlcG9VcmwsXG4gICAgICByZWY6ICdtYXN0ZXInLFxuICAgICAgc2luZ2xlQnJhbmNoOiB0cnVlLFxuICAgICAgZGVwdGg6IDEwLFxuICAgICAgY29yc1Byb3h5OiB0aGlzLmNvcnNQcm94eSxcbiAgICAgIC4uLnRoaXMuYXV0aCxcbiAgICB9KTtcbiAgfVxuXG4gIHNldFVwQVBJRW5kcG9pbnRzKCkge1xuXG4gICAgbWFrZUVuZHBvaW50PHsgb3JpZ2luVVJMOiBzdHJpbmcgfCBudWxsLCBhdXRob3I6IEdpdEF1dGhvciB9PignZ2l0LWNvbmZpZycsIGFzeW5jICgpID0+IHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIG9yaWdpblVSTDogYXdhaXQgdGhpcy5nZXRPcmlnaW5VcmwoKSxcbiAgICAgICAgYXV0aG9yOiBhd2FpdCB0aGlzLmdldEF1dGhvcigpLFxuICAgICAgfTtcbiAgICB9KTtcblxuICAgIG1ha2VFbmRwb2ludDx7IGVycm9yczogc3RyaW5nW10gfT4oJ2ZldGNoLWNvbW1pdC1wdXNoJywgYXN5bmMgKHtcbiAgICAgICAgY29tbWl0TXNnLFxuICAgICAgICBhdXRob3JOYW1lLFxuICAgICAgICBhdXRob3JFbWFpbCxcbiAgICAgICAgZ2l0VXNlcm5hbWUsXG4gICAgICAgIGdpdFBhc3N3b3JkLFxuICAgICAgfToge1xuICAgICAgICBjb21taXRNc2c6IHN0cmluZyxcbiAgICAgICAgYXV0aG9yTmFtZTogc3RyaW5nLFxuICAgICAgICBhdXRob3JFbWFpbDogc3RyaW5nLFxuICAgICAgICBnaXRVc2VybmFtZTogc3RyaW5nLFxuICAgICAgICBnaXRQYXNzd29yZDogc3RyaW5nXG4gICAgICB9KSA9PiB7XG5cbiAgICAgIGF3YWl0IHRoaXMuc2V0QXV0aG9yKHsgbmFtZTogYXV0aG9yTmFtZSwgZW1haWw6IGF1dGhvckVtYWlsIH0pO1xuXG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB0aGlzLnNldEF1dGgoeyB1c2VybmFtZTogZ2l0VXNlcm5hbWUsIHBhc3N3b3JkOiBnaXRQYXNzd29yZCB9KTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgcmV0dXJuIHsgZXJyb3JzOiBbYEVycm9yIHdoaWxlIGF1dGhlbnRpY2F0aW5nOiAke2UudG9TdHJpbmcoKX1gXSB9O1xuICAgICAgfVxuXG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB0aGlzLnB1bGwoKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgcmV0dXJuIHsgZXJyb3JzOiBbYEVycm9yIHdoaWxlIGZldGNoaW5nIGFuZCBtZXJnaW5nIGNoYW5nZXM6ICR7ZS50b1N0cmluZygpfWBdIH07XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGNoYW5nZWRGaWxlcyA9IGF3YWl0IHRoaXMubGlzdENoYW5nZWRGaWxlcygpO1xuICAgICAgaWYgKGNoYW5nZWRGaWxlcy5sZW5ndGggPCAxKSB7XG4gICAgICAgIHJldHVybiB7IGVycm9yczogW1wiTm8gY2hhbmdlcyB0byBzdWJtaXQhXCJdIH07XG4gICAgICB9XG5cbiAgICAgIGF3YWl0IHRoaXMuYWRkQWxsQ2hhbmdlcygpO1xuICAgICAgYXdhaXQgdGhpcy5jb21taXQoY29tbWl0TXNnKTtcblxuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgdGhpcy5wdXNoKCk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIHJldHVybiB7IGVycm9yczogW2BFcnJvciB3aGlsZSBwdXNoaW5nIGNoYW5nZXM6ICR7ZS50b1N0cmluZygpfWBdIH07XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB7IGVycm9yczogW10gfTtcbiAgICB9KTtcblxuICB9XG59XG5cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGluaXRSZXBvKFxuICAgIHdvcmtEaXI6IHN0cmluZyxcbiAgICByZXBvVXJsOiBzdHJpbmcsXG4gICAgY29yc1Byb3h5VXJsOiBzdHJpbmcpOiBQcm9taXNlPEdpdENvbnRyb2xsZXI+IHtcblxuICBjb25zdCBnaXRDdHJsID0gbmV3IEdpdENvbnRyb2xsZXIoZnMsIHJlcG9VcmwsIHdvcmtEaXIsIGNvcnNQcm94eVVybCk7XG5cbiAgaWYgKChhd2FpdCBnaXRDdHJsLmlzSW5pdGlhbGl6ZWQoKSkgPT09IHRydWUpIHtcbiAgICBjb25zdCByZW1vdGVVcmwgPSBhd2FpdCBnaXRDdHJsLmdldE9yaWdpblVybCgpO1xuICAgIGlmIChyZW1vdGVVcmwgIT09IG51bGwgJiYgcmVtb3RlVXJsLnRyaW0oKSA9PT0gcmVwb1VybC50cmltKCkpIHtcbiAgICAgIGF3YWl0IGdpdEN0cmwucHVsbCgpO1xuICAgIH0gZWxzZSB7XG4gICAgICBhd2FpdCBnaXRDdHJsLnJlc2V0KCk7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIGF3YWl0IGdpdEN0cmwucmVzZXQoKTtcbiAgfVxuXG4gIHJldHVybiBnaXRDdHJsO1xufVxuXG5cbi8qIFByb21pc2VzIHRvIHJldHVybiBhIHN0cmluZyBjb250YWluaW5nIGNvbmZpZ3VyZWQgcmVwb3NpdG9yeSBVUkwuXG4gICBJZiByZXBvc2l0b3J5IFVSTCBpcyBub3QgY29uZmlndXJlZCAoZS5nLiwgb24gZmlyc3QgcnVuLCBvciBhZnRlciByZXNldClcbiAgIG9wZW5zIGEgd2luZG93IHdpdGggc3BlY2lmaWVkIG9wdGlvbnMuXG4gICBUaGUgd2luZG93IGlzIGV4cGVjdGVkIHRvIGFzayB0aGUgdXNlciB0byBzcGVjaWZ5IHRoZSBVUkwgYW5kIHNlbmQgYSBgJ3NldC1zZXR0aW5nJ2BcbiAgIGV2ZW50IGZvciBgJ2dpdFJlcG9VcmwnYC4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBzZXRSZXBvVXJsKGNvbmZpZ1dpbmRvdzogV2luZG93T3BlbmVyUGFyYW1zKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgY29uc3QgcmVwb1VybDogc3RyaW5nID0gYXdhaXQgc2V0dGluZ3MuZ2V0VmFsdWUoJ2dpdFJlcG9VcmwnKSBhcyBzdHJpbmc7XG5cbiAgcmV0dXJuIG5ldyBQcm9taXNlPHN0cmluZz4oYXN5bmMgKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIGlmICghcmVwb1VybCkge1xuICAgICAgYXdhaXQgb3BlbldpbmRvdyhjb25maWdXaW5kb3cpO1xuICAgICAgaXBjTWFpbi5vbignc2V0LXNldHRpbmcnLCBoYW5kbGVTZXR0aW5nKTtcblxuICAgICAgZnVuY3Rpb24gaGFuZGxlU2V0dGluZyhldnQ6IGFueSwgbmFtZTogc3RyaW5nLCB2YWx1ZTogc3RyaW5nKSB7XG4gICAgICAgIGlmIChuYW1lID09PSAnZ2l0UmVwb1VybCcpIHtcbiAgICAgICAgICBpcGNNYWluLnJlbW92ZUxpc3RlbmVyKCdzZXQtc2V0dGluZycsIGhhbmRsZVNldHRpbmcpO1xuICAgICAgICAgIHJlc29sdmUodmFsdWUpO1xuICAgICAgICB9XG4gICAgICAgIGV2dC5yZXBseSgnb2snKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgcmVzb2x2ZShyZXBvVXJsKTtcbiAgICB9XG4gIH0pO1xufVxuIl19