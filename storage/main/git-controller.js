import * as path from 'path';
import * as fs from 'fs-extra';
import * as git from 'isomorphic-git';
import * as log from 'electron-log';
import { ipcMain } from 'electron';
import { makeEndpoint } from '../../api/main';
import { Setting } from '../../settings/main';
import { openWindow } from '../../main/window';
export class GitController {
    constructor(fs, repoUrl, workDir, corsProxy) {
        this.fs = fs;
        this.repoUrl = repoUrl;
        this.workDir = workDir;
        this.corsProxy = corsProxy;
        this.auth = {};
        git.plugins.set('fs', fs);
    }
    async getAuthor() {
        const name = await git.config({ dir: this.workDir, path: 'user.name' });
        const email = await git.config({ dir: this.workDir, path: 'user.email' });
        return { name: name, email: email };
    }
    async setAuthor(author) {
        log.verbose("SSE: GitController: Set author");
        await git.config({ dir: this.workDir, path: 'user.name', value: author.name });
        await git.config({ dir: this.workDir, path: 'user.email', value: author.email });
    }
    async setAuth(auth) {
        // DANGER: never log `auth` value here!
        log.verbose("SSE: GitController: Set auth");
        try {
            // Try fetching with auth; will throw if auth is invalid
            git.fetch(Object.assign({ dir: this.workDir }, auth));
        }
        catch (e) {
            return false;
        }
        this.auth = auth;
        return true;
    }
    async isInitialized() {
        let gitInitialized;
        try {
            gitInitialized = (await this.fs.stat(path.join(this.workDir, '.git'))).isDirectory();
        }
        catch (e) {
            gitInitialized = false;
        }
        return gitInitialized;
    }
    async getOriginUrl() {
        return ((await git.listRemotes({
            dir: this.workDir,
        })).find(r => r.remote === 'origin') || { url: null }).url;
    }
    async getUpstreamUrl() {
        return ((await git.listRemotes({
            dir: this.workDir,
        })).find(r => r.remote === 'upstream') || { url: null }).url;
    }
    async addAllChanges() {
        log.verbose("SSE: GitController: Adding all changes");
        await git.add({
            dir: this.workDir,
            filepath: '.',
        });
    }
    async listChangedFiles() {
        const FILE = 0, HEAD = 1, WORKDIR = 2;
        return (await git.statusMatrix({ dir: this.workDir }))
            .filter(row => row[HEAD] !== row[WORKDIR])
            .map(row => row[FILE]);
    }
    async pull() {
        log.verbose("SSE: GitController: Pulling with auto fast-forward merge");
        await git.pull(Object.assign({ dir: this.workDir, ref: 'master', singleBranch: true, fastForwardOnly: true }, this.auth));
    }
    async commit(msg) {
        log.verbose("SSE: GitController: Committing");
        await git.commit({
            dir: this.workDir,
            message: msg,
            author: {},
        });
    }
    async push() {
        log.verbose("SSE: GitController: Pushing");
        await git.push(Object.assign({ dir: this.workDir, remote: 'origin' }, this.auth));
    }
    async reset() {
        log.verbose("SSE: GitController: Resetting");
        log.silly("SSE: GitController: Reset: Removing data directory");
        await this.fs.remove(this.workDir);
        log.silly("SSE: GitController: Reset: Ensuring data directory exists");
        await this.fs.ensureDir(this.workDir);
        log.silly("SSE: GitController: Reset: Cloning");
        await git.clone(Object.assign({ dir: this.workDir, url: this.repoUrl, ref: 'master', singleBranch: true, depth: 10, corsProxy: this.corsProxy }, this.auth));
    }
    setUpAPIEndpoints() {
        log.verbose("SSE: GitController: Setting up API endpoints");
        makeEndpoint('git-config', async () => {
            log.verbose("SSE: GitController: received git-config request");
            return {
                originURL: await this.getOriginUrl(),
                author: await this.getAuthor(),
            };
        });
        makeEndpoint('list-local-changes', async () => {
            log.verbose("SSE: GitController: received list-local-changes request");
            return { filenames: await this.listChangedFiles() };
        });
        makeEndpoint('fetch-commit-push', async ({ commitMsg, authorName, authorEmail, gitUsername, gitPassword, }) => {
            // DANGER: Never log gitUsername & gitPassword values
            log.verbose("SSE: GitController: received fetch-commit-push request");
            const changedFiles = await this.listChangedFiles();
            if (changedFiles.length < 1) {
                return { errors: ["No changes to submit!"] };
            }
            await this.setAuthor({ name: authorName, email: authorEmail });
            try {
                await this.setAuth({ username: gitUsername, password: gitPassword });
            }
            catch (e) {
                return { errors: [`Error while authenticating: ${e.toString()}`] };
            }
            await this.addAllChanges();
            await this.commit(commitMsg);
            try {
                await this.pull();
            }
            catch (e) {
                log.warn("SSE: GitController: Failed to pull & merge changes!");
                return { errors: [`Error while fetching and merging changes: ${e.toString()}`] };
            }
            try {
                await this.push();
            }
            catch (e) {
                log.warn("SSE: GitController: Failed to push changes!");
                return { errors: [`Error while pushing changes: ${e.toString()}`] };
            }
            return { errors: [] };
        });
    }
}
export async function initRepo(workDir, repoUrl, corsProxyUrl, forceReset) {
    const gitCtrl = new GitController(fs, repoUrl, workDir, corsProxyUrl);
    if ((await gitCtrl.isInitialized()) === true && forceReset === false) {
        log.verbose("SSE: GitController: Already initialized");
        const remoteUrl = await gitCtrl.getOriginUrl();
        if (remoteUrl !== null && remoteUrl.trim() === repoUrl.trim()) {
            log.verbose("SSE: GitController: Current remote URL matches configured repo URL");
            const changedFiles = await gitCtrl.listChangedFiles();
            if (changedFiles.length < 1) {
                log.verbose("SSE: GitController: There are no local changes, let’s pull");
                await gitCtrl.pull();
            }
            else {
                log.verbose("SSE: GitController: There are some local changes, not pulling");
            }
        }
        else {
            log.warn("SSE: GitController: Current remote URL does NOT match configured repo URL");
            log.warn("SSE: GitController: Resetting");
            await gitCtrl.reset();
        }
    }
    else {
        log.warn("SSE: GitController: Resetting");
        log.debug(`SSE: GitController: forceReset is ${forceReset}`);
        await gitCtrl.reset();
    }
    return gitCtrl;
}
/* Promises to return an object containing string with repository URL
   and a flag indicating whether it’s been reset
   (which if true would cause `initRepo()` to reinitialize the repository).

   If repository URL is not configured (e.g., on first run, or after reset)
   opens a window with specified options to ask the user to provide the setting.
   The window is expected to ask the user to specify the URL and send a `'set-setting'`
   event for `'gitRepoUrl'`. */
export async function setRepoUrl(configWindow, settings) {
    settings.configurePane({
        id: 'dataSync',
        label: "Data synchronization",
        icon: 'git-merge',
    });
    settings.register(new Setting('gitRepoUrl', "Git repository URL", 'dataSync'));
    const repoUrl = await settings.getValue('gitRepoUrl');
    if (repoUrl) {
        log.warn("SSE: GitController: Repo URL found in settings, skip config window");
        return Promise.resolve({ url: repoUrl, hasChanged: false });
    }
    else {
        return new Promise(async (resolve, reject) => {
            log.warn("SSE: GitController: Repo URL not set, open initial config window to let user configure");
            await openWindow(configWindow);
            ipcMain.on('set-setting', handleSetting);
            function handleSetting(evt, name, value) {
                if (name === 'gitRepoUrl') {
                    log.warn("SSE: GitController: received gitRepoUrl setting");
                    ipcMain.removeListener('set-setting', handleSetting);
                    resolve({ url: value, hasChanged: true });
                }
                evt.reply('ok');
            }
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2l0LWNvbnRyb2xsZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvc3RvcmFnZS9tYWluL2dpdC1jb250cm9sbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sS0FBSyxJQUFJLE1BQU0sTUFBTSxDQUFDO0FBQzdCLE9BQU8sS0FBSyxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBQy9CLE9BQU8sS0FBSyxHQUFHLE1BQU0sZ0JBQWdCLENBQUM7QUFDdEMsT0FBTyxLQUFLLEdBQUcsTUFBTSxjQUFjLENBQUM7QUFFcEMsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUVuQyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDOUMsT0FBTyxFQUFFLE9BQU8sRUFBa0IsTUFBTSxxQkFBcUIsQ0FBQztBQUM5RCxPQUFPLEVBQXNCLFVBQVUsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBS25FLE1BQU0sT0FBTyxhQUFhO0lBR3hCLFlBQ1ksRUFBTyxFQUNQLE9BQWUsRUFDZixPQUFlLEVBQ2YsU0FBaUI7UUFIakIsT0FBRSxHQUFGLEVBQUUsQ0FBSztRQUNQLFlBQU8sR0FBUCxPQUFPLENBQVE7UUFDZixZQUFPLEdBQVAsT0FBTyxDQUFRO1FBQ2YsY0FBUyxHQUFULFNBQVMsQ0FBUTtRQU5yQixTQUFJLEdBQXNCLEVBQUUsQ0FBQztRQVFuQyxHQUFHLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDNUIsQ0FBQztJQUVELEtBQUssQ0FBQyxTQUFTO1FBQ2IsTUFBTSxJQUFJLEdBQUcsTUFBTSxHQUFHLENBQUMsTUFBTSxDQUFDLEVBQUUsR0FBRyxFQUFFLElBQUksQ0FBQyxPQUFPLEVBQUUsSUFBSSxFQUFFLFdBQVcsRUFBRSxDQUFDLENBQUM7UUFDeEUsTUFBTSxLQUFLLEdBQUcsTUFBTSxHQUFHLENBQUMsTUFBTSxDQUFDLEVB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QUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtZQUNqRixHQUFHLENBQUMsSUFBSSxDQUFDLHdGQUF3RixDQUFDLENBQUM7WUFFbkcsTUFBTSxVQUFVLENBQUMsWUFBWSxDQUFDLENBQUM7WUFDL0IsT0FBTyxDQUFDLEVBQUUsQ0FBQyxhQUFhLEVBQUUsYUFBYSxDQUFDLENBQUM7WUFFekMsU0FBUyxhQUFhLENBQUMsR0FBUSxFQUFFLElBQVksRUFBRSxLQUFhO2dCQUMxRCxJQUFJLElBQUksS0FBSyxZQUFZLEVBQUU7b0JBQ3pCLEdBQUcsQ0FBQyxJQUFJLENBQUMsaURBQWlELENBQUMsQ0FBQztvQkFDNUQsT0FBTyxDQUFDLGNBQWMsQ0FBQyxhQUFhLEVBQUUsYUFBYSxDQUFDLENBQUM7b0JBQ3JELE9BQU8sQ0FBQyxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsVUFBVSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7aUJBQzNDO2dCQUNELEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDbEIsQ0FBQztRQUNILENBQUMsQ0FBQyxDQUFDO0tBQ0o7QUFDSCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzLWV4dHJhJztcbmltcG9ydCAqIGFzIGdpdCBmcm9tICdpc29tb3JwaGljLWdpdCc7XG5pbXBvcnQgKiBhcyBsb2cgZnJvbSAnZWxlY3Ryb24tbG9nJztcblxuaW1wb3J0IHsgaXBjTWFpbiB9IGZyb20gJ2VsZWN0cm9uJztcblxuaW1wb3J0IHsgbWFrZUVuZHBvaW50IH0gZnJvbSAnLi4vLi4vYXBpL21haW4nO1xuaW1wb3J0IHsgU2V0dGluZywgU2V0dGluZ01hbmFnZXIgfSBmcm9tICcuLi8uLi9zZXR0aW5ncy9tYWluJztcbmltcG9ydCB7IFdpbmRvd09wZW5lclBhcmFtcywgb3BlbldpbmRvdyB9IGZyb20gJy4uLy4uL21haW4vd2luZG93JztcblxuaW1wb3J0IHsgR2l0QXV0aG9yLCBHaXRBdXRoZW50aWNhdGlvbiB9IGZyb20gJy4uL2dpdCc7XG5cblxuZXhwb3J0IGNsYXNzIEdpdENvbnRyb2xsZXIge1xuICBwcml2YXRlIGF1dGg6IEdpdEF1dGhlbnRpY2F0aW9uID0ge307XG5cbiAgY29uc3RydWN0b3IoXG4gICAgICBwcml2YXRlIGZzOiBhbnksXG4gICAgICBwcml2YXRlIHJlcG9Vcmw6IHN0cmluZyxcbiAgICAgIHByaXZhdGUgd29ya0Rpcjogc3RyaW5nLFxuICAgICAgcHJpdmF0ZSBjb3JzUHJveHk6IHN0cmluZykge1xuXG4gICAgZ2l0LnBsdWdpbnMuc2V0KCdmcycsIGZzKTtcbiAgfVxuXG4gIGFzeW5jIGdldEF1dGhvcigpOiBQcm9taXNlPEdpdEF1dGhvcj4ge1xuICAgIGNvbnN0IG5hbWUgPSBhd2FpdCBnaXQuY29uZmlnKHsgZGlyOiB0aGlzLndvcmtEaXIsIHBhdGg6ICd1c2VyLm5hbWUnIH0pO1xuICAgIGNvbnN0IGVtYWlsID0gYXdhaXQgZ2l0LmNvbmZpZyh7IGRpcjogdGhpcy53b3JrRGlyLCBwYXRoOiAndXNlci5lbWFpbCcgfSk7XG4gICAgcmV0dXJuIHsgbmFtZTogbmFtZSwgZW1haWw6IGVtYWlsIH07XG4gIH1cblxuICBhc3luYyBzZXRBdXRob3IoYXV0aG9yOiBHaXRBdXRob3IpIHtcbiAgICBsb2cudmVyYm9zZShcIlNTRTogR2l0Q29udHJvbGxlcjogU2V0IGF1dGhvclwiKTtcbiAgICBhd2FpdCBnaXQuY29uZmlnKHsgZGlyOiB0aGlzLndvcmtEaXIsIHBhdGg6ICd1c2VyLm5hbWUnLCB2YWx1ZTogYXV0aG9yLm5hbWUgfSk7XG4gICAgYXdhaXQgZ2l0LmNvbmZpZyh7IGRpcjogdGhpcy53b3JrRGlyLCBwYXRoOiAndXNlci5lbWFpbCcsIHZhbHVlOiBhdXRob3IuZW1haWwgfSk7XG4gIH1cblxuICBhc3luYyBzZXRBdXRoKGF1dGg6IEdpdEF1dGhlbnRpY2F0aW9uKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgLy8gREFOR0VSOiBuZXZlciBsb2cgYGF1dGhgIHZhbHVlIGhlcmUhXG4gICAgbG9nLnZlcmJvc2UoXCJTU0U6IEdpdENvbnRyb2xsZXI6IFNldCBhdXRoXCIpO1xuICAgIHRyeSB7XG4gICAgICAvLyBUcnkgZmV0Y2hpbmcgd2l0aCBhdXRoOyB3aWxsIHRocm93IGlmIGF1dGggaXMgaW52YWxpZFxuICAgICAgZ2l0LmZldGNoKHtkaXI6IHRoaXMud29ya0RpciwgLi4uYXV0aCB9KTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgdGhpcy5hdXRoID0gYXV0aDtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIGFzeW5jIGlzSW5pdGlhbGl6ZWQoKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgbGV0IGdpdEluaXRpYWxpemVkOiBib29sZWFuO1xuXG4gICAgdHJ5IHtcbiAgICAgIGdpdEluaXRpYWxpemVkID0gKGF3YWl0IHRoaXMuZnMuc3RhdChwYXRoLmpvaW4odGhpcy53b3JrRGlyLCAnLmdpdCcpKSkuaXNEaXJlY3RvcnkoKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBnaXRJbml0aWFsaXplZCA9IGZhbHNlO1xuICAgIH1cblxuICAgIHJldHVybiBnaXRJbml0aWFsaXplZDtcbiAgfVxuXG4gIGFzeW5jIGdldE9yaWdpblVybCgpOiBQcm9taXNlPHN0cmluZyB8IG51bGw+IHtcbiAgICByZXR1cm4gKChhd2FpdCBnaXQubGlzdFJlbW90ZXMoe1xuICAgICAgZGlyOiB0aGlzLndvcmtEaXIsXG4gICAgfSkpLmZpbmQociA9PiByLnJlbW90ZSA9PT0gJ29yaWdpbicpIHx8IHsgdXJsOiBudWxsIH0pLnVybDtcbiAgfVxuXG4gIGFzeW5jIGdldFVwc3RyZWFtVXJsKCk6IFByb21pc2U8c3RyaW5nIHwgbnVsbD4ge1xuICAgIHJldHVybiAoKGF3YWl0IGdpdC5saXN0UmVtb3Rlcyh7XG4gICAgICBkaXI6IHRoaXMud29ya0RpcixcbiAgICB9KSkuZmluZChyID0+IHIucmVtb3RlID09PSAndXBzdHJlYW0nKSB8fCB7IHVybDogbnVsbCB9KS51cmw7XG4gIH1cblxuICBhc3luYyBhZGRBbGxDaGFuZ2VzKCkge1xuICAgIGxvZy52ZXJib3NlKFwiU1NFOiBHaXRDb250cm9sbGVyOiBBZGRpbmcgYWxsIGNoYW5nZXNcIik7XG4gICAgYXdhaXQgZ2l0LmFkZCh7XG4gICAgICBkaXI6IHRoaXMud29ya0RpcixcbiAgICAgIGZpbGVwYXRoOiAnLicsXG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBsaXN0Q2hhbmdlZEZpbGVzKCk6IFByb21pc2U8c3RyaW5nW10+IHtcbiAgICBjb25zdCBGSUxFID0gMCwgSEVBRCA9IDEsIFdPUktESVIgPSAyO1xuXG4gICAgcmV0dXJuIChhd2FpdCBnaXQuc3RhdHVzTWF0cml4KHsgZGlyOiB0aGlzLndvcmtEaXIgfSkpXG4gICAgICAuZmlsdGVyKHJvdyA9PiByb3dbSEVBRF0gIT09IHJvd1tXT1JLRElSXSlcbiAgICAgIC5tYXAocm93ID0+IHJvd1tGSUxFXSk7XG4gIH1cblxuICBhc3luYyBwdWxsKCkge1xuICAgIGxvZy52ZXJib3NlKFwiU1NFOiBHaXRDb250cm9sbGVyOiBQdWxsaW5nIHdpdGggYXV0byBmYXN0LWZvcndhcmQgbWVyZ2VcIik7XG4gICAgYXdhaXQgZ2l0LnB1bGwoe1xuICAgICAgZGlyOiB0aGlzLndvcmtEaXIsXG4gICAgICByZWY6ICdtYXN0ZXInLFxuICAgICAgc2luZ2xlQnJhbmNoOiB0cnVlLFxuICAgICAgZmFzdEZvcndhcmRPbmx5OiB0cnVlLFxuICAgICAgLi4udGhpcy5hdXRoLFxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgY29tbWl0KG1zZzogc3RyaW5nKSB7XG4gICAgbG9nLnZlcmJvc2UoXCJTU0U6IEdpdENvbnRyb2xsZXI6IENvbW1pdHRpbmdcIik7XG4gICAgYXdhaXQgZ2l0LmNvbW1pdCh7XG4gICAgICBkaXI6IHRoaXMud29ya0RpcixcbiAgICAgIG1lc3NhZ2U6IG1zZyxcbiAgICAgIGF1dGhvcjoge30sXG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBwdXNoKCkge1xuICAgIGxvZy52ZXJib3NlKFwiU1NFOiBHaXRDb250cm9sbGVyOiBQdXNoaW5nXCIpO1xuICAgIGF3YWl0IGdpdC5wdXNoKHtcbiAgICAgIGRpcjogdGhpcy53b3JrRGlyLFxuICAgICAgcmVtb3RlOiAnb3JpZ2luJyxcbiAgICAgIC4uLnRoaXMuYXV0aCxcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIHJlc2V0KCkge1xuICAgIGxvZy52ZXJib3NlKFwiU1NFOiBHaXRDb250cm9sbGVyOiBSZXNldHRpbmdcIik7XG4gICAgbG9nLnNpbGx5KFwiU1NFOiBHaXRDb250cm9sbGVyOiBSZXNldDogUmVtb3ZpbmcgZGF0YSBkaXJlY3RvcnlcIik7XG5cbiAgICBhd2FpdCB0aGlzLmZzLnJlbW92ZSh0aGlzLndvcmtEaXIpO1xuXG4gICAgbG9nLnNpbGx5KFwiU1NFOiBHaXRDb250cm9sbGVyOiBSZXNldDogRW5zdXJpbmcgZGF0YSBkaXJlY3RvcnkgZXhpc3RzXCIpO1xuXG4gICAgYXdhaXQgdGhpcy5mcy5lbnN1cmVEaXIodGhpcy53b3JrRGlyKTtcblxuICAgIGxvZy5zaWxseShcIlNTRTogR2l0Q29udHJvbGxlcjogUmVzZXQ6IENsb25pbmdcIik7XG5cbiAgICBhd2FpdCBnaXQuY2xvbmUoe1xuICAgICAgZGlyOiB0aGlzLndvcmtEaXIsXG4gICAgICB1cmw6IHRoaXMucmVwb1VybCxcbiAgICAgIHJlZjogJ21hc3RlcicsXG4gICAgICBzaW5nbGVCcmFuY2g6IHRydWUsXG4gICAgICBkZXB0aDogMTAsXG4gICAgICBjb3JzUHJveHk6IHRoaXMuY29yc1Byb3h5LFxuICAgICAgLi4udGhpcy5hdXRoLFxuICAgIH0pO1xuICB9XG5cbiAgc2V0VXBBUElFbmRwb2ludHMoKSB7XG4gICAgbG9nLnZlcmJvc2UoXCJTU0U6IEdpdENvbnRyb2xsZXI6IFNldHRpbmcgdXAgQVBJIGVuZHBvaW50c1wiKTtcblxuICAgIG1ha2VFbmRwb2ludDx7IG9yaWdpblVSTDogc3RyaW5nIHwgbnVsbCwgYXV0aG9yOiBHaXRBdXRob3IgfT4oJ2dpdC1jb25maWcnLCBhc3luYyAoKSA9PiB7XG4gICAgICBsb2cudmVyYm9zZShcIlNTRTogR2l0Q29udHJvbGxlcjogcmVjZWl2ZWQgZ2l0LWNvbmZpZyByZXF1ZXN0XCIpO1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgb3JpZ2luVVJMOiBhd2FpdCB0aGlzLmdldE9yaWdpblVybCgpLFxuICAgICAgICBhdXRob3I6IGF3YWl0IHRoaXMuZ2V0QXV0aG9yKCksXG4gICAgICB9O1xuICAgIH0pO1xuXG4gICAgbWFrZUVuZHBvaW50PHsgZmlsZW5hbWVzOiBzdHJpbmdbXSB9PignbGlzdC1sb2NhbC1jaGFuZ2VzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgbG9nLnZlcmJvc2UoXCJTU0U6IEdpdENvbnRyb2xsZXI6IHJlY2VpdmVkIGxpc3QtbG9jYWwtY2hhbmdlcyByZXF1ZXN0XCIpO1xuICAgICAgcmV0dXJuIHsgZmlsZW5hbWVzOiBhd2FpdCB0aGlzLmxpc3RDaGFuZ2VkRmlsZXMoKSB9O1xuICAgIH0pO1xuXG4gICAgbWFrZUVuZHBvaW50PHsgZXJyb3JzOiBzdHJpbmdbXSB9PignZmV0Y2gtY29tbWl0LXB1c2gnLCBhc3luYyAoe1xuICAgICAgICBjb21taXRNc2csXG4gICAgICAgIGF1dGhvck5hbWUsXG4gICAgICAgIGF1dGhvckVtYWlsLFxuICAgICAgICBnaXRVc2VybmFtZSxcbiAgICAgICAgZ2l0UGFzc3dvcmQsXG4gICAgICB9OiB7XG4gICAgICAgIGNvbW1pdE1zZzogc3RyaW5nLFxuICAgICAgICBhdXRob3JOYW1lOiBzdHJpbmcsXG4gICAgICAgIGF1dGhvckVtYWlsOiBzdHJpbmcsXG4gICAgICAgIGdpdFVzZXJuYW1lOiBzdHJpbmcsXG4gICAgICAgIGdpdFBhc3N3b3JkOiBzdHJpbmdcbiAgICAgIH0pID0+IHtcblxuICAgICAgLy8gREFOR0VSOiBOZXZlciBsb2cgZ2l0VXNlcm5hbWUgJiBnaXRQYXNzd29yZCB2YWx1ZXNcblxuICAgICAgbG9nLnZlcmJvc2UoXCJTU0U6IEdpdENvbnRyb2xsZXI6IHJlY2VpdmVkIGZldGNoLWNvbW1pdC1wdXNoIHJlcXVlc3RcIik7XG5cbiAgICAgIGNvbnN0IGNoYW5nZWRGaWxlcyA9IGF3YWl0IHRoaXMubGlzdENoYW5nZWRGaWxlcygpO1xuICAgICAgaWYgKGNoYW5nZWRGaWxlcy5sZW5ndGggPCAxKSB7XG4gICAgICAgIHJldHVybiB7IGVycm9yczogW1wiTm8gY2hhbmdlcyB0byBzdWJtaXQhXCJdIH07XG4gICAgICB9XG5cbiAgICAgIGF3YWl0IHRoaXMuc2V0QXV0aG9yKHsgbmFtZTogYXV0aG9yTmFtZSwgZW1haWw6IGF1dGhvckVtYWlsIH0pO1xuXG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB0aGlzLnNldEF1dGgoeyB1c2VybmFtZTogZ2l0VXNlcm5hbWUsIHBhc3N3b3JkOiBnaXRQYXNzd29yZCB9KTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgcmV0dXJuIHsgZXJyb3JzOiBbYEVycm9yIHdoaWxlIGF1dGhlbnRpY2F0aW5nOiAke2UudG9TdHJpbmcoKX1gXSB9O1xuICAgICAgfVxuXG4gICAgICBhd2FpdCB0aGlzLmFkZEFsbENoYW5nZXMoKTtcbiAgICAgIGF3YWl0IHRoaXMuY29tbWl0KGNvbW1pdE1zZyk7XG5cbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHRoaXMucHVsbCgpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBsb2cud2FybihcIlNTRTogR2l0Q29udHJvbGxlcjogRmFpbGVkIHRvIHB1bGwgJiBtZXJnZSBjaGFuZ2VzIVwiKTtcbiAgICAgICAgcmV0dXJuIHsgZXJyb3JzOiBbYEVycm9yIHdoaWxlIGZldGNoaW5nIGFuZCBtZXJnaW5nIGNoYW5nZXM6ICR7ZS50b1N0cmluZygpfWBdIH07XG4gICAgICB9XG5cbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHRoaXMucHVzaCgpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBsb2cud2FybihcIlNTRTogR2l0Q29udHJvbGxlcjogRmFpbGVkIHRvIHB1c2ggY2hhbmdlcyFcIik7XG4gICAgICAgIHJldHVybiB7IGVycm9yczogW2BFcnJvciB3aGlsZSBwdXNoaW5nIGNoYW5nZXM6ICR7ZS50b1N0cmluZygpfWBdIH07XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB7IGVycm9yczogW10gfTtcbiAgICB9KTtcblxuICB9XG59XG5cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGluaXRSZXBvKFxuICAgIHdvcmtEaXI6IHN0cmluZyxcbiAgICByZXBvVXJsOiBzdHJpbmcsXG4gICAgY29yc1Byb3h5VXJsOiBzdHJpbmcsXG4gICAgZm9yY2VSZXNldDogYm9vbGVhbik6IFByb21pc2U8R2l0Q29udHJvbGxlcj4ge1xuXG4gIGNvbnN0IGdpdEN0cmwgPSBuZXcgR2l0Q29udHJvbGxlcihmcywgcmVwb1VybCwgd29ya0RpciwgY29yc1Byb3h5VXJsKTtcblxuICBpZiAoKGF3YWl0IGdpdEN0cmwuaXNJbml0aWFsaXplZCgpKSA9PT0gdHJ1ZSAmJiBmb3JjZVJlc2V0ID09PSBmYWxzZSkge1xuICAgIGxvZy52ZXJib3NlKFwiU1NFOiBHaXRDb250cm9sbGVyOiBBbHJlYWR5IGluaXRpYWxpemVkXCIpO1xuXG4gICAgY29uc3QgcmVtb3RlVXJsID0gYXdhaXQgZ2l0Q3RybC5nZXRPcmlnaW5VcmwoKTtcbiAgICBpZiAocmVtb3RlVXJsICE9PSBudWxsICYmIHJlbW90ZVVybC50cmltKCkgPT09IHJlcG9VcmwudHJpbSgpKSB7XG4gICAgICBsb2cudmVyYm9zZShcIlNTRTogR2l0Q29udHJvbGxlcjogQ3VycmVudCByZW1vdGUgVVJMIG1hdGNoZXMgY29uZmlndXJlZCByZXBvIFVSTFwiKTtcbiAgICAgIGNvbnN0IGNoYW5nZWRGaWxlcyA9IGF3YWl0IGdpdEN0cmwubGlzdENoYW5nZWRGaWxlcygpO1xuICAgICAgaWYgKGNoYW5nZWRGaWxlcy5sZW5ndGggPCAxKSB7XG4gICAgICAgIGxvZy52ZXJib3NlKFwiU1NFOiBHaXRDb250cm9sbGVyOiBUaGVyZSBhcmUgbm8gbG9jYWwgY2hhbmdlcywgbGV04oCZcyBwdWxsXCIpO1xuICAgICAgICBhd2FpdCBnaXRDdHJsLnB1bGwoKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxvZy52ZXJib3NlKFwiU1NFOiBHaXRDb250cm9sbGVyOiBUaGVyZSBhcmUgc29tZSBsb2NhbCBjaGFuZ2VzLCBub3QgcHVsbGluZ1wiKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgbG9nLndhcm4oXCJTU0U6IEdpdENvbnRyb2xsZXI6IEN1cnJlbnQgcmVtb3RlIFVSTCBkb2VzIE5PVCBtYXRjaCBjb25maWd1cmVkIHJlcG8gVVJMXCIpO1xuICAgICAgbG9nLndhcm4oXCJTU0U6IEdpdENvbnRyb2xsZXI6IFJlc2V0dGluZ1wiKTtcbiAgICAgIGF3YWl0IGdpdEN0cmwucmVzZXQoKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgbG9nLndhcm4oXCJTU0U6IEdpdENvbnRyb2xsZXI6IFJlc2V0dGluZ1wiKTtcbiAgICBsb2cuZGVidWcoYFNTRTogR2l0Q29udHJvbGxlcjogZm9yY2VSZXNldCBpcyAke2ZvcmNlUmVzZXR9YCk7XG4gICAgYXdhaXQgZ2l0Q3RybC5yZXNldCgpO1xuICB9XG5cbiAgcmV0dXJuIGdpdEN0cmw7XG59XG5cblxuLyogUHJvbWlzZXMgdG8gcmV0dXJuIGFuIG9iamVjdCBjb250YWluaW5nIHN0cmluZyB3aXRoIHJlcG9zaXRvcnkgVVJMXG4gICBhbmQgYSBmbGFnIGluZGljYXRpbmcgd2hldGhlciBpdOKAmXMgYmVlbiByZXNldFxuICAgKHdoaWNoIGlmIHRydWUgd291bGQgY2F1c2UgYGluaXRSZXBvKClgIHRvIHJlaW5pdGlhbGl6ZSB0aGUgcmVwb3NpdG9yeSkuXG5cbiAgIElmIHJlcG9zaXRvcnkgVVJMIGlzIG5vdCBjb25maWd1cmVkIChlLmcuLCBvbiBmaXJzdCBydW4sIG9yIGFmdGVyIHJlc2V0KVxuICAgb3BlbnMgYSB3aW5kb3cgd2l0aCBzcGVjaWZpZWQgb3B0aW9ucyB0byBhc2sgdGhlIHVzZXIgdG8gcHJvdmlkZSB0aGUgc2V0dGluZy5cbiAgIFRoZSB3aW5kb3cgaXMgZXhwZWN0ZWQgdG8gYXNrIHRoZSB1c2VyIHRvIHNwZWNpZnkgdGhlIFVSTCBhbmQgc2VuZCBhIGAnc2V0LXNldHRpbmcnYFxuICAgZXZlbnQgZm9yIGAnZ2l0UmVwb1VybCdgLiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHNldFJlcG9VcmwoXG4gICAgY29uZmlnV2luZG93OiBXaW5kb3dPcGVuZXJQYXJhbXMsXG4gICAgc2V0dGluZ3M6IFNldHRpbmdNYW5hZ2VyKTogUHJvbWlzZTx7IHVybDogc3RyaW5nLCBoYXNDaGFuZ2VkOiBib29sZWFuIH0+IHtcblxuICBzZXR0aW5ncy5jb25maWd1cmVQYW5lKHtcbiAgICBpZDogJ2RhdGFTeW5jJyxcbiAgICBsYWJlbDogXCJEYXRhIHN5bmNocm9uaXphdGlvblwiLFxuICAgIGljb246ICdnaXQtbWVyZ2UnLFxuICB9KTtcblxuICBzZXR0aW5ncy5yZWdpc3RlcihuZXcgU2V0dGluZzxzdHJpbmc+KFxuICAgICdnaXRSZXBvVXJsJyxcbiAgICBcIkdpdCByZXBvc2l0b3J5IFVSTFwiLFxuICAgICdkYXRhU3luYycsXG4gICkpO1xuXG4gIGNvbnN0IHJlcG9Vcmw6IHN0cmluZyA9IGF3YWl0IHNldHRpbmdzLmdldFZhbHVlKCdnaXRSZXBvVXJsJykgYXMgc3RyaW5nO1xuXG4gIGlmIChyZXBvVXJsKSB7XG4gICAgbG9nLndhcm4oXCJTU0U6IEdpdENvbnRyb2xsZXI6IFJlcG8gVVJMIGZvdW5kIGluIHNldHRpbmdzLCBza2lwIGNvbmZpZyB3aW5kb3dcIik7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHVybDogcmVwb1VybCwgaGFzQ2hhbmdlZDogZmFsc2UgfSk7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPHsgdXJsOiBzdHJpbmcsIGhhc0NoYW5nZWQ6IGJvb2xlYW4gfT4oYXN5bmMgKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgbG9nLndhcm4oXCJTU0U6IEdpdENvbnRyb2xsZXI6IFJlcG8gVVJMIG5vdCBzZXQsIG9wZW4gaW5pdGlhbCBjb25maWcgd2luZG93IHRvIGxldCB1c2VyIGNvbmZpZ3VyZVwiKTtcblxuICAgICAgYXdhaXQgb3BlbldpbmRvdyhjb25maWdXaW5kb3cpO1xuICAgICAgaXBjTWFpbi5vbignc2V0LXNldHRpbmcnLCBoYW5kbGVTZXR0aW5nKTtcblxuICAgICAgZnVuY3Rpb24gaGFuZGxlU2V0dGluZyhldnQ6IGFueSwgbmFtZTogc3RyaW5nLCB2YWx1ZTogc3RyaW5nKSB7XG4gICAgICAgIGlmIChuYW1lID09PSAnZ2l0UmVwb1VybCcpIHtcbiAgICAgICAgICBsb2cud2FybihcIlNTRTogR2l0Q29udHJvbGxlcjogcmVjZWl2ZWQgZ2l0UmVwb1VybCBzZXR0aW5nXCIpO1xuICAgICAgICAgIGlwY01haW4ucmVtb3ZlTGlzdGVuZXIoJ3NldC1zZXR0aW5nJywgaGFuZGxlU2V0dGluZyk7XG4gICAgICAgICAgcmVzb2x2ZSh7IHVybDogdmFsdWUsIGhhc0NoYW5nZWQ6IHRydWUgfSk7XG4gICAgICAgIH1cbiAgICAgICAgZXZ0LnJlcGx5KCdvaycpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG59XG4iXX0=