import * as fs from 'fs-extra';
import * as log from 'electron-log';
import { ipcMain } from 'electron';
import { YAMLStorage } from '../storage/main/yaml';
export class Setting {
    constructor(id, label, paneId) {
        this.id = id;
        this.label = label;
        this.paneId = paneId;
    }
    toUseable(val) { return val; }
    ;
    toStoreable(val) { return val; }
    ;
}
export class SettingManager {
    constructor(settingsPath) {
        this.settingsPath = settingsPath;
        this.registry = [];
        this.panes = [];
        this.data = null;
        log.debug(`SSE: Settings: Configuring settings with path ${settingsPath}`);
        this.yaml = new YAMLStorage(fs);
    }
    async getValue(id) {
        const setting = this.get(id);
        if (setting) {
            if (this.data === null) {
                let settingsFileExists;
                try {
                    settingsFileExists = (await fs.stat(this.settingsPath)).isFile();
                }
                catch (e) {
                    settingsFileExists = false;
                }
                if (settingsFileExists) {
                    this.data = (await this.yaml.load(this.settingsPath)) || {};
                }
                else {
                    this.data = {};
                }
            }
            const rawVal = this.data[id];
            return rawVal !== undefined ? setting.toUseable(rawVal) : undefined;
        }
        else {
            log.warn(`SSE: Settings: Attempted to get value for non-existent setting ${id}`);
            throw new Error(`Setting to get value for is not found: ${id}`);
        }
    }
    async setValue(id, val) {
        // DANGER: Never log settingâ€™s val in raw form
        log.debug(`SSE: Settings: Set value for setting ${id}`);
        const setting = this.get(id);
        if (setting) {
            const storeable = setting.toStoreable(val);
            this.data[id] = storeable;
            await this.commit();
        }
        else {
            throw new Error(`Setting to set value for is not found: ${id}`);
        }
    }
    async deleteValue(id) {
        log.debug(`SSE: Settings: Delete setting: ${id}`);
        delete this.data[id];
        await this.commit();
    }
    async commit() {
        log.info("SSE: Settings: Commit new settings");
        log.debug("SSE: Settings: Commit: Remove file");
        await fs.remove(this.settingsPath);
        log.debug("SSE: Settings: Commit: Write new file");
        await this.yaml.store(this.settingsPath, this.data);
    }
    get(id) {
        return this.registry.find(s => s.id === id);
    }
    register(setting) {
        log.debug("SSE: Settings: Register setting");
        if (this.panes.find(p => p.id === setting.paneId)) {
            this.registry.push(setting);
        }
        else {
            throw new Error("Invalid pane ID");
        }
    }
    configurePane(pane) {
        this.panes.push(pane);
    }
    setUpAPIEndpoints() {
        log.verbose("SSE: Settings: Configure API endpoints");
        ipcMain.on('set-setting', (evt, name, value) => {
            return this.setValue(name, value);
        });
        ipcMain.on('get-setting', (evt, name) => {
            const value = this.getValue(name);
            evt.reply(value);
        });
        ipcMain.on('clear-setting', async (evt, name) => {
            log.debug(`SSE: Settings: received clear-setting request for ${name}`);
            await this.deleteValue(name);
            evt.reply('ok');
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXR0aW5ncy9tYWluLnRzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEtBQUssRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUMvQixPQUFPLEtBQUssR0FBRyxNQUFNLGNBQWMsQ0FBQztBQUVwQyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBRW5DLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQVVuRCxNQUFNLE9BQU8sT0FBTztJQUNsQixZQUNTLEVBQVUsRUFDVixLQUFhLEVBQ2IsTUFBYztRQUZkLE9BQUUsR0FBRixFQUFFLENBQVE7UUFDVixVQUFLLEdBQUwsS0FBSyxDQUFRO1FBQ2IsV0FBTSxHQUFOLE1BQU0sQ0FBUTtJQUFHLENBQUM7SUFDM0IsU0FBUyxDQUFDLEdBQVksSUFBTyxPQUFPLEdBQVEsQ0FBQSxDQUFDLENBQUM7SUFBQSxDQUFDO0lBQy9DLFdBQVcsQ0FBQyxHQUFNLElBQVMsT0FBTyxHQUFVLENBQUEsQ0FBQyxDQUFDO0lBQUEsQ0FBQztDQUNoRDtBQUdELE1BQU0sT0FBTyxjQUFjO0lBTXpCLFlBQW1CLFlBQW9CO1FBQXBCLGlCQUFZLEdBQVosWUFBWSxDQUFRO1FBTC9CLGFBQVEsR0FBbUIsRUFBRSxDQUFDO1FBQzlCLFVBQUssR0FBVyxFQUFFLENBQUM7UUFDbkIsU0FBSSxHQUFlLElBQUksQ0FBQztRQUk5QixHQUFHLENBQUMsS0FBSyxDQUFDLGlEQUFpRCxZQUFZLEVBQUUsQ0FBQyxDQUFDO1FBQzNFLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxXQUFXLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDbEMsQ0FBQztJQUVNLEtBQUssQ0FBQyxRQUFRLENBQUMsRUFBVTtRQUM5QixNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBRTdCLElBQUksT0FB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LENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMtZXh0cmEnO1xuaW1wb3J0ICogYXMgbG9nIGZyb20gJ2VsZWN0cm9uLWxvZyc7XG5cbmltcG9ydCB7IGlwY01haW4gfSBmcm9tICdlbGVjdHJvbic7XG5cbmltcG9ydCB7IFlBTUxTdG9yYWdlIH0gZnJvbSAnLi4vc3RvcmFnZS9tYWluL3lhbWwnO1xuXG5cbmV4cG9ydCBpbnRlcmZhY2UgUGFuZSB7XG4gIGlkOiBzdHJpbmc7XG4gIGxhYmVsOiBzdHJpbmc7XG4gIGljb24/OiBzdHJpbmc7XG59XG5cblxuZXhwb3J0IGNsYXNzIFNldHRpbmc8VD4ge1xuICBjb25zdHJ1Y3RvcihcbiAgICBwdWJsaWMgaWQ6IHN0cmluZyxcbiAgICBwdWJsaWMgbGFiZWw6IHN0cmluZyxcbiAgICBwdWJsaWMgcGFuZUlkOiBzdHJpbmcpIHt9XG4gIHRvVXNlYWJsZSh2YWw6IHVua25vd24pOiBUIHsgcmV0dXJuIHZhbCBhcyBUIH07XG4gIHRvU3RvcmVhYmxlKHZhbDogVCk6IGFueSB7IHJldHVybiB2YWwgYXMgYW55IH07XG59XG5cblxuZXhwb3J0IGNsYXNzIFNldHRpbmdNYW5hZ2VyIHtcbiAgcHJpdmF0ZSByZWdpc3RyeTogU2V0dGluZzxhbnk+W10gPSBbXTtcbiAgcHJpdmF0ZSBwYW5lczogUGFuZVtdID0gW107XG4gIHByaXZhdGUgZGF0YTogYW55IHwgbnVsbCA9IG51bGw7XG4gIHByaXZhdGUgeWFtbDogWUFNTFN0b3JhZ2U7XG5cbiAgY29uc3RydWN0b3IocHVibGljIHNldHRpbmdzUGF0aDogc3RyaW5nKSB7XG4gICAgbG9nLmRlYnVnKGBTU0U6IFNldHRpbmdzOiBDb25maWd1cmluZyBzZXR0aW5ncyB3aXRoIHBhdGggJHtzZXR0aW5nc1BhdGh9YCk7XG4gICAgdGhpcy55YW1sID0gbmV3IFlBTUxTdG9yYWdlKGZzKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBnZXRWYWx1ZShpZDogc3RyaW5nKTogUHJvbWlzZTx1bmtub3duPiB7XG4gICAgY29uc3Qgc2V0dGluZyA9IHRoaXMuZ2V0KGlkKTtcblxuICAgIGlmIChzZXR0aW5nKSB7XG4gICAgICBpZiAodGhpcy5kYXRhID09PSBudWxsKSB7XG4gICAgICAgIGxldCBzZXR0aW5nc0ZpbGVFeGlzdHM6IGJvb2xlYW47XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgc2V0dGluZ3NGaWxlRXhpc3RzID0gKGF3YWl0IGZzLnN0YXQodGhpcy5zZXR0aW5nc1BhdGgpKS5pc0ZpbGUoKTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgIHNldHRpbmdzRmlsZUV4aXN0cyA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIGlmIChzZXR0aW5nc0ZpbGVFeGlzdHMpIHtcbiAgICAgICAgICB0aGlzLmRhdGEgPSAoYXdhaXQgdGhpcy55YW1sLmxvYWQodGhpcy5zZXR0aW5nc1BhdGgpKSB8fCB7fTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLmRhdGEgPSB7fTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgY29uc3QgcmF3VmFsID0gdGhpcy5kYXRhW2lkXTtcbiAgICAgIHJldHVybiByYXdWYWwgIT09IHVuZGVmaW5lZCA/IHNldHRpbmcudG9Vc2VhYmxlKHJhd1ZhbCkgOiB1bmRlZmluZWQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZy53YXJuKGBTU0U6IFNldHRpbmdzOiBBdHRlbXB0ZWQgdG8gZ2V0IHZhbHVlIGZvciBub24tZXhpc3RlbnQgc2V0dGluZyAke2lkfWApO1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBTZXR0aW5nIHRvIGdldCB2YWx1ZSBmb3IgaXMgbm90IGZvdW5kOiAke2lkfWApO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBzZXRWYWx1ZShpZDogc3RyaW5nLCB2YWw6IHVua25vd24pIHtcbiAgICAvLyBEQU5HRVI6IE5ldmVyIGxvZyBzZXR0aW5n4oCZcyB2YWwgaW4gcmF3IGZvcm1cblxuICAgIGxvZy5kZWJ1ZyhgU1NFOiBTZXR0aW5nczogU2V0IHZhbHVlIGZvciBzZXR0aW5nICR7aWR9YCk7XG5cbiAgICBjb25zdCBzZXR0aW5nID0gdGhpcy5nZXQoaWQpO1xuICAgIGlmIChzZXR0aW5nKSB7XG4gICAgICBjb25zdCBzdG9yZWFibGUgPSBzZXR0aW5nLnRvU3RvcmVhYmxlKHZhbCk7XG4gICAgICB0aGlzLmRhdGFbaWRdID0gc3RvcmVhYmxlO1xuICAgICAgYXdhaXQgdGhpcy5jb21taXQoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBTZXR0aW5nIHRvIHNldCB2YWx1ZSBmb3IgaXMgbm90IGZvdW5kOiAke2lkfWApO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBkZWxldGVWYWx1ZShpZDogc3RyaW5nKSB7XG4gICAgbG9nLmRlYnVnKGBTU0U6IFNldHRpbmdzOiBEZWxldGUgc2V0dGluZzogJHtpZH1gKTtcbiAgICBkZWxldGUgdGhpcy5kYXRhW2lkXTtcbiAgICBhd2FpdCB0aGlzLmNvbW1pdCgpO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBjb21taXQoKSB7XG4gICAgbG9nLmluZm8oXCJTU0U6IFNldHRpbmdzOiBDb21taXQgbmV3IHNldHRpbmdzXCIpO1xuICAgIGxvZy5kZWJ1ZyhcIlNTRTogU2V0dGluZ3M6IENvbW1pdDogUmVtb3ZlIGZpbGVcIik7XG4gICAgYXdhaXQgZnMucmVtb3ZlKHRoaXMuc2V0dGluZ3NQYXRoKTtcbiAgICBsb2cuZGVidWcoXCJTU0U6IFNldHRpbmdzOiBDb21taXQ6IFdyaXRlIG5ldyBmaWxlXCIpO1xuICAgIGF3YWl0IHRoaXMueWFtbC5zdG9yZSh0aGlzLnNldHRpbmdzUGF0aCwgdGhpcy5kYXRhKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0KGlkOiBzdHJpbmcpOiBTZXR0aW5nPGFueT4gfCB1bmRlZmluZWQge1xuICAgIHJldHVybiB0aGlzLnJlZ2lzdHJ5LmZpbmQocyA9PiBzLmlkID09PSBpZCk7XG4gIH1cblxuICBwdWJsaWMgcmVnaXN0ZXIoc2V0dGluZzogU2V0dGluZzxhbnk+KSB7XG4gICAgbG9nLmRlYnVnKFwiU1NFOiBTZXR0aW5nczogUmVnaXN0ZXIgc2V0dGluZ1wiKTtcbiAgICBpZiAodGhpcy5wYW5lcy5maW5kKHAgPT4gcC5pZCA9PT0gc2V0dGluZy5wYW5lSWQpKSB7XG4gICAgICB0aGlzLnJlZ2lzdHJ5LnB1c2goc2V0dGluZyk7XG5cbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiSW52YWxpZCBwYW5lIElEXCIpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBjb25maWd1cmVQYW5lKHBhbmU6IFBhbmUpIHtcbiAgICB0aGlzLnBhbmVzLnB1c2gocGFuZSk7XG4gIH1cblxuICBwdWJsaWMgc2V0VXBBUElFbmRwb2ludHMoKSB7XG4gICAgbG9nLnZlcmJvc2UoXCJTU0U6IFNldHRpbmdzOiBDb25maWd1cmUgQVBJIGVuZHBvaW50c1wiKTtcblxuICAgIGlwY01haW4ub24oJ3NldC1zZXR0aW5nJywgKGV2dDogYW55LCBuYW1lOiBzdHJpbmcsIHZhbHVlOiBhbnkpID0+IHtcbiAgICAgIHJldHVybiB0aGlzLnNldFZhbHVlKG5hbWUsIHZhbHVlKTtcbiAgICB9KTtcblxuICAgIGlwY01haW4ub24oJ2dldC1zZXR0aW5nJywgKGV2dDogYW55LCBuYW1lOiBzdHJpbmcpID0+IHtcbiAgICAgIGNvbnN0IHZhbHVlID0gdGhpcy5nZXRWYWx1ZShuYW1lKTtcbiAgICAgIGV2dC5yZXBseSh2YWx1ZSk7XG4gICAgfSk7XG5cbiAgICBpcGNNYWluLm9uKCdjbGVhci1zZXR0aW5nJywgYXN5bmMgKGV2dDogYW55LCBuYW1lOiBzdHJpbmcpID0+IHtcbiAgICAgIGxvZy5kZWJ1ZyhgU1NFOiBTZXR0aW5nczogcmVjZWl2ZWQgY2xlYXItc2V0dGluZyByZXF1ZXN0IGZvciAke25hbWV9YCk7XG5cbiAgICAgIGF3YWl0IHRoaXMuZGVsZXRlVmFsdWUobmFtZSk7XG4gICAgICBldnQucmVwbHkoJ29rJyk7XG4gICAgfSk7XG4gIH1cbn1cbiJdfQ==